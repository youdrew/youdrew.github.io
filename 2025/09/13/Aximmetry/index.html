<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />

    <!--Description-->
    
        <meta name="description" content="Aximmetry 低成本XR方案折腾笔记项目背景我需要搭建出一套非常低成本的XR方案，调研的时候考虑国内一些自研方案，以及Hecoos等主流方案，测试期暂时使用Aximmetry作为演示方案。以下是Aximmetry在本次测试中所使用到的内容。
各版本之间的区别
Studio Edition（工作">
    

    <!--Author-->
    
        <meta name="author" content="Eugene Hsuan">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Aximmetry Learning Notes"/>
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Eugene&#39;s Page"/>

    <!--Page Cover-->
    
        <meta property="og:image" content=""/>
    

    <!-- Title -->
    
    <title>Aximmetry Learning Notes - Eugene&#39;s Page</title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/reset.css">

    
<link rel="stylesheet" href="/css/main.css">

    
<link rel="stylesheet" href="/css/table.css">

    
<link rel="stylesheet" href="/css/image-zoom.css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Mermaid Support -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.4.3/dist/mermaid.min.js"></script>

    <!-- Google Analytics -->
    


    <!--Favicon-->
    
        <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    

    
        <link rel="alternate" type="application/atom+xml" title="Eugene&#39;s Page" href="/atom.xml">
    
        <link rel="alternate" type="application/rss+xml" title="Eugene&#39;s Page" href="/rss.xml">
    

<meta name="generator" content="Hexo 7.3.0"></head>


<body class="layout-post path-2025-09-13-Aximmetry-">

<!-- Menu -->
<!-- Navigation -->
<header>
    <div class="logo">
        <a href="/">Eugene's Page</a>
        <div class="subtitle"></div>
        <div class="description"></div>
    </div><!-- end logo -->

    <div id="menu_icon"></div>
    <nav>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives">Archives</a>
            </li>
            
            <li>
                <a href="/about">About</a>
            </li>
            
        </ul>
    </nav><!-- end navigation menu -->

    <div class="footer clearfix">
        <ul class="social clearfix">
            
                <li><a href="https://space.bilibili.com/29291963" class="behance" target="_blank" data-title="Bilibili"></a></li>
            
            
                <li><a href="https://www.instagram.com/yu_chinghsuan?igsh=Mm54ajloc3c1NW5m&utm_source=qr" class="instagram" target="_blank" data-title="Instagram"></a></li>
            
            
                <li><a href="https://www.douban.com/people/Youdrew_Xuan/" class="dribble" target="_blank" data-title="Douban"></a></li>
            
            
                <li><a href="mailto:youdrewxuan@icloud.com" class="google" target="_blank" data-title="Email"></a></li>
            
            
                <li><a href="/rss.xml" class="rss" target="_blank" data-title="RSS"></a></li>
            
        </ul><!-- end social -->

        <div class="rights">
            <p>Copyright © 2025 Eugene Hsuan</p>
            <p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></p>
            <p>Modified based on <a href="https://github.com/klugjo/hexo-theme-magnetic" target="_blank">Magnetic</a> theme</p>
        </div><!-- end rights -->
    </div ><!-- end footer -->
</header><!-- end header -->


<!-- Main Content -->
<section class="main clearfix">

    <section class="top" style="background: url('https://s2.loli.net/2025/11/04/sCjGTwNf2xbSK5H.png');">
        <div class="wrapper content_header clearfix">
            

<div class="work_nav">

    <ul class="btn clearfix">
        
        <li><a href="/2025/09/21/UE5%20GAS%20Learning%20Notes/" class="previous" data-title="UE5 GAS Learning Notes"></a></li>
        
        <li><a href="/" class="grid" data-title="Portfolio"></a></li>
        
        <li><a href="/2025/08/01/Shader%20Learning%20Note/" class="next" data-title="Shader Learning N..."></a></li>
        
    </ul>

</div><!-- end work_nav -->
            <h1 class="title">Aximmetry Learning Notes</h1>
        </div>
    </section><!-- end top -->

    <section class="wrapper">
        <div class="content">

            <!-- Gallery -->
            

            <!-- Content -->
            <h1 id="Aximmetry-低成本XR方案折腾笔记"><a href="#Aximmetry-低成本XR方案折腾笔记" class="headerlink" title="Aximmetry 低成本XR方案折腾笔记"></a>Aximmetry 低成本XR方案折腾笔记</h1><h2 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h2><p>我需要搭建出一套非常低成本的XR方案，调研的时候考虑国内一些自研方案，以及Hecoos等主流方案，测试期暂时使用Aximmetry作为演示方案。以下是Aximmetry在本次测试中所使用到的内容。</p>
<h3 id="各版本之间的区别"><a href="#各版本之间的区别" class="headerlink" title="各版本之间的区别"></a>各版本之间的区别</h3><ol>
<li><strong>Studio Edition</strong>（工作室版）：适合非常小的或家庭工作室，如 YouTube 创作者等。该版本可通过 HDMI 或 USB 采集设备在一台 PC 上使用多个摄像头，可通过显卡的 HDMI&#x2F;DP&#x2F;DVI 端口生成一个或多个视频输出，还可直接将输出流式传输到 YouTube、Facebook、Twitch 或任何基于 RTMP 的视频服务。带水印的 Studio 版本可无限期用于非商业用途，也可通过订阅计划去除水印。</li>
<li><strong>Professional Edition</strong>（专业版）：适用于小型专业工作室，支持在一台 PC 上最多使用 4 个 SDI&#x2F;ndi 输入 &#x2F; 输出端口，如 3 个 SDI 摄像机输入和 1 个 SDI 复合输出，且不需要任何摄像机跟踪解决方案，仅使用固定摄像机与虚拟摄像机运动。</li>
<li><strong>Broadcast Edition</strong>（广播版）：适用于需要摄像机跟踪功能的专业工作室，可在一台 PC 上设置无限数量的 SDI&#x2F;ndi 输入 &#x2F; 输出端口（仅受硬件性能限制），也可在多 PC 配置中使用。此外，广播版还具备先进的混合现实解决方案，支持多摄像机跟踪、行业标准的色度键控器、高质量实时图形、摄像机偏移和镜头畸变的自动校准等功能。</li>
</ol>
<h2 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h2><h3 id="使用环境的基本内容"><a href="#使用环境的基本内容" class="headerlink" title="使用环境的基本内容"></a>使用环境的基本内容</h3><table>
<thead>
<tr>
<th align="center">软件名字</th>
<th align="center">版本</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Aximmetry Composer</td>
<td align="center"><img src="https://s2.loli.net/2025/10/10/lEkaSNv1s2z4dqC.png" alt="image-20251009155943445" style="zoom: 20%;" /></td>
<td align="left">这个软件是主要用来做合成和接收跟踪内容的</td>
</tr>
<tr>
<td align="center">Aximmetry UE</td>
<td align="center"><img src="https://s2.loli.net/2025/10/10/KUfiXBt4mxwEL8Z.png" alt="image-20251009160407488" style="zoom:20%;" /></td>
<td align="left">Aximmetry自己改的UE，他们有修改渲染管线（目测是为了加水印）。他们该版本的引擎是基于UE5.5进行修改的。可以看到在引擎的插件目录里有两个插件。有源码也没有引入外部的库。但是Aximmetry修改了渲染管线，猜测是防止盗版。</td>
</tr>
<tr>
<td align="center">UE工程</td>
<td align="center">5.5</td>
<td align="left">一个使用Aximmetry UE制作的场景。建议创建一个5.5的原始的UE工程，方便将插件重新编译及测试插件。</td>
</tr>
</tbody></table>
<h3 id="建立基本的工程"><a href="#建立基本的工程" class="headerlink" title="建立基本的工程"></a>建立基本的工程</h3><h4 id="进入工程的设置"><a href="#进入工程的设置" class="headerlink" title="进入工程的设置"></a>进入工程的设置</h4><div align="center"><img src="https://s2.loli.net/2025/10/10/knatfO9CcYjvASd.png" alt="image-20251009155003718" style="zoom: 20%;" /></div>

<p>在Composer的开始设置中，主要考虑输入的内容（左边的输入设置），这个是实景的拍摄相机。输出视频的大小（右边的输出设置），这个是最终输出画面的设置。以及下面的UE渲染设置。</p>
<h4 id="节点设置"><a href="#节点设置" class="headerlink" title="节点设置"></a>节点设置</h4><div align="center"><img src="https://s2.loli.net/2025/10/10/T4rdGiu85asXlDe.png" alt="image-20251009161750537" style="zoom: 20%;" /></div>

<ol>
<li>VirtualCam节点：工程里添加一个镜头，如图连线。</li>
<li>主节点：里面添加镜头和工程，并使用Live模式。</li>
<li>Green：添加测试用到视频素材，这里可以使用一个绿幕素材，Aximmetry会自动对其进行抠像。</li>
<li>Camera Tracking：相机追踪节点，这里面的选项待会儿要<u>填写上AximmetryEye</u></li>
</ol>
<p>完成之后点击Composer上面的Play按钮，且让工程在编辑器状态下运行起来，就会有合成的画面了。</p>
<h4 id="设置UE内容"><a href="#设置UE内容" class="headerlink" title="设置UE内容"></a>设置UE内容</h4><div align="center"><img src="https://s2.loli.net/2025/10/27/7NWYjuvm6zro2ng.png" alt="image-20251011142232445" style="zoom: 20%;" /></div>

<p>在场景中添加相机。</p>
<h3 id="设置相机运镜"><a href="#设置相机运镜" class="headerlink" title="设置相机运镜"></a>设置相机运镜</h3><h4 id="手动设置"><a href="#手动设置" class="headerlink" title="手动设置"></a>手动设置</h4><div align="center"><img src="https://s2.loli.net/2025/10/10/PUwAjTpJatG6O9s.png" alt="image-20250930144118468" style="zoom: 20%;" /></div>

<p>在这里可以用来设置相机的运动属性等信息。A和B代表着起始点和最终点。点击最左边的按钮可以让相机运动起来。</p>
<p>点击“摄影机&#x2F;渲染设置”的编辑操作，可以在Aximmetry的渲染出来的窗口画面里，直接拖动相机位置。使用↑↓←→按钮调整相机坐标。</p>
<h4 id="Iphone相机跟踪"><a href="#Iphone相机跟踪" class="headerlink" title="Iphone相机跟踪"></a>Iphone相机跟踪</h4><div align="center"><img src="https://s2.loli.net/2025/10/27/radVntHOELqgh2b.png" alt="image-20251013114229527" style="zoom: 20%;" /> <img src="https://s2.loli.net/2025/10/27/DR1TGPCjvgM3nqu.png" alt="image-20251013114601929" style="zoom: 20%;" /></div>

<p>在AppStore（IOS）下载Aximmetry Eye这个软件。然后通过网线<strong>有线连接</strong>（重点，无线我测试有问题），最好套上一个散热器（不然，一会儿手机就烫得不行然后断连了，然后数据飘逸了）。然后在连接的时候，选择发送Tracking Data（如图）即可（因为实际上我们只需要摄影机姿态数据）。连接完成之后，就可以在Flow页面Camera Tracking的节点细节面板里面看到手机这个选项了。</p>
<div align="center"><img src="https://s2.loli.net/2025/10/27/Vc49YvN7KrCqOuP.png" alt="image-20251013203732954" style="zoom: 20%;" /></div>

<p><u>每次初始化的时候Iphone所在的位置以及轴向</u>，就会被当作场景的中心点。</p>
<ul>
<li>请参看参考资料，部分有视频。</li>
</ul>
<h4 id="相机的FOV设定"><a href="#相机的FOV设定" class="headerlink" title="相机的FOV设定"></a>相机的FOV设定</h4><div align="center"><img src="https://s2.loli.net/2025/10/27/iSkpaB3lJKqGV2f.png" alt="image-20251013202543178" style="zoom: 20%;" /></div>

<p>FOV也可以进行手动标定，一般相机上的镜头标尺不是很准。<br>所以需要一些精确的标定。<br>可以在合成画面中，左右&#x2F;上下横移：如果虚拟旋转速度比真实的快，那么需要减小Zoom、反之亦然。</p>
<h4 id="Iphone外参手动标定"><a href="#Iphone外参手动标定" class="headerlink" title="Iphone外参手动标定"></a>Iphone外参手动标定</h4><div align="center"><img src="https://s2.loli.net/2025/10/27/X8FjOHlqyeSdKvx.png" alt="image-20251027113433462" style="zoom: 20%;" /></div>

<p>首先在相机的上方增加增加一个Actor物体，命名为CameraLocation。</p>
<p>Aximmetry的逻辑是 相机生成在原点 然后+-手机Aximmetry Eye上的偏移值，就是相机在运行时候的位置。</p>
<p>所以需要在CameraLocation，修改其位置，至实际上物理相机距离中心原点的位置。</p>
<h3 id="相机的标定"><a href="#相机的标定" class="headerlink" title="相机的标定"></a>相机的标定</h3><h4 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h4><p>相机标定的概念包括两部分：镜头标定和跟踪标定。</p>
<h6 id="镜头校准的概念"><a href="#镜头校准的概念" class="headerlink" title="镜头校准的概念"></a>镜头校准的概念</h6><p><strong>镜头校准</strong>的概念是，演播室摄像机镜头的固有特性（ <em>例如镜头畸变、中心偏移等</em> ）始终会导致图像及其色彩失真，而虚拟摄像机（ <em>演播室摄像机的虚拟对应物</em> ）默认会呈现完美图像（ <em>图像和&#x2F;或色彩均无畸变</em> ）。镜头校准的目标是将二者（演播室摄像机镜头与虚拟摄影机）统一在一起。（畸变校准）</p>
<h6 id="跟踪校准的概念"><a href="#跟踪校准的概念" class="headerlink" title="跟踪校准的概念"></a>跟踪校准的概念</h6><p>跟踪校准的概念是，跟踪系统只能测量其跟踪设备的位置和旋转，而虚拟制作需要演播室摄像机无视差点（ <em>靠近摄像机传感器</em> ）的位置和旋转。跟踪校准的目标是计算这两个位置和旋转之间的差异。</p>
<h4 id="工具介绍"><a href="#工具介绍" class="headerlink" title="工具介绍"></a>工具介绍</h4><p><a target="_blank" rel="noopener" href="https://aximmetry.com/learn/virtual-production-workflow/tracking/calibration/about-the-concept-of-camera-calibration/">官网对于标定内容的总结</a>里面提及了Aximmetry有两个标定工具：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Lb2BuzxM4h0">Basic Calibrator</a>和Camera Calibrator，在软件路径下可以看到这两个工具。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://aximmetry.com/learn/virtual-production-workflow/tracking/calibration/basic-calibrator/">Basic Calibrator</a> 手动校准相机或调整现有的校准配置文件。</li>
<li><a target="_blank" rel="noopener" href="https://aximmetry.com/learn/virtual-production-workflow/tracking/calibration/camera-calibrator/">Camera Calibrator</a> 自动校准相机。</li>
</ul>
<div align="center"><img src="https://s2.loli.net/2025/10/10/kstDo52JFy1ATgE.png" alt="image-20251009165746851" style="zoom: 20%;" /> <img src="https://s2.loli.net/2025/10/10/gc4PLZmDqfJalM2.png" alt="image-20251009165932446" style="zoom: 20%;" /></div>



<h5 id="Basic-Calibrator"><a href="#Basic-Calibrator" class="headerlink" title="Basic Calibrator"></a>Basic Calibrator</h5><p>Basic Calibrator 是 Aximmetry 提供的手动相机校准工具，用于调整相机的内外参数，确保虚拟场景与真实摄像机的透视和运动保持一致。</p>
<p><strong>官方教程</strong>：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Lb2BuzxM4h0">Aximmetry Basic Calibrator Tutorial</a></p>
<h6 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h6><ul>
<li><strong>Z（Zoom）</strong>：表示最小放大值，即镜头的变焦参数</li>
<li><strong>F（Focus）</strong>：代表镜头的对焦距离</li>
</ul>
<h6 id="校准步骤"><a href="#校准步骤" class="headerlink" title="校准步骤"></a>校准步骤</h6><p><strong>1. 配置相机属性（Properties）</strong></p>
<p>首先需要在 Basic Calibrator 中设置相机的基本参数：</p>
<ul>
<li><strong>传感器尺寸（Sensor Size）</strong>：输入摄像机传感器的物理尺寸<ul>
<li>示例：索尼 FX3 的传感器尺寸为 35.6 x 23.8 mm</li>
</ul>
</li>
<li><strong>相机高度（Camera Height）</strong>：测量并输入相机距离地面的实际高度<ul>
<li>这个参数对于跟踪校准非常重要</li>
</ul>
</li>
</ul>
<p><strong>2. 设置虚拟地平面</strong></p>
<ul>
<li><strong>Pan Virtual</strong>：设置虚拟场景中地平面的高度</li>
<li>确保虚拟地平面与真实地面对齐，这是后续校准的基准</li>
</ul>
<p><strong>3. 添加校准点（Calibration Points）</strong></p>
<ul>
<li>点击 <strong>Add</strong> 按钮添加校准点</li>
<li><strong>建议使用 5 个以上的校准点</strong>，以获得更准确的校准结果</li>
<li><strong>注意事项</strong>：<ul>
<li>不要在画面边缘位置添加校准点，因为镜头边缘的畸变较大</li>
<li>校准点应均匀分布在画面的中心区域</li>
<li>选择画面中清晰可辨的参考点（如地面标记、墙角等）</li>
</ul>
</li>
</ul>
<p><strong>4. 调整焦距（Focal Length）</strong></p>
<p>这是校准的核心步骤，需要通过观察虚拟网格与真实场景的匹配程度来调整：</p>
<ul>
<li><strong>判断标准</strong>：横向或纵向平移相机，观察虚拟网格与地面标记的相对运动速度<ul>
<li>如果<strong>虚拟网格旋转速度比真实标记快</strong>：需要<strong>增加 Focal Length</strong> 值</li>
<li>如果<strong>虚拟网格旋转速度比真实标记慢</strong>：需要<strong>减小 Focal Length</strong> 值</li>
</ul>
</li>
<li><strong>调整方法</strong>：<ul>
<li>逐步微调 Focal Length 参数</li>
<li>重复测试相机移动，直到虚拟网格与真实场景完美同步</li>
</ul>
</li>
</ul>
<p><strong>5. 验证校准结果</strong></p>
<ul>
<li>在不同位置和角度测试相机运动</li>
<li>确保虚拟场景与真实场景在各个方向上都能保持一致</li>
<li>如果发现偏差，可以添加更多校准点或重新调整参数</li>
</ul>
<h6 id="校准技巧"><a href="#校准技巧" class="headerlink" title="校准技巧"></a>校准技巧</h6><ul>
<li>使用稳定的三脚架或云台，避免相机抖动影响校准精度</li>
<li>在光线充足的环境下进行校准，确保参考点清晰可见</li>
<li>定期重新校准，特别是在更换镜头或调整焦距后</li>
<li>保存校准配置文件，方便后续使用</li>
</ul>
<h6 id="支持的跟踪系统类型"><a href="#支持的跟踪系统类型" class="headerlink" title="支持的跟踪系统类型"></a>支持的跟踪系统类型</h6><p>Basic Calibrator 目前支持两种类型的跟踪系统校准：</p>
<div align="center"><img src="https://s2.loli.net/2025/10/10/7eXmrFl6TStBQ8V.png" alt="image-20251009170158715" style="zoom: 20%;" /></div>

<ul>
<li><p><strong>6DOF（6 自由度跟踪系统）</strong></p>
<ul>
<li><strong>定义</strong>：能够同时获取摄像机在三维空间中的位置（X、Y、Z）和旋转（Pitch俯仰、Yaw偏航、Roll翻滚）数据</li>
<li><strong>特点</strong>：实现摄像机的完整空间运动追踪</li>
<li><strong>应用场景</strong>：高精度虚拟制作和混合现实场景</li>
<li><strong>典型设备</strong>：来自外部的专业跟踪系统（如 OptiTrack、Vicon 等）</li>
</ul>
</li>
<li><p><strong>PTZ（Pan-Tilt-Zoom）</strong></p>
<ul>
<li><strong>定义</strong>：具备云台（水平旋转）、俯仰（垂直旋转）和变焦功能的摄像机</li>
<li><strong>特点</strong>：不具备完整的空间位置追踪能力，主要追踪旋转和变焦参数</li>
<li><strong>应用场景</strong>：场景监控或简单虚拟制作</li>
<li><strong>典型设备</strong>：PTZ 摄像机系统</li>
</ul>
</li>
</ul>
<h6 id="设备配置示例"><a href="#设备配置示例" class="headerlink" title="设备配置示例"></a>设备配置示例</h6><p><strong>在设备映射器中添加 Aximmetry Eye：</strong></p>
<div align="center"><img src="https://s2.loli.net/2025/10/10/xMOXDgvkuVticse.png" alt="image-20250930155931126" style="zoom: 20%;" /></div>

<div align="center"><img src="https://s2.loli.net/2025/10/10/LM2ldp7bxyBaIYR.png" alt="image-20250930164348165" style="zoom: 20%;" /></div>

<p><strong>重要提示</strong>：使用 Aximmetry Eye 时，一定要通过<strong>网线有线连接</strong>才能获得稳定的跟踪数据。无线连接可能导致数据延迟或连接不稳定。</p>
<h2 id="其他思考"><a href="#其他思考" class="headerlink" title="其他思考"></a>其他思考</h2><h5 id="关于Iphone同步问题"><a href="#关于Iphone同步问题" class="headerlink" title="关于Iphone同步问题"></a>关于Iphone同步问题</h5><p>因为Iphone在之前的版本中并不支持时间吗和Genlock，所以在同步上就会有很多问题。</p>
<p>论坛里提及了<a target="_blank" rel="noopener" href="https://my.aximmetry.com/post/3885-aximmetry-eye-as-a-tracker-for-a-studio">这个问题</a>。是否可以使用iphone17支持了GenLock是否可以直接拿来使用作为外部跟踪器。</p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=jjsrc01caGQ">Youtube里面提到的Blackmgiac为Iphone制作的外部同步设备</a></p>
<h2 id="使用时候的问题"><a href="#使用时候的问题" class="headerlink" title="使用时候的问题"></a>使用时候的问题</h2><h3 id="引擎版本不兼容问题"><a href="#引擎版本不兼容问题" class="headerlink" title="引擎版本不兼容问题"></a>引擎版本不兼容问题</h3><p>官网也提到了这个<a target="_blank" rel="noopener" href="https://aximmetry.com/learn/virtual-production-workflow/obtaining-graphics-and-virtual-assets/creating-content-in-unreal-editor/advanced-information-and-features/how-to-install-third-party-code-plugins-for-unreal-editor-for-aximmetry/">问题</a>，这会涉及到一些别的插件的重新编译、兼容性的问题。</p>
<p>Aximmetry 的 UE 版本不是官方完整源码版，因此想要重新编译复杂 C++ 插件（特别是依赖私有模块或渲染管线扩展的）往往会失败。</p>
<p>可以：</p>
<ol>
<li>使用蓝图或纯资源插件；</li>
<li>寻找已为该版本预编译的二进制包；</li>
<li>如果必须用 C++ 插件，尝试在官方 UE5.5 建工程验证，确认可以跑通，然后再到Aximmetry的引擎中去跑。</li>
</ol>
<h3 id="采集卡格式不兼容问题"><a href="#采集卡格式不兼容问题" class="headerlink" title="采集卡格式不兼容问题"></a>采集卡格式不兼容问题</h3><p> 在项目设置上会出现采集卡识别不到型号&#x2F;分辨率等问题，或是采集卡断掉之后，画面呈现黑的。<br>这时候需要拔掉插件卡重新插入，然后重启软件。</p>
<h2 id="自己写一个XR软件"><a href="#自己写一个XR软件" class="headerlink" title="自己写一个XR软件"></a>自己写一个XR软件</h2><p>我们有自研的需求，考虑到Aximmetry的以“片的形式”放一个采集卡画面到场景中的实现逻辑较为简单，所以在这里手搓一个XR软件，用于给后面的大软件进行操作逻辑整理，我设想的是，这是一个编辑器下的工具，可以依托UE完成整个合成和渲染操作，而不是Aximmetry。</p>
<p>实现的功能比较简单：<br>主要实现：</p>
<ol>
<li>接入绿幕图像</li>
<li>绿幕一直朝向摄影机</li>
<li>相机的多机位切换及多机位运动</li>
<li>控制对应的屏幕全屏显示</li>
</ol>
<h3 id="接入绿幕图像"><a href="#接入绿幕图像" class="headerlink" title="接入绿幕图像"></a>接入绿幕图像</h3><div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/y1OqgboQ6aPUC2Y.png" alt="image-20251104155838931" style="zoom: 25%;" / width="50%" />
</div>

<p>新建一个场景，并新建MediaPlate到场景中。</p>
<p>导入绿幕视频（可以直接把UE支持的格式的视频拖拽到UE的编辑器面板里）并连接MediaPlate。</p>
<div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/BHVDa1MwzeqQ48v.png" alt="image-20251104160039501" style="zoom:25%;" / width="50%" />
</div>

<p>修改绿幕材质（直接把MediaPlate的材质复制出来一份到本地），并新增一个MF_ChromKeyer，并按照如图所示进行修改材质的节点，然后将复制出来的材质赋予MediaPlate。</p>
<div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/PZQh3SBgt4rVCk8.png" alt="image-20251104160012519" style="zoom:25%;" / width="50%" />
</div>

<p>修改子材质，对抠像的内容选择绿色的部分。保存，即可完成抠像，这里暂时使用一个临时的视频素材，正式使用的时候，这里可以使用一个采集卡接入的视频流。</p>
<div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/J3sL9ITyld1aU7N.png" alt="image-20251104160147691" style="zoom:25%;" / width="50%" />
</div>

<p>截止到这里，我们已经可以在场景中显示一个抠像的Plate了。</p>
<p>但是这样的Level无法保存下来。离开场景之后MediaPlate里面的素材会丢。</p>
<p>所以我们还要完善一下材质：</p>
<div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/oQZX4KiqvwxtS6g.png" alt="image-20251104165145468" style="zoom:25%;" / width="50%" />
</div>

<p>新建一个MediaPlayer，将里面播放的内容添加为刚刚导入的绿幕视频文件。</p>
<div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/H3TibIsC7qyrcxB.png" alt="image-20251104165246306" style="zoom:25%;" / width="50%" />
</div>

<p>新建一个MediaTexture，里面的媒体指定为刚刚新建的MediaPlayer。</p>
<div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/OfosrTMUuvA3eDB.png" alt="image-20251104165327820" style="zoom:25%;" / width="50%" />
</div>

<p>然后把MediaTexture拖动到MediaPlate的材质里面，并修改输入源。保存之后，MediaPlate就正常了。<br>至此，我们已经完成了绿幕接入这一项。</p>
<h3 id="绿幕一直朝向摄影机"><a href="#绿幕一直朝向摄影机" class="headerlink" title="绿幕一直朝向摄影机"></a>绿幕一直朝向摄影机</h3><p>但是我们会发现一个问题，当我们切换不同相机的视角的时候，所以需要设置相机的摄影机朝向。</p>
<div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/TxhUdEkNbzIm5VG.png" alt="image-20251104171602887" style="zoom:15%;" / width="50%" />
</div>

<div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/sCjGTwNf2xbSK5H.png" alt="image-20251104172150884" style="zoom:25%;" / width="50%" />
</div>

<p>否则就会出现这种明显的片的形式。</p>
<h3 id="相机的多机位切换及多机位运动"><a href="#相机的多机位切换及多机位运动" class="headerlink" title="相机的多机位切换及多机位运动"></a>相机的多机位切换及多机位运动</h3><p>因为我们是直接控制UE里的摄影机器，所以不管是在Play状态下还是在Editor状态下，都可以直接依靠UE的Sequence功能实现镜头的运动。但是切换并不能很好的实现。所以可以用我的软件实现快速的镜头切换。</p>
<div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/z2WNlO39Sgft6np.png" alt="image-20251104174529386" style="zoom:33%;" / width="50%" />
</div>

<p>在运行时，可以点击这个控制台，来操作相机进行切换。</p>
<h3 id="控制对应的屏幕全屏显示"><a href="#控制对应的屏幕全屏显示" class="headerlink" title="控制对应的屏幕全屏显示"></a>控制对应的屏幕全屏显示</h3><div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/9NtOGMbeDqkXQcn.png" alt="image-20251104174853388" width="50%" />
</div>

<p>选择需要把画面渲染到的屏幕，然后选择渲染分辨率，对画面进行全屏渲染。然后直播的时候，可以用OBS采集对应的窗口画面，进行直播。</p>
<p>于是我们就绕开了Aximmetry及其引擎，在UE中进行合成和渲染，并且也方便使用开源的UE及其周边子插件，而不是被Aximmetry的特殊版本引擎所限制。</p>
<p>当然这个插件目前还有很多问题。Just for Fun.如果要使用还要解决很多问题，比如标定等。</p>
<h2 id="所有源码"><a href="#所有源码" class="headerlink" title="所有源码"></a>所有源码</h2><h3 id="软件的整体结构"><a href="#软件的整体结构" class="headerlink" title="软件的整体结构"></a>软件的整体结构</h3><div style="text-align: center;">
<img src="https://s2.loli.net/2025/11/04/Gt92glkBQOUXjNF.png" alt="image-20251104180744538" width="50%" />
</div>

<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><h3 id="STcgXRViewport-cpp"><a href="#STcgXRViewport-cpp" class="headerlink" title="STcgXRViewport.cpp"></a>STcgXRViewport.cpp</h3><p><strong>文件路径</strong>: <code>Private\STcgXRViewport.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;STcgXRViewport.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRViewportClient.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;PreviewScene.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Editor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LevelEditor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Engine/World.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Engine/Level.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GameFramework/Actor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CineCameraActor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CineCameraComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LevelEditorViewport.h&quot;</span> <span class="comment">// FLevelEditorViewportClient</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXR.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造函数，初始化自定义Viewport</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::Construct</span><span class="params">(<span class="type">const</span> FArguments&amp; InArgs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SEditorViewport::<span class="built_in">Construct</span>(SEditorViewport::<span class="built_in">FArguments</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建自定义ViewportClient</span></span><br><span class="line"><span class="function">TSharedRef&lt;FEditorViewportClient&gt; <span class="title">STcgXRViewport::MakeEditorViewportClient</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!PreviewScene.<span class="built_in">IsValid</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        PreviewScene = <span class="built_in">MakeUnique</span>&lt;FPreviewScene&gt;(FPreviewScene::<span class="built_in">ConstructionValues</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ViewportClient = <span class="built_in">MakeShared</span>&lt;FTcgXRViewportClient&gt;(PreviewScene.<span class="built_in">Get</span>(), <span class="built_in">StaticCastSharedRef</span>&lt;SEditorViewport&gt;(<span class="built_in">SharedThis</span>(<span class="keyword">this</span>)));</span><br><span class="line">    ViewportClient-&gt;<span class="built_in">SetViewMode</span>(VMI_Lit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从第一个主编辑器视口复制相机参数</span></span><br><span class="line">    <span class="keyword">if</span> (GEditor)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (FEditorViewportClient* VC : GEditor-&gt;<span class="built_in">GetAllViewportClients</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (VC &amp;&amp; VC-&gt;<span class="built_in">IsPerspective</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">const</span> FVector Loc = VC-&gt;<span class="built_in">GetViewLocation</span>();</span><br><span class="line">                <span class="type">const</span> FRotator Rot = VC-&gt;<span class="built_in">GetViewRotation</span>();</span><br><span class="line">                <span class="type">const</span> <span class="type">bool</span> bIsOrtho = VC-&gt;<span class="built_in">IsOrtho</span>();</span><br><span class="line">                <span class="type">const</span> <span class="type">float</span> FOV = VC-&gt;ViewFOV; <span class="comment">// 使用源视口FOV</span></span><br><span class="line">                <span class="type">const</span> <span class="type">float</span> OrthoWidth = <span class="number">2048.f</span>; <span class="comment">// 默认正交宽度</span></span><br><span class="line">                ViewportClient-&gt;<span class="built_in">SetCameraFrom</span>(Loc, Rot, FOV, OrthoWidth, bIsOrtho);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 应用缓存参数（如果UI在Client创建前触发了设置，不会崩溃）</span></span><br><span class="line">    <span class="built_in">ApplyCachedParams</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ViewportClient.<span class="built_in">ToSharedRef</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::ApplyCachedParams</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ViewportClient.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (CachedFOV.<span class="built_in">IsSet</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFOV</span>(CachedFOV.<span class="built_in">GetValue</span>()); CachedFOV.<span class="built_in">Reset</span>(); &#125;</span><br><span class="line">    <span class="keyword">if</span> (CachedExposure.<span class="built_in">IsSet</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetExposure</span>(CachedExposure.<span class="built_in">GetValue</span>()); CachedExposure.<span class="built_in">Reset</span>(); &#125;</span><br><span class="line">    <span class="keyword">if</span> (CachedFocalLength.<span class="built_in">IsSet</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFocalLength</span>(CachedFocalLength.<span class="built_in">GetValue</span>()); CachedFocalLength.<span class="built_in">Reset</span>(); &#125;</span><br><span class="line">    <span class="keyword">if</span> (CachedAperture.<span class="built_in">IsSet</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetAperture</span>(CachedAperture.<span class="built_in">GetValue</span>()); CachedAperture.<span class="built_in">Reset</span>(); &#125;</span><br><span class="line">    <span class="keyword">if</span> (CachedFocusDistance.<span class="built_in">IsSet</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFocusDistance</span>(CachedFocusDistance.<span class="built_in">GetValue</span>()); CachedFocusDistance.<span class="built_in">Reset</span>(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XR状态控制接口</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetShowKeyed</span><span class="params">(<span class="type">bool</span> b)</span> </span>&#123; <span class="keyword">if</span> (ViewportClient) ViewportClient-&gt;<span class="built_in">SetShowKeyed</span>(b); &#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetVirtualCamMove</span><span class="params">(<span class="type">bool</span> b)</span> </span>&#123; <span class="keyword">if</span> (ViewportClient) ViewportClient-&gt;<span class="built_in">SetVirtualCamMove</span>(b); &#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetMixedRealityBlend</span><span class="params">(<span class="type">bool</span> b)</span> </span>&#123; <span class="keyword">if</span> (ViewportClient) ViewportClient-&gt;<span class="built_in">SetMixedRealityBlend</span>(b); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">STcgXRViewport::IsShowKeyed</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> ViewportClient ? ViewportClient-&gt;<span class="built_in">IsShowKeyed</span>() : <span class="literal">false</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">STcgXRViewport::IsVirtualCamMove</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> ViewportClient ? ViewportClient-&gt;<span class="built_in">IsVirtualCamMove</span>() : <span class="literal">false</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">STcgXRViewport::IsMixedRealityBlend</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> ViewportClient ? ViewportClient-&gt;<span class="built_in">IsMixedRealityBlend</span>() : <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工具：获取当前锁定的电影相机（如果任何一个关卡视口处于Pilot/锁定状态）</span></span><br><span class="line"><span class="function"><span class="type">static</span> UCineCameraComponent* <span class="title">GetLockedCineCamera</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!GEditor) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">const</span> TArray&lt;FLevelEditorViewportClient*&gt;&amp; Clients = GEditor-&gt;<span class="built_in">GetLevelViewportClients</span>();</span><br><span class="line">    <span class="keyword">for</span> (FLevelEditorViewportClient* LVC : Clients)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!LVC || !LVC-&gt;<span class="built_in">IsPerspective</span>()) <span class="keyword">continue</span>;</span><br><span class="line">        AActor* LockedActor = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">if</span> (AActor* CineLock = LVC-&gt;<span class="built_in">GetCinematicActorLock</span>().<span class="built_in">GetLockedActor</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            LockedActor = CineLock;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (LVC-&gt;<span class="built_in">GetActiveActorLock</span>().<span class="built_in">IsValid</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            LockedActor = LVC-&gt;<span class="built_in">GetActiveActorLock</span>().<span class="built_in">Get</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (LockedActor)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (ACineCameraActor* Cine = <span class="built_in">Cast</span>&lt;ACineCameraActor&gt;(LockedActor))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Cine-&gt;<span class="built_in">GetCineCameraComponent</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 捕获键盘输入并分发给模块做相机切换</span></span><br><span class="line"><span class="function">FReply <span class="title">STcgXRViewport::OnKeyDown</span><span class="params">(<span class="type">const</span> FGeometry&amp; MyGeometry, <span class="type">const</span> FKeyEvent&amp; InKeyEvent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (FTcgXRModule* Mod = FModuleManager::<span class="built_in">GetModulePtr</span>&lt;FTcgXRModule&gt;(<span class="string">&quot;TcgXR&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Mod-&gt;<span class="built_in">HandleKeyDown</span>(InKeyEvent.<span class="built_in">GetKey</span>()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> FReply::<span class="built_in">Handled</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SEditorViewport::<span class="built_in">OnKeyDown</span>(MyGeometry, InKeyEvent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全设置接口（优先修改锁定到关卡视口的相机，否则本地缓存/ViewportClient）</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetFOVParam</span><span class="params">(<span class="type">float</span> InFOV)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UCineCameraComponent* CineComp = <span class="built_in">GetLockedCineCamera</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        CineComp-&gt;<span class="built_in">SetFieldOfView</span>(InFOV);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ViewportClient.<span class="built_in">IsValid</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFOV</span>(InFOV); &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; CachedFOV = InFOV; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetExposureParam</span><span class="params">(<span class="type">float</span> InExposure)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UCineCameraComponent* CineComp = <span class="built_in">GetLockedCineCamera</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        FPostProcessSettings&amp; PPS = CineComp-&gt;PostProcessSettings;</span><br><span class="line">        PPS.bOverride_AutoExposureBias = <span class="literal">true</span>;</span><br><span class="line">        PPS.AutoExposureBias = InExposure;</span><br><span class="line">        CineComp-&gt;PostProcessBlendWeight = <span class="number">1.0f</span>;</span><br><span class="line">        CineComp-&gt;<span class="built_in">MarkRenderStateDirty</span>();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ViewportClient.<span class="built_in">IsValid</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetExposure</span>(InExposure); &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; CachedExposure = InExposure; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetFocalLengthParam</span><span class="params">(<span class="type">float</span> InFocal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UCineCameraComponent* CineComp = <span class="built_in">GetLockedCineCamera</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        CineComp-&gt;<span class="built_in">SetCurrentFocalLength</span>(InFocal);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ViewportClient.<span class="built_in">IsValid</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFocalLength</span>(InFocal); &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; CachedFocalLength = InFocal; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetApertureParam</span><span class="params">(<span class="type">float</span> InAperture)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UCineCameraComponent* CineComp = <span class="built_in">GetLockedCineCamera</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        CineComp-&gt;<span class="built_in">SetCurrentAperture</span>(InAperture);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ViewportClient.<span class="built_in">IsValid</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetAperture</span>(InAperture); &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; CachedAperture = InAperture; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetFocusDistanceParam</span><span class="params">(<span class="type">float</span> InFocus)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UCineCameraComponent* CineComp = <span class="built_in">GetLockedCineCamera</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        CineComp-&gt;FocusSettings.ManualFocusDistance = InFocus;</span><br><span class="line">        CineComp-&gt;<span class="built_in">SetFocusSettings</span>(CineComp-&gt;FocusSettings);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ViewportClient.<span class="built_in">IsValid</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFocusDistance</span>(InFocus); &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; CachedFocusDistance = InFocus; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TcgXR-cpp"><a href="#TcgXR-cpp" class="headerlink" title="TcgXR.cpp"></a>TcgXR.cpp</h3><p><strong>文件路径</strong>: <code>Private\TcgXR.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// 本文件为TcgXR插件主模块，负责插件的初始化、UI布局和命令注册。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXR.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRStyle.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRCommands.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ToolMenus.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Framework/Docking/TabManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Docking/SDockTab.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Layout/SBorder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/SBoxPanel.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SCheckBox.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SButton.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SComboBox.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SSlider.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SSpinBox.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SComboButton.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Text/STextBlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/SWindow.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Framework/Application/SlateApplication.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;STcgXRViewport.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRViewportClient.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LevelEditor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LevelEditorViewport.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SLevelViewport.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EngineUtils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Camera/CameraActor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Editor.h&quot;</span> <span class="comment">// FEditorDelegates</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">const</span> FName <span class="title">TcgXRTabName</span><span class="params">(<span class="string">&quot;TcgXRWindow&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOCTEXT_NAMESPACE <span class="string">&quot;FTcgXRModule&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::StartupModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FTcgXRStyle::<span class="built_in">Initialize</span>();</span><br><span class="line">	FTcgXRStyle::<span class="built_in">ReloadTextures</span>();</span><br><span class="line"></span><br><span class="line">	FTcgXRCommands::<span class="built_in">Register</span>();</span><br><span class="line">	</span><br><span class="line">	PluginCommands = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> FUICommandList);</span><br><span class="line">	PluginCommands-&gt;<span class="built_in">MapAction</span>(</span><br><span class="line">		FTcgXRCommands::<span class="built_in">Get</span>().PluginAction,</span><br><span class="line">		FExecuteAction::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FTcgXRModule::PluginButtonClicked),</span><br><span class="line">		<span class="built_in">FCanExecuteAction</span>());</span><br><span class="line"></span><br><span class="line">	FGlobalTabmanager::<span class="built_in">Get</span>()-&gt;<span class="built_in">RegisterNomadTabSpawner</span>(TcgXRTabName,</span><br><span class="line">		FOnSpawnTab::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FTcgXRModule::OnSpawnPluginTab))</span><br><span class="line">		.<span class="built_in">SetDisplayName</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;TcgXRTabTitle&quot;</span>, <span class="string">&quot;TcgXR&quot;</span>))</span><br><span class="line">		.<span class="built_in">SetMenuType</span>(ETabSpawnerMenuType::Hidden);</span><br><span class="line"></span><br><span class="line">	UToolMenus::<span class="built_in">RegisterStartupCallback</span>(FSimpleMulticastDelegate::FDelegate::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FTcgXRModule::RegisterMenus));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (GEngine)</span><br><span class="line">	&#123;</span><br><span class="line">		ActorAddedHandle = GEngine-&gt;<span class="built_in">OnLevelActorAdded</span>().<span class="built_in">AddLambda</span>([<span class="keyword">this</span>](AActor* <span class="comment">/*Actor*/</span>)&#123; <span class="built_in">RefreshCameraList</span>(); &#125;);</span><br><span class="line">		ActorDeletedHandle = GEngine-&gt;<span class="built_in">OnLevelActorDeleted</span>().<span class="built_in">AddLambda</span>([<span class="keyword">this</span>](AActor* <span class="comment">/*Actor*/</span>)&#123; <span class="built_in">RefreshCameraList</span>(); &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 当编辑器相机移动或切换锁定时，刷新“当前控制”文本</span></span><br><span class="line">	FEditorDelegates::OnEditorCameraMoved.<span class="built_in">AddLambda</span>([<span class="keyword">this</span>](<span class="type">const</span> FVector&amp;, <span class="type">const</span> FRotator&amp;, ELevelViewportType, int32)&#123; <span class="built_in">RebuildCameraHotkeyUI</span>(); &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::ShutdownModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UToolMenus::<span class="built_in">UnRegisterStartupCallback</span>(<span class="keyword">this</span>);</span><br><span class="line">	UToolMenus::<span class="built_in">UnregisterOwner</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	FGlobalTabmanager::<span class="built_in">Get</span>()-&gt;<span class="built_in">UnregisterNomadTabSpawner</span>(TcgXRTabName);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (GEngine)</span><br><span class="line">	&#123;</span><br><span class="line">		GEngine-&gt;<span class="built_in">OnLevelActorAdded</span>().<span class="built_in">Remove</span>(ActorAddedHandle);</span><br><span class="line">		GEngine-&gt;<span class="built_in">OnLevelActorDeleted</span>().<span class="built_in">Remove</span>(ActorDeletedHandle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FTcgXRStyle::<span class="built_in">Shutdown</span>();</span><br><span class="line">	FTcgXRCommands::<span class="built_in">Unregister</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::PluginButtonClicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FGlobalTabmanager::<span class="built_in">Get</span>()-&gt;<span class="built_in">TryInvokeTab</span>(TcgXRTabName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::RegisterMenus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">FToolMenuOwnerScoped <span class="title">OwnerScoped</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (UToolMenu* Menu = UToolMenus::<span class="built_in">Get</span>()-&gt;<span class="built_in">ExtendMenu</span>(<span class="string">&quot;LevelEditor.MainMenu.Window&quot;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		FToolMenuSection&amp; Section = Menu-&gt;<span class="built_in">FindOrAddSection</span>(<span class="string">&quot;WindowLayout&quot;</span>);</span><br><span class="line">		Section.<span class="built_in">AddMenuEntryWithCommandList</span>(FTcgXRCommands::<span class="built_in">Get</span>().PluginAction, PluginCommands);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (UToolMenu* ToolbarMenu = UToolMenus::<span class="built_in">Get</span>()-&gt;<span class="built_in">ExtendMenu</span>(<span class="string">&quot;LevelEditor.LevelEditorToolBar.PlayToolBar&quot;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		FToolMenuSection&amp; Section = ToolbarMenu-&gt;<span class="built_in">FindOrAddSection</span>(<span class="string">&quot;PluginTools&quot;</span>);</span><br><span class="line">		FToolMenuEntry&amp; Entry = Section.<span class="built_in">AddEntry</span>(FToolMenuEntry::<span class="built_in">InitToolBarButton</span>(FTcgXRCommands::<span class="built_in">Get</span>().PluginAction));</span><br><span class="line">		Entry.<span class="built_in">SetCommandList</span>(PluginCommands);</span><br><span class="line">		Entry.Icon = <span class="built_in">FSlateIcon</span>(FTcgXRStyle::<span class="built_in">GetStyleSetName</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;TcgXR.PluginAction.Small&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;TcgXR.PluginAction&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FTcgXRModule::HandleKeyDown</span><span class="params">(<span class="type">const</span> FKey&amp; Key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (TWeakObjectPtr&lt;ACameraActor&gt;* Found = CameraHotkeyMap.<span class="built_in">Find</span>(Key))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SwitchToCamera</span>(*Found);</span><br><span class="line">		<span class="built_in">RebuildCameraHotkeyUI</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::BindCameraHotkey</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera, <span class="type">const</span> FKey&amp; Key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 确保一个相机只绑定一个键：先移除旧绑定</span></span><br><span class="line">	TArray&lt;FKey&gt; KeysToRemove;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; Pair : CameraHotkeyMap)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Pair.Value == Camera)</span><br><span class="line">		&#123;</span><br><span class="line">			KeysToRemove.<span class="built_in">Add</span>(Pair.Key);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> FKey&amp; OldKey : KeysToRemove)</span><br><span class="line">	&#123;</span><br><span class="line">		CameraHotkeyMap.<span class="built_in">Remove</span>(OldKey);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 同一按键重新绑定到新相机</span></span><br><span class="line">	CameraHotkeyMap.<span class="built_in">Add</span>(Key, Camera);</span><br><span class="line">	<span class="built_in">RebuildCameraHotkeyUI</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::SwitchToCamera</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!Camera.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line">	FLevelEditorModule&amp; LevelEditorModule = FModuleManager::<span class="built_in">LoadModuleChecked</span>&lt;FLevelEditorModule&gt;(<span class="string">&quot;LevelEditor&quot;</span>);</span><br><span class="line">	TSharedPtr&lt;SLevelViewport&gt; ActiveViewport = LevelEditorModule.<span class="built_in">GetFirstActiveLevelViewport</span>();</span><br><span class="line">	<span class="keyword">if</span> (!ActiveViewport.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	FLevelEditorViewportClient&amp; LVC = ActiveViewport-&gt;<span class="built_in">GetLevelViewportClient</span>();</span><br><span class="line">	LVC.<span class="built_in">SetActorLock</span>(Camera.<span class="built_in">Get</span>());</span><br><span class="line">	LVC.<span class="built_in">UpdateViewForLockedActor</span>();</span><br><span class="line">	<span class="keyword">if</span> (!ActiveViewport-&gt;<span class="built_in">IsLockedCameraViewEnabled</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		ActiveViewport-&gt;<span class="built_in">ToggleActorPilotCameraView</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	LVC.<span class="built_in">Invalidate</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FText <span class="title">FTcgXRModule::GetCurrentControlledCameraText</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!GEditor) <span class="keyword">return</span> <span class="built_in">LOCTEXT</span>(<span class="string">&quot;NoEditor&quot;</span>, <span class="string">&quot;当前控制: 无（未找到编辑器）&quot;</span>);</span><br><span class="line">	<span class="type">const</span> TArray&lt;FLevelEditorViewportClient*&gt;&amp; Clients = GEditor-&gt;<span class="built_in">GetLevelViewportClients</span>();</span><br><span class="line">	<span class="keyword">for</span> (FLevelEditorViewportClient* LVC : Clients)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!LVC || !LVC-&gt;<span class="built_in">IsPerspective</span>()) <span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (AActor* CineLock = LVC-&gt;<span class="built_in">GetCinematicActorLock</span>().<span class="built_in">GetLockedActor</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ControllingCam&quot;</span>,<span class="string">&quot;当前控制: &#123;0&#125;&quot;</span>), FText::<span class="built_in">FromString</span>(CineLock-&gt;<span class="built_in">GetActorLabel</span>()));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (LVC-&gt;<span class="built_in">GetActiveActorLock</span>().<span class="built_in">IsValid</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			AActor* Locked = LVC-&gt;<span class="built_in">GetActiveActorLock</span>().<span class="built_in">Get</span>();</span><br><span class="line">			<span class="keyword">return</span> FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ControllingActor&quot;</span>,<span class="string">&quot;当前控制: &#123;0&#125;&quot;</span>), FText::<span class="built_in">FromString</span>(Locked-&gt;<span class="built_in">GetActorLabel</span>()));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">LOCTEXT</span>(<span class="string">&quot;NoCam&quot;</span>,<span class="string">&quot;当前控制: 无（未锁定相机）&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FText <span class="title">FTcgXRModule::GetBoundKeyTextForCamera</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; Pair : CameraHotkeyMap)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Pair.Value == Camera)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;BoundKeyFmt&quot;</span>,<span class="string">&quot;已绑定: &#123;0&#125;&quot;</span>), Pair.Key.<span class="built_in">GetDisplayName</span>());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">LOCTEXT</span>(<span class="string">&quot;NoKeyBound&quot;</span>,<span class="string">&quot;未绑定&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::RefreshCameraList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CachedCameras.<span class="built_in">Reset</span>();</span><br><span class="line">	<span class="keyword">if</span> (GEditor)</span><br><span class="line">	&#123;</span><br><span class="line">		UWorld* World = GEditor-&gt;<span class="built_in">GetEditorWorldContext</span>().<span class="built_in">World</span>();</span><br><span class="line">		<span class="keyword">if</span> (World)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span> (TActorIterator&lt;ACameraActor&gt; <span class="built_in">It</span>(World); It; ++It)</span><br><span class="line">			&#123;</span><br><span class="line">				CachedCameras.<span class="built_in">Add</span>(*It);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">RebuildCameraHotkeyUI</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::RebuildCameraHotkeyUI</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TSharedPtr&lt;SVerticalBox&gt; Panel = CameraListPanel.<span class="built_in">Pin</span>();</span><br><span class="line">	<span class="keyword">if</span> (!Panel.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line">	Panel-&gt;<span class="built_in">ClearChildren</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 顶部显示当前控制的相机</span></span><br><span class="line">	Panel-&gt;<span class="built_in">AddSlot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">	[</span><br><span class="line">		<span class="built_in">SNew</span>(STextBlock)</span><br><span class="line">		.<span class="built_in">Text_Lambda</span>([<span class="keyword">this</span>]()&#123; <span class="keyword">return</span> <span class="built_in">GetCurrentControlledCameraText</span>(); &#125;)</span><br><span class="line">	];</span><br><span class="line"></span><br><span class="line">	int32 Index = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span> (TWeakObjectPtr&lt;ACameraActor&gt; Cam : CachedCameras)</span><br><span class="line">	&#123;</span><br><span class="line">		TWeakObjectPtr&lt;ACameraActor&gt; LocalCam = Cam;</span><br><span class="line">		FText Label = FText::<span class="built_in">FromString</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;相机%d: %s&quot;</span>), Index, LocalCam.<span class="built_in">IsValid</span>() ? *LocalCam-&gt;<span class="built_in">GetActorLabel</span>() : <span class="built_in">TEXT</span>(<span class="string">&quot;(无)&quot;</span>)));</span><br><span class="line">		Panel-&gt;<span class="built_in">AddSlot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">		[</span><br><span class="line">			<span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">			+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">			[</span><br><span class="line">				<span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(Label)</span><br><span class="line">			]</span><br><span class="line">			+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">			[</span><br><span class="line">				<span class="built_in">SNew</span>(STextBlock)</span><br><span class="line">				.<span class="built_in">Text_Lambda</span>([<span class="keyword">this</span>, LocalCam]()&#123; <span class="keyword">return</span> <span class="built_in">GetBoundKeyTextForCamera</span>(LocalCam); &#125;)</span><br><span class="line">			]</span><br><span class="line">			+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">			[</span><br><span class="line">				<span class="built_in">SNew</span>(SComboButton)</span><br><span class="line">				.<span class="built_in">ButtonContent</span>()[ <span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;BindKey&quot;</span>, <span class="string">&quot;绑定按键&quot;</span>)) ]</span><br><span class="line">				.<span class="built_in">OnGetMenuContent_Lambda</span>([<span class="keyword">this</span>, LocalCam]()</span><br><span class="line">				&#123;</span><br><span class="line">					FMenuBuilder <span class="built_in">MenuBuilder</span>(<span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">					TArray&lt;FKey&gt; Keys; Keys.<span class="built_in">Reserve</span>(<span class="number">9</span>);</span><br><span class="line">					Keys.<span class="built_in">Add</span>(EKeys::One); Keys.<span class="built_in">Add</span>(EKeys::Two); Keys.<span class="built_in">Add</span>(EKeys::Three); Keys.<span class="built_in">Add</span>(EKeys::Four);</span><br><span class="line">					Keys.<span class="built_in">Add</span>(EKeys::Five); Keys.<span class="built_in">Add</span>(EKeys::Six); Keys.<span class="built_in">Add</span>(EKeys::Seven); Keys.<span class="built_in">Add</span>(EKeys::Eight); Keys.<span class="built_in">Add</span>(EKeys::Nine);</span><br><span class="line">					<span class="keyword">for</span> (<span class="type">const</span> FKey&amp; K : Keys)</span><br><span class="line">					&#123;</span><br><span class="line">						FText KeyName = K.<span class="built_in">GetDisplayName</span>();</span><br><span class="line">						MenuBuilder.<span class="built_in">AddMenuEntry</span>(KeyName, <span class="built_in">LOCTEXT</span>(<span class="string">&quot;BindKeyTip&quot;</span>,<span class="string">&quot;绑定到该键&quot;</span>), <span class="built_in">FSlateIcon</span>(), <span class="built_in">FUIAction</span>(FExecuteAction::<span class="built_in">CreateLambda</span>([<span class="keyword">this</span>, LocalCam, K]()&#123; <span class="built_in">BindCameraHotkey</span>(LocalCam, K); &#125;)));</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span> MenuBuilder.<span class="built_in">MakeWidget</span>();</span><br><span class="line">				&#125;)</span><br><span class="line">			]</span><br><span class="line">			+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">			[</span><br><span class="line">				<span class="built_in">SNew</span>(SButton)</span><br><span class="line">				.<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;SwitchNow&quot;</span>,<span class="string">&quot;切换到该相机&quot;</span>))</span><br><span class="line">				.<span class="built_in">OnClicked_Lambda</span>([<span class="keyword">this</span>, LocalCam]()</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">SwitchToCamera</span>(LocalCam);</span><br><span class="line">					<span class="built_in">RebuildCameraHotkeyUI</span>();</span><br><span class="line">					<span class="keyword">return</span> FReply::<span class="built_in">Handled</span>();</span><br><span class="line">				&#125;)</span><br><span class="line">			]</span><br><span class="line">		];</span><br><span class="line">		++Index;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::CloseAllFullscreenWindows</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (TWeakPtr&lt;SWindow&gt;&amp; W : FullscreenWindows)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (TSharedPtr&lt;SWindow&gt; SW = W.<span class="built_in">Pin</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			SW-&gt;<span class="built_in">RequestDestroyWindow</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	FullscreenWindows.<span class="built_in">Reset</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成主窗口Tab，包括Viewport、右侧摄影机控制面板、底部全屏按钮</span></span><br><span class="line"><span class="function">TSharedRef&lt;SDockTab&gt; <span class="title">FTcgXRModule::OnSpawnPluginTab</span><span class="params">(<span class="type">const</span> FSpawnTabArgs&amp; Args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TSharedPtr&lt;STcgXRViewport&gt; ViewportWidget;</span><br><span class="line"></span><br><span class="line">	<span class="type">static</span> <span class="type">float</span> ManualExposure = <span class="number">0.0f</span>;</span><br><span class="line">	<span class="type">static</span> <span class="type">float</span> ManualFOV = <span class="number">90.0f</span>;</span><br><span class="line">	<span class="type">static</span> <span class="type">float</span> ManualFocal = <span class="number">35.0f</span>;</span><br><span class="line">	<span class="type">static</span> <span class="type">float</span> ManualAperture = <span class="number">2.8f</span>;</span><br><span class="line">	<span class="type">static</span> <span class="type">float</span> ManualFocus = <span class="number">1000.0f</span>;</span><br><span class="line">	<span class="type">static</span> <span class="type">bool</span> bUseLiveLink = <span class="literal">false</span>;</span><br><span class="line">	<span class="type">static</span> TArray&lt;TSharedPtr&lt;FString&gt;&gt; ResolutionOptions;</span><br><span class="line">	ResolutionOptions.<span class="built_in">Reset</span>();</span><br><span class="line">	ResolutionOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;1920x1080&quot;</span>)));</span><br><span class="line">	ResolutionOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;2560x1440&quot;</span>)));</span><br><span class="line">	ResolutionOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;3840x2160&quot;</span>)));</span><br><span class="line">	<span class="type">static</span> TArray&lt;TSharedPtr&lt;FString&gt;&gt; MonitorOptions;</span><br><span class="line">	<span class="type">static</span> int32 SelectedMonitorIndex = <span class="number">0</span>;</span><br><span class="line">	<span class="type">static</span> TSharedPtr&lt;FString&gt; SelectedResolution = ResolutionOptions.<span class="built_in">Num</span>() &gt; <span class="number">0</span> ? ResolutionOptions[<span class="number">0</span>] : <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	MonitorOptions.<span class="built_in">Reset</span>();</span><br><span class="line">	&#123;</span><br><span class="line">		FDisplayMetrics Metrics;</span><br><span class="line">		FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">GetDisplayMetrics</span>(Metrics);</span><br><span class="line">		MonitorOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;主显示器 %dx%d&quot;</span>), Metrics.PrimaryDisplayWidth, Metrics.PrimaryDisplayHeight)));</span><br><span class="line">		<span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; Metrics.MonitorInfo.<span class="built_in">Num</span>(); ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> <span class="keyword">auto</span>&amp; M = Metrics.MonitorInfo[i];</span><br><span class="line">			FPlatformRect Rect = M.WorkArea;</span><br><span class="line">			MonitorOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;显示器%d %dx%d @(%d,%d)&quot;</span>), i, Rect.Right-Rect.Left, Rect.Bottom-Rect.Top, Rect.Left, Rect.Top)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (MonitorOptions.<span class="built_in">Num</span>() == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			MonitorOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;显示器0&quot;</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TSharedRef&lt;SDockTab&gt; Tab = <span class="built_in">SNew</span>(SDockTab)</span><br><span class="line">		.<span class="built_in">TabRole</span>(ETabRole::NomadTab)</span><br><span class="line">		[</span><br><span class="line">			<span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">			+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">FillWidth</span>(<span class="number">1.f</span>)</span><br><span class="line">			[</span><br><span class="line">				<span class="built_in">SAssignNew</span>(ViewportWidget, STcgXRViewport)</span><br><span class="line">			]</span><br><span class="line">			+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">8.f</span>,<span class="number">0.f</span>)</span><br><span class="line">			[</span><br><span class="line">				<span class="built_in">SNew</span>(SVerticalBox)</span><br><span class="line">				+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">				[</span><br><span class="line">					<span class="built_in">SAssignNew</span>(CameraListPanel, SVerticalBox)</span><br><span class="line">				]</span><br><span class="line">				<span class="comment">// 顶部快速参数行：移除FOV和曝光</span></span><br><span class="line">				+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">				[</span><br><span class="line">					<span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">					<span class="comment">// 焦距</span></span><br><span class="line">					+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;Focal&quot;</span>, <span class="string">&quot;焦距&quot;</span>))</span><br><span class="line">					]</span><br><span class="line">					+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(SSpinBox&lt;<span class="type">float</span>&gt;).<span class="built_in">MinValue</span>(<span class="number">1.f</span>).<span class="built_in">MaxValue</span>(<span class="number">300.f</span>)</span><br><span class="line">						.<span class="built_in">Value_Lambda</span>([&amp;]&#123; <span class="keyword">return</span> ManualFocal; &#125;)</span><br><span class="line">						.<span class="built_in">OnValueChanged_Lambda</span>([&amp;](<span class="type">float</span> V)&#123; ManualFocal = V; <span class="keyword">if</span>(ViewportWidget.<span class="built_in">IsValid</span>()) ViewportWidget-&gt;<span class="built_in">SetFocalLengthParam</span>(V); &#125;)</span><br><span class="line">					]</span><br><span class="line">					<span class="comment">// 光圈</span></span><br><span class="line">					+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;Aperture&quot;</span>, <span class="string">&quot;光圈&quot;</span>))</span><br><span class="line">					]</span><br><span class="line">					+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(SSpinBox&lt;<span class="type">float</span>&gt;).<span class="built_in">MinValue</span>(<span class="number">0.7f</span>).<span class="built_in">MaxValue</span>(<span class="number">32.f</span>)</span><br><span class="line">						.<span class="built_in">Value_Lambda</span>([&amp;]&#123; <span class="keyword">return</span> ManualAperture; &#125;)</span><br><span class="line">						.<span class="built_in">OnValueChanged_Lambda</span>([&amp;](<span class="type">float</span> V)&#123; ManualAperture = V; <span class="keyword">if</span>(ViewportWidget.<span class="built_in">IsValid</span>()) ViewportWidget-&gt;<span class="built_in">SetApertureParam</span>(V); &#125;)</span><br><span class="line">					]</span><br><span class="line">					<span class="comment">// 对焦</span></span><br><span class="line">					+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;Focus&quot;</span>, <span class="string">&quot;对焦&quot;</span>))</span><br><span class="line">					]</span><br><span class="line">					+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(SSpinBox&lt;<span class="type">float</span>&gt;).<span class="built_in">MinValue</span>(<span class="number">1.f</span>).<span class="built_in">MaxValue</span>(<span class="number">100000.f</span>)</span><br><span class="line">						.<span class="built_in">Value_Lambda</span>([&amp;]&#123; <span class="keyword">return</span> ManualFocus; &#125;)</span><br><span class="line">						.<span class="built_in">OnValueChanged_Lambda</span>([&amp;](<span class="type">float</span> V)&#123; ManualFocus = V; <span class="keyword">if</span>(ViewportWidget.<span class="built_in">IsValid</span>()) ViewportWidget-&gt;<span class="built_in">SetFocusDistanceParam</span>(V); &#125;)</span><br><span class="line">					]</span><br><span class="line">				]</span><br><span class="line"></span><br><span class="line">				+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">				[</span><br><span class="line">					<span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">					+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(SCheckBox)</span><br><span class="line">						.<span class="built_in">IsChecked_Lambda</span>([] &#123; <span class="keyword">return</span> bUseLiveLink ? ECheckBoxState::Checked : ECheckBoxState::Unchecked; &#125;)</span><br><span class="line">						.<span class="built_in">OnCheckStateChanged_Lambda</span>([](ECheckBoxState State) &#123; bUseLiveLink = (State == ECheckBoxState::Checked); &#125;)</span><br><span class="line">					]</span><br><span class="line">					+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;LiveLinkSwitch&quot;</span>, <span class="string">&quot;使用LiveLink外部相机&quot;</span>))</span><br><span class="line">					]</span><br><span class="line">				]</span><br><span class="line"></span><br><span class="line">				+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">				[</span><br><span class="line">					<span class="built_in">SNew</span>(SVerticalBox)</span><br><span class="line">					.<span class="built_in">Visibility_Lambda</span>([] &#123; <span class="keyword">return</span> bUseLiveLink ? EVisibility::Visible : EVisibility::Collapsed; &#125;)</span><br><span class="line">					+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>()</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;LiveLinkTitle&quot;</span>, <span class="string">&quot;LiveLink外部相机参数&quot;</span>))</span><br><span class="line">					]</span><br><span class="line">					+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;LiveLinkStatus&quot;</span>, <span class="string">&quot;状态: 未连接/已连接&quot;</span>))</span><br><span class="line">					]</span><br><span class="line">				]</span><br><span class="line"></span><br><span class="line">				+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">VAlign</span>(VAlign_Bottom).<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">				[</span><br><span class="line">					<span class="built_in">SNew</span>(SVerticalBox)</span><br><span class="line">					+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">						+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">						[</span><br><span class="line">							<span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;MonitorLabel&quot;</span>, <span class="string">&quot;屏幕&quot;</span>))</span><br><span class="line">						]</span><br><span class="line">						+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">						[</span><br><span class="line">							<span class="built_in">SNew</span>(SComboBox&lt;TSharedPtr&lt;FString&gt;&gt;)</span><br><span class="line">							.<span class="built_in">OptionsSource</span>(&amp;MonitorOptions)</span><br><span class="line">							.<span class="built_in">OnSelectionChanged_Lambda</span>([&amp;](TSharedPtr&lt;FString&gt; NewItem, ESelectInfo::Type)&#123; SelectedMonitorIndex = FMath::<span class="built_in">Clamp</span>(MonitorOptions.<span class="built_in">IndexOfByKey</span>(NewItem), <span class="number">0</span>, MonitorOptions.<span class="built_in">Num</span>()<span class="number">-1</span>); &#125;)</span><br><span class="line">							.<span class="built_in">OnGenerateWidget_Lambda</span>([](TSharedPtr&lt;FString&gt; InItem)&#123; <span class="keyword">return</span> <span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(FText::<span class="built_in">FromString</span>(*InItem)); &#125;)</span><br><span class="line">							[</span><br><span class="line">								<span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text_Lambda</span>([&amp;]&#123; <span class="keyword">return</span> MonitorOptions.<span class="built_in">IsValidIndex</span>(SelectedMonitorIndex) ? FText::<span class="built_in">FromString</span>(*MonitorOptions[SelectedMonitorIndex]) : <span class="built_in">LOCTEXT</span>(<span class="string">&quot;MonitorUnknown&quot;</span>,<span class="string">&quot;未知屏幕&quot;</span>); &#125;)</span><br><span class="line">							]</span><br><span class="line">						]</span><br><span class="line">					]</span><br><span class="line">					+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">						+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">						[</span><br><span class="line">							<span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ResolutionLabel&quot;</span>, <span class="string">&quot;输出分辨率&quot;</span>))</span><br><span class="line">						]</span><br><span class="line">						+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">						[</span><br><span class="line">							<span class="built_in">SNew</span>(SComboBox&lt;TSharedPtr&lt;FString&gt;&gt;)</span><br><span class="line">							.<span class="built_in">OptionsSource</span>(&amp;ResolutionOptions)</span><br><span class="line">							.<span class="built_in">OnSelectionChanged_Lambda</span>([&amp;](TSharedPtr&lt;FString&gt; NewItem, ESelectInfo::Type) &#123; SelectedResolution = NewItem; &#125;)</span><br><span class="line">							.<span class="built_in">OnGenerateWidget_Lambda</span>([](TSharedPtr&lt;FString&gt; InItem) &#123; <span class="keyword">return</span> <span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(FText::<span class="built_in">FromString</span>(*InItem)); &#125;)</span><br><span class="line">							[</span><br><span class="line">								<span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text_Lambda</span>([&amp;] &#123; <span class="keyword">return</span> SelectedResolution.<span class="built_in">IsValid</span>() ? FText::<span class="built_in">FromString</span>(*SelectedResolution) : <span class="built_in">LOCTEXT</span>(<span class="string">&quot;ResUnknown&quot;</span>,<span class="string">&quot;未知&quot;</span>); &#125;)</span><br><span class="line">							]</span><br><span class="line">						]</span><br><span class="line">					]</span><br><span class="line">					+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">					[</span><br><span class="line">						<span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">						+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">						[</span><br><span class="line">							<span class="built_in">SNew</span>(SButton)</span><br><span class="line">							.<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;FullscreenBtn&quot;</span>, <span class="string">&quot;全屏显示&quot;</span>))</span><br><span class="line">							.<span class="built_in">OnClicked_Lambda</span>([<span class="keyword">this</span>, ViewportWidget]() &#123;</span><br><span class="line">								<span class="keyword">if</span>(!ViewportWidget.<span class="built_in">IsValid</span>()) <span class="keyword">return</span> FReply::<span class="built_in">Handled</span>();</span><br><span class="line">								TSharedPtr&lt;FString&gt; LocalSelectedResolution = SelectedResolution;</span><br><span class="line">								int32 LocalSelectedMonitorIndex = SelectedMonitorIndex;</span><br><span class="line">								int32 W=<span class="number">1920</span>, H=<span class="number">1080</span>;</span><br><span class="line">								&#123;</span><br><span class="line">									FString Res= LocalSelectedResolution.<span class="built_in">IsValid</span>() ? *LocalSelectedResolution : <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;1920x1080&quot;</span>));</span><br><span class="line">									FString LW, LH;</span><br><span class="line">									<span class="keyword">if</span>(Res.<span class="built_in">Split</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;x&quot;</span>), &amp;LW, &amp;LH)) &#123; W = FCString::<span class="built_in">Atoi</span>(*LW); H = FCString::<span class="built_in">Atoi</span>(*LH); &#125;</span><br><span class="line">								&#125;</span><br><span class="line">								TSharedPtr&lt;SWindow&gt; FullscreenWindow = <span class="built_in">SNew</span>(SWindow)</span><br><span class="line">									.<span class="built_in">Title</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;XRFullscreen&quot;</span>, <span class="string">&quot;XR全屏输出&quot;</span>))</span><br><span class="line">									.<span class="built_in">ClientSize</span>(<span class="built_in">FVector2D</span>(W, H))</span><br><span class="line">									.<span class="built_in">SizingRule</span>(ESizingRule::FixedSize)</span><br><span class="line">									.<span class="built_in">SupportsMaximize</span>(<span class="literal">false</span>)</span><br><span class="line">									.<span class="built_in">SupportsMinimize</span>(<span class="literal">false</span>)</span><br><span class="line">									.<span class="built_in">HasCloseButton</span>(<span class="literal">true</span>)</span><br><span class="line">									.<span class="built_in">UseOSWindowBorder</span>(<span class="literal">false</span>)</span><br><span class="line">									.<span class="built_in">CreateTitleBar</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">								TSharedPtr&lt;STcgXRViewport&gt; FSViewport;</span><br><span class="line">								FullscreenWindow-&gt;<span class="built_in">SetContent</span>(<span class="built_in">SAssignNew</span>(FSViewport, STcgXRViewport));</span><br><span class="line"></span><br><span class="line">								<span class="keyword">if</span> (FSlateApplication::<span class="built_in">IsInitialized</span>())</span><br><span class="line">								&#123;</span><br><span class="line">									FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">AddWindow</span>(FullscreenWindow.<span class="built_in">ToSharedRef</span>());</span><br><span class="line">									FDisplayMetrics Metrics; FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">GetDisplayMetrics</span>(Metrics);</span><br><span class="line">									FVector2D <span class="built_in">TargetPos</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">									<span class="keyword">if</span> (Metrics.MonitorInfo.<span class="built_in">IsValidIndex</span>(LocalSelectedMonitorIndex))</span><br><span class="line">									&#123;</span><br><span class="line">										<span class="type">const</span> <span class="keyword">auto</span>&amp; M = Metrics.MonitorInfo[LocalSelectedMonitorIndex];</span><br><span class="line">										TargetPos = <span class="built_in">FVector2D</span>(M.WorkArea.Left, M.WorkArea.Top);</span><br><span class="line">									&#125;</span><br><span class="line">									FullscreenWindow-&gt;<span class="built_in">MoveWindowTo</span>(TargetPos);</span><br><span class="line">								&#125;</span><br><span class="line"></span><br><span class="line">								FullscreenWindows.<span class="built_in">Add</span>(FullscreenWindow);</span><br><span class="line"></span><br><span class="line">								<span class="keyword">if</span> (ViewportWidget-&gt;<span class="built_in">GetClient</span>().<span class="built_in">IsValid</span>() &amp;&amp; FSViewport.<span class="built_in">IsValid</span>())</span><br><span class="line">								&#123;</span><br><span class="line">									<span class="keyword">auto</span> Src = ViewportWidget-&gt;<span class="built_in">GetClient</span>();</span><br><span class="line">									<span class="keyword">auto</span> Dst = FSViewport-&gt;<span class="built_in">GetClient</span>();</span><br><span class="line">									Dst-&gt;<span class="built_in">SetCameraFrom</span>(Src-&gt;<span class="built_in">GetViewLocation</span>(), Src-&gt;<span class="built_in">GetViewRotation</span>(), Src-&gt;<span class="built_in">GetFOV</span>(), <span class="number">2048.f</span>, <span class="literal">false</span>);</span><br><span class="line">									Dst-&gt;<span class="built_in">SetFOV</span>(Src-&gt;<span class="built_in">GetFOV</span>());</span><br><span class="line">									Dst-&gt;<span class="built_in">SetExposure</span>(Src-&gt;<span class="built_in">GetExposure</span>());</span><br><span class="line">									Dst-&gt;<span class="built_in">SetFocalLength</span>(Src-&gt;<span class="built_in">GetFocalLength</span>());</span><br><span class="line">									Dst-&gt;<span class="built_in">SetAperture</span>(Src-&gt;<span class="built_in">GetAperture</span>());</span><br><span class="line">									Dst-&gt;<span class="built_in">SetFocusDistance</span>(Src-&gt;<span class="built_in">GetFocusDistance</span>());</span><br><span class="line">								&#125;</span><br><span class="line"></span><br><span class="line">								<span class="keyword">return</span> FReply::<span class="built_in">Handled</span>();</span><br><span class="line">							&#125;)</span><br><span class="line">						]</span><br><span class="line">						+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">						[</span><br><span class="line">							<span class="built_in">SNew</span>(SButton)</span><br><span class="line">							.<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;CloseFullscreenBtn&quot;</span>, <span class="string">&quot;关闭所有全屏&quot;</span>))</span><br><span class="line">							.<span class="built_in">OnClicked_Lambda</span>([<span class="keyword">this</span>]()</span><br><span class="line">							&#123;</span><br><span class="line">								<span class="built_in">CloseAllFullscreenWindows</span>();</span><br><span class="line">								<span class="keyword">return</span> FReply::<span class="built_in">Handled</span>();</span><br><span class="line">							&#125;)</span><br><span class="line">						]</span><br><span class="line">					]</span><br><span class="line">				]</span><br><span class="line">			]</span><br><span class="line">		];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">RefreshCameraList</span>();</span><br><span class="line">	<span class="keyword">return</span> Tab;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> LOCTEXT_NAMESPACE</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">IMPLEMENT_MODULE</span>(FTcgXRModule, TcgXR)</span><br></pre></td></tr></table></figure>

<h3 id="TcgXRCommands-cpp"><a href="#TcgXRCommands-cpp" class="headerlink" title="TcgXRCommands.cpp"></a>TcgXRCommands.cpp</h3><p><strong>文件路径</strong>: <code>Private\TcgXRCommands.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRCommands.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOCTEXT_NAMESPACE <span class="string">&quot;FTcgXRModule&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRCommands::RegisterCommands</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UI_COMMAND</span>(PluginAction, <span class="string">&quot;TcgXR&quot;</span>, <span class="string">&quot;Execute TcgXR action&quot;</span>, EUserInterfaceActionType::Button, <span class="built_in">FInputChord</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> LOCTEXT_NAMESPACE</span></span><br></pre></td></tr></table></figure>

<h3 id="TcgXRStyle-cpp"><a href="#TcgXRStyle-cpp" class="headerlink" title="TcgXRStyle.cpp"></a>TcgXRStyle.cpp</h3><p><strong>文件路径</strong>: <code>Private\TcgXRStyle.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRStyle.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXR.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Framework/Application/SlateApplication.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Styling/SlateStyleRegistry.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Slate/SlateGameResources.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Interfaces/IPluginManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Styling/SlateStyleMacros.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RootToContentDir Style-&gt;RootToContentDir</span></span><br><span class="line"></span><br><span class="line">TSharedPtr&lt;FSlateStyleSet&gt; FTcgXRStyle::StyleInstance = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRStyle::Initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!StyleInstance.<span class="built_in">IsValid</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		StyleInstance = <span class="built_in">Create</span>();</span><br><span class="line">		FSlateStyleRegistry::<span class="built_in">RegisterSlateStyle</span>(*StyleInstance);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRStyle::Shutdown</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FSlateStyleRegistry::<span class="built_in">UnRegisterSlateStyle</span>(*StyleInstance);</span><br><span class="line">	<span class="built_in">ensure</span>(StyleInstance.<span class="built_in">IsUnique</span>());</span><br><span class="line">	StyleInstance.<span class="built_in">Reset</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FName <span class="title">FTcgXRStyle::GetStyleSetName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function"><span class="type">static</span> FName <span class="title">StyleSetName</span><span class="params">(TEXT(<span class="string">&quot;TcgXRStyle&quot;</span>))</span></span>;</span><br><span class="line">	<span class="keyword">return</span> StyleSetName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> FVector2D <span class="title">Icon16x16</span><span class="params">(<span class="number">16.0f</span>, <span class="number">16.0f</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">const</span> FVector2D <span class="title">Icon20x20</span><span class="params">(<span class="number">20.0f</span>, <span class="number">20.0f</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">const</span> FVector2D <span class="title">Icon40x40</span><span class="params">(<span class="number">40.0f</span>, <span class="number">40.0f</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">TSharedRef&lt; FSlateStyleSet &gt; <span class="title">FTcgXRStyle::Create</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TSharedRef&lt; FSlateStyleSet &gt; Style = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FSlateStyleSet</span>(<span class="string">&quot;TcgXRStyle&quot;</span>));</span><br><span class="line">	Style-&gt;<span class="built_in">SetContentRoot</span>(IPluginManager::<span class="built_in">Get</span>().<span class="built_in">FindPlugin</span>(<span class="string">&quot;TcgXR&quot;</span>)-&gt;<span class="built_in">GetBaseDir</span>() / <span class="built_in">TEXT</span>(<span class="string">&quot;Resources&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use vector image brushes from Resources/TcgXR.svg for toolbar/menu icons</span></span><br><span class="line">	Style-&gt;<span class="built_in">Set</span>(<span class="string">&quot;TcgXR.PluginAction&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH_SVG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TcgXR&quot;</span>), Icon40x40));</span><br><span class="line">	Style-&gt;<span class="built_in">Set</span>(<span class="string">&quot;TcgXR.PluginAction.Small&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH_SVG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TcgXR&quot;</span>), Icon20x20));</span><br><span class="line">	<span class="keyword">return</span> Style;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRStyle::ReloadTextures</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (FSlateApplication::<span class="built_in">IsInitialized</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">GetRenderer</span>()-&gt;<span class="built_in">ReloadTextureResources</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> ISlateStyle&amp; <span class="title">FTcgXRStyle::Get</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> *StyleInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TcgXRViewportClient-cpp"><a href="#TcgXRViewportClient-cpp" class="headerlink" title="TcgXRViewportClient.cpp"></a>TcgXRViewportClient.cpp</h3><p><strong>文件路径</strong>: <code>Private\TcgXRViewportClient.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FTcgXRViewportClient implementation has been moved inline to TcgXRViewportClient.h</span></span><br><span class="line"><span class="comment">// This translation unit is intentionally left empty to avoid duplicate definitions.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="STcgXRViewport-h"><a href="#STcgXRViewport-h" class="headerlink" title="STcgXRViewport.h"></a>STcgXRViewport.h</h3><p><strong>文件路径</strong>: <code>Public\STcgXRViewport.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SEditorViewport.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTcgXRViewportClient</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FPreviewScene</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// TcgXR自定义Viewport控件，支持XR场景显示和相机控制</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">STcgXRViewport</span> :</span> public SEditorViewport</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">    SLATE_BEGIN_ARGS(STcgXRViewport) &#123;&#125;</span><br><span class="line">    SLATE_END_ARGS()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">Construct</span><span class="params">(<span class="type">const</span> FArguments&amp; InArgs)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XR状态控制接口</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetShowKeyed</span><span class="params">(<span class="type">bool</span> b)</span>; <span class="comment">// 设置是否显示抠像</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetVirtualCamMove</span><span class="params">(<span class="type">bool</span> b)</span>; <span class="comment">// 设置是否虚拟相机运动</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetMixedRealityBlend</span><span class="params">(<span class="type">bool</span> b)</span>; <span class="comment">// 设置是否虚实融合</span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsShowKeyed</span><span class="params">()</span> <span class="type">const</span>; <span class="comment">// 是否显示抠像</span></span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsVirtualCamMove</span><span class="params">()</span> <span class="type">const</span>; <span class="comment">// 是否虚拟相机运动</span></span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsMixedRealityBlend</span><span class="params">()</span> <span class="type">const</span>; <span class="comment">// 是否虚实融合</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 访问底层ViewportClient（用于复制相机/参数到其它视口）</span></span><br><span class="line">    TSharedPtr&lt;FTcgXRViewportClient&gt; <span class="title function_">GetClient</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> ViewportClient; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 安全设置相机参数：若Client尚未就绪，则缓存稍后应用</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFOVParam</span><span class="params">(<span class="type">float</span> InFOV)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetExposureParam</span><span class="params">(<span class="type">float</span> InExposure)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFocalLengthParam</span><span class="params">(<span class="type">float</span> InFocal)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetApertureParam</span><span class="params">(<span class="type">float</span> InAperture)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFocusDistanceParam</span><span class="params">(<span class="type">float</span> InFocus)</span>;</span><br><span class="line"></span><br><span class="line">protected:</span><br><span class="line">    <span class="comment">// 创建自定义ViewportClient</span></span><br><span class="line">    virtual TSharedRef&lt;FEditorViewportClient&gt; <span class="title function_">MakeEditorViewportClient</span><span class="params">()</span> override;</span><br><span class="line">    <span class="comment">// 不显示默认工具栏</span></span><br><span class="line">    virtual TSharedPtr&lt;SWidget&gt; <span class="title function_">MakeViewportToolbar</span><span class="params">()</span> override &#123; <span class="keyword">return</span> SNullWidget::NullWidget; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 捕获键盘输入分发到模块（用于热键切换相机）</span></span><br><span class="line">    virtual FReply <span class="title function_">OnKeyDown</span><span class="params">(<span class="type">const</span> FGeometry&amp; MyGeometry, <span class="type">const</span> FKeyEvent&amp; InKeyEvent)</span> override;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    <span class="comment">// 应用所有缓存的相机参数</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">ApplyCachedParams</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    TSharedPtr&lt;FTcgXRViewportClient&gt; ViewportClient; <span class="comment">// 视口客户端</span></span><br><span class="line">    TUniquePtr&lt;FPreviewScene&gt; PreviewScene; <span class="comment">// 预览场景</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存相机参数（在Client未就绪时临时保存）</span></span><br><span class="line">    TOptional&lt;<span class="type">float</span>&gt; CachedFOV;</span><br><span class="line">    TOptional&lt;<span class="type">float</span>&gt; CachedExposure;</span><br><span class="line">    TOptional&lt;<span class="type">float</span>&gt; CachedFocalLength;</span><br><span class="line">    TOptional&lt;<span class="type">float</span>&gt; CachedAperture;</span><br><span class="line">    TOptional&lt;<span class="type">float</span>&gt; CachedFocusDistance;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="TcgXR-h"><a href="#TcgXR-h" class="headerlink" title="TcgXR.h"></a>TcgXR.h</h3><p><strong>文件路径</strong>: <code>Public\TcgXR.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Modules/ModuleManager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FToolBarBuilder</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FMenuBuilder</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ACinemaCameraActor</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ACameraActor</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SWindow</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SVerticalBox</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTcgXRModule</span> :</span> public IModuleInterface</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">	<span class="comment">/** IModuleInterface implementation */</span></span><br><span class="line">	virtual <span class="type">void</span> <span class="title function_">StartupModule</span><span class="params">()</span> override;</span><br><span class="line">	virtual <span class="type">void</span> <span class="title function_">ShutdownModule</span><span class="params">()</span> override;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** This function will be bound to Command. */</span></span><br><span class="line">	<span class="type">void</span> <span class="title function_">PluginButtonClicked</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 热键：处理按键（由STcgXRViewport调用），返回是否已处理</span></span><br><span class="line">	<span class="type">bool</span> <span class="title function_">HandleKeyDown</span><span class="params">(<span class="type">const</span> FKey&amp; Key)</span>;</span><br><span class="line">	<span class="comment">// 热键：绑定某个相机到某个按键</span></span><br><span class="line">	<span class="type">void</span> <span class="title function_">BindCameraHotkey</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera, <span class="type">const</span> FKey&amp; Key)</span>;</span><br><span class="line">	<span class="comment">// 切换关卡视口到指定相机</span></span><br><span class="line">	<span class="type">void</span> <span class="title function_">SwitchToCamera</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera)</span>;</span><br><span class="line">	<span class="comment">// 刷新相机列表并重建UI</span></span><br><span class="line">	<span class="type">void</span> <span class="title function_">RefreshCameraList</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 关闭所有全屏窗口</span></span><br><span class="line">	<span class="type">void</span> <span class="title function_">CloseAllFullscreenWindows</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 显示当前控制的相机名称</span></span><br><span class="line">	FText <span class="title function_">GetCurrentControlledCameraText</span><span class="params">()</span> <span class="type">const</span>;</span><br><span class="line">	<span class="comment">// 获取相机已绑定的按键显示文本</span></span><br><span class="line">	FText <span class="title function_">GetBoundKeyTextForCamera</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera)</span> <span class="type">const</span>;</span><br><span class="line">	</span><br><span class="line">private:</span><br><span class="line">	<span class="type">void</span> <span class="title function_">RegisterMenus</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Spawn the XR viewport tab</span></span><br><span class="line">	TSharedRef&lt;class SDockTab&gt; <span class="title function_">OnSpawnPluginTab</span><span class="params">(<span class="type">const</span> class FSpawnTabArgs&amp; Args)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 重建相机热键绑定UI</span></span><br><span class="line">	<span class="type">void</span> <span class="title function_">RebuildCameraHotkeyUI</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">	TSharedPtr&lt;<span class="class"><span class="keyword">class</span> <span class="title">FUICommandList</span>&gt;</span> PluginCommands;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 相机与热键映射</span></span><br><span class="line">	TMap&lt;FKey, TWeakObjectPtr&lt;ACameraActor&gt;&gt; CameraHotkeyMap;</span><br><span class="line">	TArray&lt;TWeakObjectPtr&lt;ACameraActor&gt;&gt; CachedCameras;</span><br><span class="line">	TWeakPtr&lt;SVerticalBox&gt; CameraListPanel;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 监听句柄</span></span><br><span class="line">	FDelegateHandle ActorAddedHandle;</span><br><span class="line">	FDelegateHandle ActorDeletedHandle;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 全屏窗口列表</span></span><br><span class="line">	TArray&lt;TWeakPtr&lt;SWindow&gt;&gt; FullscreenWindows;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="TcgXRCommands-h"><a href="#TcgXRCommands-h" class="headerlink" title="TcgXRCommands.h"></a>TcgXRCommands.h</h3><p><strong>文件路径</strong>: <code>Public\TcgXRCommands.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Framework/Commands/Commands.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRStyle.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTcgXRCommands</span> :</span> public TCommands&lt;FTcgXRCommands&gt;</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line"></span><br><span class="line">	FTcgXRCommands()</span><br><span class="line">		: TCommands&lt;FTcgXRCommands&gt;(TEXT(<span class="string">&quot;TcgXR&quot;</span>), NSLOCTEXT(<span class="string">&quot;Contexts&quot;</span>, <span class="string">&quot;TcgXR&quot;</span>, <span class="string">&quot;TcgXR Plugin&quot;</span>), NAME_None, FTcgXRStyle::GetStyleSetName())</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TCommands&lt;&gt; interface</span></span><br><span class="line">	virtual <span class="type">void</span> <span class="title function_">RegisterCommands</span><span class="params">()</span> override;</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">	TSharedPtr&lt; FUICommandInfo &gt; PluginAction;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="TcgXRStyle-h"><a href="#TcgXRStyle-h" class="headerlink" title="TcgXRStyle.h"></a>TcgXRStyle.h</h3><p><strong>文件路径</strong>: <code>Public\TcgXRStyle.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Styling/SlateStyle.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTcgXRStyle</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line"></span><br><span class="line">	<span class="type">static</span> <span class="type">void</span> <span class="title function_">Initialize</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">static</span> <span class="type">void</span> <span class="title function_">Shutdown</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** reloads textures used by slate renderer */</span></span><br><span class="line">	<span class="type">static</span> <span class="type">void</span> <span class="title function_">ReloadTextures</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** @return The Slate style set for the Shooter game */</span></span><br><span class="line">	<span class="type">static</span> <span class="type">const</span> ISlateStyle&amp; <span class="title function_">Get</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">static</span> FName <span class="title function_">GetStyleSetName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line"></span><br><span class="line">	<span class="type">static</span> TSharedRef&lt; class FSlateStyleSet &gt; <span class="title function_">Create</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line"></span><br><span class="line">	<span class="type">static</span> TSharedPtr&lt; <span class="class"><span class="keyword">class</span> <span class="title">FSlateStyleSet</span> &gt;</span> StyleInstance;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="TcgXRViewportClient-h"><a href="#TcgXRViewportClient-h" class="headerlink" title="TcgXRViewportClient.h"></a>TcgXRViewportClient.h</h3><p><strong>文件路径</strong>: <code>Public\TcgXRViewportClient.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EditorViewportClient.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;PreviewScene.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SEditorViewport.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Editor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SceneView.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// TcgXR自定义ViewportClient，负责相机控制、XR显示等</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTcgXRViewportClient</span> :</span> public FEditorViewportClient</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">    <span class="comment">// 构造函数，初始化视口参数</span></span><br><span class="line">    FTcgXRViewportClient(FPreviewScene* InPreviewScene, <span class="type">const</span> TSharedRef&lt;SEditorViewport&gt;&amp; InEditorViewport)</span><br><span class="line">        : FEditorViewportClient(nullptr, InPreviewScene, InEditorViewport)</span><br><span class="line">    &#123;</span><br><span class="line">        SetViewLocation(FVector(<span class="number">0</span>, <span class="number">-300</span>, <span class="number">200</span>));</span><br><span class="line">        SetViewRotation(FRotator(<span class="number">-10</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        SetRealtime(<span class="literal">true</span>);</span><br><span class="line">        EngineShowFlags.SetGrid(<span class="literal">true</span>);</span><br><span class="line">        EngineShowFlags.EnableAdvancedFeatures();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染主编辑器世界，保证视口内容与主场景一致</span></span><br><span class="line">    virtual UWorld* <span class="title function_">GetWorld</span><span class="params">()</span> <span class="type">const</span> override</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (GEditor) ? GEditor-&gt;GetEditorWorldContext().World() : nullptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XR相关切换</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetShowKeyed</span><span class="params">(<span class="type">bool</span> bValue)</span></span><br><span class="line">    &#123;</span><br><span class="line">        bShowKeyed = bValue;</span><br><span class="line">        EngineShowFlags.PostProcessing = bShowKeyed; <span class="comment">// 示例：切换后处理</span></span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetVirtualCamMove</span><span class="params">(<span class="type">bool</span> bValue)</span></span><br><span class="line">    &#123;</span><br><span class="line">        bVirtualCamMove = bValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetMixedRealityBlend</span><span class="params">(<span class="type">bool</span> bValue)</span></span><br><span class="line">    &#123;</span><br><span class="line">        bMixedRealityBlend = bValue;</span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 相机参数控制</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFOV</span><span class="params">(<span class="type">float</span> InFOV)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewFOV = FMath::Clamp(InFOV, <span class="number">15.f</span>, <span class="number">170.f</span>);</span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">GetFOV</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> ViewFOV; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetExposure</span><span class="params">(<span class="type">float</span> InExposure)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ManualExposureBias = FMath::Clamp(InExposure, <span class="number">-10.f</span>, <span class="number">10.f</span>);</span><br><span class="line">        bApplyExposureBias = <span class="literal">true</span>; <span class="comment">// 启用曝光补偿</span></span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">GetExposure</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> ManualExposureBias; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFocalLength</span><span class="params">(<span class="type">float</span> InFocalLength)</span></span><br><span class="line">    &#123;</span><br><span class="line">        FocalLength = FMath::Max(<span class="number">1.f</span>, InFocalLength);</span><br><span class="line">        <span class="comment">// 使用默认胶片宽度36mm将焦距映射到FOV</span></span><br><span class="line">        <span class="type">const</span> <span class="type">float</span> SensorWidth = <span class="number">36.0f</span>; <span class="comment">// mm</span></span><br><span class="line">        <span class="type">const</span> <span class="type">float</span> HFOVRadians = <span class="number">2.f</span> * FMath::Atan((SensorWidth * <span class="number">0.5f</span>) / FocalLength);</span><br><span class="line">        SetFOV(FMath::RadiansToDegrees(HFOVRadians));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">GetFocalLength</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> FocalLength; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetAperture</span><span class="params">(<span class="type">float</span> InAperture)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Aperture = FMath::Clamp(InAperture, <span class="number">0.7f</span>, <span class="number">32.f</span>);</span><br><span class="line">        bApplyDOF = <span class="literal">true</span>; <span class="comment">// 启用景深覆盖</span></span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">GetAperture</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> Aperture; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFocusDistance</span><span class="params">(<span class="type">float</span> InDistance)</span></span><br><span class="line">    &#123;</span><br><span class="line">        FocusDistance = FMath::Max(<span class="number">1.f</span>, InDistance);</span><br><span class="line">        bApplyDOF = <span class="literal">true</span>;</span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">GetFocusDistance</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> FocusDistance; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从外部视口复制相机参数</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetCameraFrom</span><span class="params">(<span class="type">const</span> FVector&amp; InLoc, <span class="type">const</span> FRotator&amp; InRot, <span class="type">float</span> InFOV, <span class="type">float</span> InOrthoWidth, <span class="type">bool</span> bInIsOrtho)</span></span><br><span class="line">    &#123;</span><br><span class="line">        SetViewLocation(InLoc);</span><br><span class="line">        SetViewRotation(InRot);</span><br><span class="line">        <span class="keyword">if</span> (bInIsOrtho)</span><br><span class="line">        &#123;</span><br><span class="line">            SetViewportType(LVT_OrthoFreelook);</span><br><span class="line">            SetOrthoZoom(InOrthoWidth);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            SetViewportType(LVT_Perspective);</span><br><span class="line">            ViewFOV = InFOV;</span><br><span class="line">        &#125;</span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual <span class="type">void</span> <span class="title function_">Tick</span><span class="params">(<span class="type">float</span> DeltaSeconds)</span> override</span><br><span class="line">    &#123;</span><br><span class="line">        FEditorViewportClient::Tick(DeltaSeconds);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!bVirtualCamMove &amp;&amp; GEditor)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (FEditorViewportClient* VC : GEditor-&gt;GetAllViewportClients())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (VC &amp;&amp; VC-&gt;IsPerspective())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">const</span> FVector Loc = VC-&gt;GetViewLocation();</span><br><span class="line">                    <span class="type">const</span> FRotator Rot = VC-&gt;GetViewRotation();</span><br><span class="line">                    <span class="type">const</span> <span class="type">bool</span> bIsOrtho = VC-&gt;IsOrtho();</span><br><span class="line">                    <span class="type">const</span> <span class="type">float</span> FOV = ViewFOV; <span class="comment">// 使用当前FOV</span></span><br><span class="line">                    <span class="type">const</span> <span class="type">float</span> OrthoWidth = <span class="number">2048.f</span>;</span><br><span class="line">                    SetCameraFrom(Loc, Rot, FOV, OrthoWidth, bIsOrtho);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bVirtualCamMove)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">float</span> Speed = <span class="number">15.f</span>;</span><br><span class="line">            FRotator R = GetViewRotation();</span><br><span class="line">            R.Yaw += Speed * DeltaSeconds;</span><br><span class="line">            SetViewRotation(R);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 覆盖后处理参数：仅在需要时设置曝光补偿/景深，尽量保持与编辑器视口一致</span></span><br><span class="line">    virtual <span class="type">void</span> <span class="title function_">OverridePostProcessSettings</span><span class="params">(FSceneView&amp; View)</span> override</span><br><span class="line">    &#123;</span><br><span class="line">        FEditorViewportClient::OverridePostProcessSettings(View);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bApplyExposureBias)</span><br><span class="line">        &#123;</span><br><span class="line">            View.FinalPostProcessSettings.bOverride_AutoExposureBias = <span class="literal">true</span>;</span><br><span class="line">            View.FinalPostProcessSettings.AutoExposureBias = ManualExposureBias;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bApplyDOF)</span><br><span class="line">        &#123;</span><br><span class="line">            View.FinalPostProcessSettings.bOverride_DepthOfFieldFstop = <span class="literal">true</span>;</span><br><span class="line">            View.FinalPostProcessSettings.DepthOfFieldFstop = Aperture;</span><br><span class="line">            View.FinalPostProcessSettings.bOverride_DepthOfFieldFocalDistance = <span class="literal">true</span>;</span><br><span class="line">            View.FinalPostProcessSettings.DepthOfFieldFocalDistance = FocusDistance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XR状态查询</span></span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsShowKeyed</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> bShowKeyed; &#125;</span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsVirtualCamMove</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> bVirtualCamMove; &#125;</span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsMixedRealityBlend</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> bMixedRealityBlend; &#125;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    <span class="type">bool</span> bShowKeyed = <span class="literal">false</span>; <span class="comment">// 是否显示抠像</span></span><br><span class="line">    <span class="type">bool</span> bVirtualCamMove = <span class="literal">false</span>; <span class="comment">// 是否虚拟相机运动</span></span><br><span class="line">    <span class="type">bool</span> bMixedRealityBlend = <span class="literal">true</span>; <span class="comment">// 是否虚实融合</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 相机可调参数</span></span><br><span class="line">    <span class="type">float</span> ManualExposureBias = <span class="number">0.f</span>; <span class="comment">// 曝光补偿（log2EV）</span></span><br><span class="line">    <span class="type">bool</span>  bApplyExposureBias = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">float</span> FocalLength = <span class="number">35.f</span>;   <span class="comment">// 焦距（mm）</span></span><br><span class="line">    <span class="type">float</span> Aperture = <span class="number">2.8f</span>;      <span class="comment">// 光圈（F）</span></span><br><span class="line">    <span class="type">float</span> FocusDistance = <span class="number">1000.f</span>; <span class="comment">// 对焦距离</span></span><br><span class="line">    <span class="type">bool</span>  bApplyDOF = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="TcgXR-Build-cs"><a href="#TcgXR-Build-cs" class="headerlink" title="TcgXR.Build.cs"></a>TcgXR.Build.cs</h3><p><strong>文件路径</strong>: <code>TcgXR.Build.cs</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnrealBuildTool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TcgXR</span> : <span class="title">ModuleRules</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">TcgXR</span>(<span class="params">ReadOnlyTargetRules Target</span>) : <span class="title">base</span>(<span class="params">Target</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		PCHUsage = ModuleRules.PCHUsageMode.UseExplicitOrSharedPCHs;</span><br><span class="line">		</span><br><span class="line">		PublicIncludePaths.AddRange(</span><br><span class="line">			<span class="keyword">new</span> <span class="built_in">string</span>[] &#123;</span><br><span class="line">				<span class="comment">// ... add public include paths required here ...</span></span><br><span class="line">			&#125;</span><br><span class="line">			);</span><br><span class="line">				</span><br><span class="line">		</span><br><span class="line">		PrivateIncludePaths.AddRange(</span><br><span class="line">			<span class="keyword">new</span> <span class="built_in">string</span>[] &#123;</span><br><span class="line">				<span class="comment">// ... add other private include paths required here ...</span></span><br><span class="line">			&#125;</span><br><span class="line">			);</span><br><span class="line">			</span><br><span class="line">		</span><br><span class="line">		PublicDependencyModuleNames.AddRange(</span><br><span class="line">			<span class="keyword">new</span> <span class="built_in">string</span>[]</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="string">&quot;Core&quot;</span>,</span><br><span class="line">				<span class="comment">// ... add other public dependencies that you statically link with here ...</span></span><br><span class="line">			&#125;</span><br><span class="line">			);</span><br><span class="line">			</span><br><span class="line">		</span><br><span class="line">		PrivateDependencyModuleNames.AddRange(</span><br><span class="line">			<span class="keyword">new</span> <span class="built_in">string</span>[]</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="string">&quot;Projects&quot;</span>,</span><br><span class="line">				<span class="string">&quot;InputCore&quot;</span>,</span><br><span class="line">				<span class="string">&quot;EditorFramework&quot;</span>,</span><br><span class="line">				<span class="string">&quot;UnrealEd&quot;</span>,</span><br><span class="line">				<span class="string">&quot;ToolMenus&quot;</span>,</span><br><span class="line">				<span class="string">&quot;CoreUObject&quot;</span>,</span><br><span class="line">				<span class="string">&quot;Engine&quot;</span>,</span><br><span class="line">				<span class="string">&quot;Slate&quot;</span>,</span><br><span class="line">				<span class="string">&quot;SlateCore&quot;</span>,</span><br><span class="line">				<span class="string">&quot;AppFramework&quot;</span>,</span><br><span class="line">				<span class="string">&quot;LevelEditor&quot;</span>,</span><br><span class="line">				<span class="string">&quot;CinematicCamera&quot;</span>, <span class="comment">// 使用电影相机</span></span><br><span class="line">				<span class="comment">// ... add private dependencies that you statically link with here ...	</span></span><br><span class="line">			&#125;</span><br><span class="line">			);</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		DynamicallyLoadedModuleNames.AddRange(</span><br><span class="line">			<span class="keyword">new</span> <span class="built_in">string</span>[]</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// ... add any modules that your module loads dynamically here ...</span></span><br><span class="line">			&#125;</span><br><span class="line">			);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV17NQVYBEBi/">最基础概览视频</a>:我看着这个视频作为最初的入门</li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=vI_b2OO4yZE">Aximmetry Eye Camera Tracking Device</a>：里面还提及了如何解决TimeCode的问题</li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=dugtm2TlY44">Virtual Production demo with Aximmetry Eye mobile app</a>：这里面提及了Iphone数据流送回来的方案</li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=tm_5o6eRcpM">Aximmetry Eye VIrtual Camera Tracker</a>：里面有提及标定的事情，也有提及（可能）使用WIFI6能够实现无线传输。</li>
</ol>


            <!-- Tags -->
            


<div class="tags">
    <a href="/tags/XR/">XR</a> <a href="/tags/Aximmetry/">Aximmetry</a>
</div>



            <!-- Comments -->
            <div>
                




            </div>
        </div><!-- end content -->
    </section>

    <!-- Table of Contents will be generated by toc-collapse.js -->

</section><!-- end main -->

<!-- After footer scripts -->

<!-- jQuery -->

<script src="/js/jquery.js"></script>


<!-- Custom Code -->

<script src="/js/main.js"></script>


<script src="/js/article-collapse.js"></script>


<script src="/js/toc-collapse.js"></script>


<script src="/js/shadertoy-embed.js"></script>


<script src="/js/image-zoom.js"></script>


<!-- Gallery -->
<script src="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Code Block Expansion Script -->
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Initialize code block expansion
    function initCodeBlockExpansion() {
        const codeBlocks = document.querySelectorAll('figure.highlight');
        
        codeBlocks.forEach(function(codeBlock) {
            // Skip if already processed
            if (codeBlock.closest('.code-block-container')) return;
            
            // Remove table structure and keep only code content
            const table = codeBlock.querySelector('table');
            if (table) {
                const codeCell = table.querySelector('td.code');
                if (codeCell) {
                    // Create a new pre element with code content
                    const newPre = document.createElement('pre');
                    newPre.className = 'code';
                    newPre.innerHTML = codeCell.innerHTML;
                    
                    // Replace table with pre element
                    codeBlock.innerHTML = '';
                    codeBlock.appendChild(newPre);
                }
            }
            
            // Get the code content height
            const codeContent = codeBlock.querySelector('pre.code');
            if (!codeContent) return;
            
            const actualHeight = codeContent.scrollHeight;
            const maxHeight = 400; // Same as CSS max-height
            
            // Create button container and copy button for all code blocks
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'code-buttons';
            
            // Create copy button (for all code blocks)
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-code-button';
            copyButton.textContent = '复制代码';
            copyButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                copyCodeToClipboard(codeContent, copyButton);
            });
            buttonsContainer.appendChild(copyButton);

            // Only add expansion if content is taller than max height
            if (actualHeight > maxHeight) {
                // Wrap the code block in a container
                const container = document.createElement('div');
                container.className = 'code-block-container collapsed';
                codeBlock.parentNode.insertBefore(container, codeBlock);
                container.appendChild(codeBlock);

                // Create expand button
                const expandButton = document.createElement('button');
                expandButton.className = 'expand-button';
                expandButton.textContent = '展开代码';
                buttonsContainer.appendChild(expandButton);

                // Add buttons container to the wrapper
                container.appendChild(buttonsContainer);

                // Add click handler
                expandButton.addEventListener('click', function() {
                    if (container.classList.contains('collapsed')) {
                        // Expand to full screen
                        showFullscreenCode(codeBlock, expandButton);
                    }
                });
            } else {
                // For code blocks that don't need expansion, just add copy button
                const container = document.createElement('div');
                container.className = 'code-block-container';
                codeBlock.parentNode.insertBefore(container, codeBlock);
                container.appendChild(codeBlock);
                container.appendChild(buttonsContainer);
            }
        });
    }
    
    function showFullscreenCode(codeBlock, button) {
        // Create fullscreen modal
        const modal = document.createElement('div');
        modal.className = 'code-fullscreen-modal active';
        
        const content = document.createElement('div');
        content.className = 'code-fullscreen-content';
        
        // Clone the code block and remove any expansion restrictions
        const clonedBlock = codeBlock.cloneNode(true);
        clonedBlock.style.height = '100%';
        clonedBlock.style.maxHeight = '100%';
        clonedBlock.style.flex = '1 1 auto';

        // Remove any buttons that don't make sense inside the modal
        const extraneousControls = clonedBlock.querySelectorAll('.code-buttons, .copy-code-button, .expand-button');
        extraneousControls.forEach(function(el) {
            el.parentNode && el.parentNode.removeChild(el);
        });
        
        // Find and update the pre.code element in cloned block
        const clonedPre = clonedBlock.querySelector('pre.code');
        if (clonedPre) {
            clonedPre.style.height = '100%';
            clonedPre.style.maxHeight = '100%';
            clonedPre.style.overflowY = 'auto';
            clonedPre.style.overflowX = 'auto';
            clonedPre.style.boxSizing = 'border-box';
            clonedPre.scrollTop = 0;

            const innerPre = clonedPre.querySelector('pre');
            if (innerPre) {
                innerPre.style.display = 'block';
                innerPre.style.margin = '0';
                innerPre.style.padding = '0';
                innerPre.style.minWidth = '100%';
            }
        }
        
        content.appendChild(clonedBlock);
        
        // Create close button
        const closeButton = document.createElement('button');
        closeButton.className = 'close-fullscreen';
        closeButton.textContent = '关闭';
        content.appendChild(closeButton);
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // Prevent body scrolling
        document.body.style.overflow = 'hidden';
        
        // Close handlers
        function closeModal() {
            document.body.removeChild(modal);
            document.body.style.overflow = '';
        }
        
        closeButton.addEventListener('click', closeModal);
        
        // Close on backdrop click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // Close on escape key
        function handleKeydown(e) {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', handleKeydown);
            }
        }
        document.addEventListener('keydown', handleKeydown);
    }
    
    // Function to copy code to clipboard
    function copyCodeToClipboard(codeElement, button) {
        let code = codeElement.textContent || codeElement.innerText;
        
        // Use modern Clipboard API if available
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(code).then(function() {
                showCopySuccess(button);
            }).catch(function(err) {
                console.error('复制失败:', err);
                fallbackCopy(code, button);
            });
        } else {
            fallbackCopy(code, button);
        }
    }

    // Fallback copy method for older browsers
    function fallbackCopy(text, button) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.top = '0';
        textArea.style.left = '0';
        textArea.style.width = '2em';
        textArea.style.height = '2em';
        textArea.style.padding = '0';
        textArea.style.border = 'none';
        textArea.style.outline = 'none';
        textArea.style.boxShadow = 'none';
        textArea.style.background = 'transparent';
        
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopySuccess(button);
            }
        } catch (err) {
            console.error('复制失败:', err);
        }
        
        document.body.removeChild(textArea);
    }

    // Show copy success feedback
    function showCopySuccess(button) {
        const originalText = button.textContent;
        button.classList.add('copied');
        button.textContent = '已复制 ✓';
        
        setTimeout(function() {
            button.classList.remove('copied');
            button.textContent = originalText;
        }, 2000);
    }

    // Initialize on page load
    initCodeBlockExpansion();
    
    // Re-initialize if new content is loaded (for SPA-like behavior)
    const observer = new MutationObserver(function(mutations) {
        let needsReinit = false;
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length > 0) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && (node.matches('figure.highlight') || node.querySelector('figure.highlight'))) {
                        needsReinit = true;
                    }
                });
            }
        });
        if (needsReinit) {
            setTimeout(initCodeBlockExpansion, 100);
        }
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
});
</script>

<!-- Mermaid Initialization -->
<script type="text/javascript">
    // Wait for document ready
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof mermaid !== 'undefined') {
            // Initialize with proper configuration
            mermaid.initialize({ 
                startOnLoad: false,
                theme: 'default',
                securityLevel: 'loose'
            });
            
            // Find and process mermaid code blocks
            const codeBlocks = document.querySelectorAll('figure.highlight.plaintext .code');
            
            codeBlocks.forEach((codeElement, index) => {
                let code = codeElement.textContent || codeElement.innerText;
                
                // Check if it's a mermaid diagram
                if (code.trim().match(/^(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram|journey|pie|gitgraph|erDiagram)/)) {
                    // Critical fix: Remove ALL leading/trailing whitespace and newlines
                    code = code.trim().replace(/^\s+|\s+$/g, '');
                    
                    // Create mermaid div
                    const mermaidDiv = document.createElement('div');
                    mermaidDiv.className = 'mermaid';
                    // Set the cleaned code without any extra whitespace
                    mermaidDiv.textContent = code;
                    mermaidDiv.id = 'mermaid-diagram-' + index;
                    
                    // Replace the entire figure element
                    const figureElement = codeElement.closest('figure');
                    if (figureElement) {
                        figureElement.parentNode.replaceChild(mermaidDiv, figureElement);
                    }
                }
            });
            
            // Initialize mermaid diagrams with explicit selector
            setTimeout(() => {
                mermaid.init(undefined, document.querySelectorAll('.mermaid'));
            }, 100);
        }
    });
</script>

<!-- ShaderToy Placeholder Processing -->
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for other scripts to load
    setTimeout(function() {
        // Find all elements with shadertoy-placeholder class
        const elements = document.querySelectorAll('.shadertoy-placeholder[data-id]');
        
        console.log('Found shadertoy-placeholder elements:', elements.length);

        elements.forEach(element => {
            const shaderID = element.getAttribute('data-id');
            console.log('Processing shadertoy-placeholder element with ID:', shaderID);
            
            if (shaderID) {
                // Create iframe container
                const container = document.createElement('div');
                container.style.cssText = `
                    position: relative;
                    width: 100%;
                    height: 400px;
                    margin: 20px 0;
                    border: 2px solid #bfbbbb;
                    border-radius: 8px;
                    overflow: hidden;
                    background-color: #f6f6f6;
                `;

                // Create iframe
                const iframe = document.createElement('iframe');
                iframe.src = `https://www.shadertoy.com/embed/${shaderID}?gui=true&t=10&paused=false&muted=false`;
                iframe.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    border: none;
                `;
                iframe.allowFullscreen = true;
                iframe.loading = 'lazy';

                container.appendChild(iframe);
                element.parentNode.insertBefore(container, element);
                element.parentNode.removeChild(element);
            }
        });
    }, 1000); // Wait a full second for everything to load
});
</script>

<!-- Disqus Comments -->


</body>

</html>