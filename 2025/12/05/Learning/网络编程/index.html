<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />

    <!--Description-->
    
        <meta name="description" content="12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970SOCKET RemoteCaptur">
    

    <!--Author-->
    
        <meta name="author" content="Eugene Hsuan">
    

    <!--Open Graph Title-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Eugene&#39;s Page"/>

    <!--Page Cover-->
    
        <meta property="og:image" content=""/>
    

    <!-- Title -->
    
    <title>Eugene&#39;s Page</title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/reset.css">

    
<link rel="stylesheet" href="/css/main.css">

    
<link rel="stylesheet" href="/css/table.css">

    
<link rel="stylesheet" href="/css/image-zoom.css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Mermaid Support -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.4.3/dist/mermaid.min.js"></script>

    <!-- Google Analytics -->
    


    <!--Favicon-->
    
        <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    

    
        <link rel="alternate" type="application/atom+xml" title="Eugene&#39;s Page" href="/atom.xml">
    
        <link rel="alternate" type="application/rss+xml" title="Eugene&#39;s Page" href="/rss.xml">
    

<meta name="generator" content="Hexo 7.3.0"></head>


<body class="layout-post path-2025-12-05-Learning-">

<!-- Menu -->
<!-- Navigation -->
<header>
    <div class="logo">
        <a href="/">Eugene's Page</a>
        <div class="subtitle"></div>
        <div class="description"></div>
    </div><!-- end logo -->

    <div id="menu_icon"></div>
    <nav>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives">Archives</a>
            </li>
            
            <li>
                <a href="/about">About</a>
            </li>
            
        </ul>
    </nav><!-- end navigation menu -->

    <div class="footer clearfix">
        <ul class="social clearfix">
            
                <li><a href="https://space.bilibili.com/29291963" class="behance" target="_blank" data-title="Bilibili"></a></li>
            
            
                <li><a href="https://www.instagram.com/yu_chinghsuan?igsh=Mm54ajloc3c1NW5m&utm_source=qr" class="instagram" target="_blank" data-title="Instagram"></a></li>
            
            
                <li><a href="https://www.douban.com/people/Youdrew_Xuan/" class="dribble" target="_blank" data-title="Douban"></a></li>
            
            
                <li><a href="mailto:youdrewxuan@icloud.com" class="google" target="_blank" data-title="Email"></a></li>
            
            
                <li><a href="/rss.xml" class="rss" target="_blank" data-title="RSS"></a></li>
            
        </ul><!-- end social -->

        <div class="rights">
            <p>Copyright © 2025 Eugene Hsuan</p>
            <p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></p>
            <p>Modified based on <a href="https://github.com/klugjo/hexo-theme-magnetic" target="_blank">Magnetic</a> theme</p>
        </div><!-- end rights -->
    </div ><!-- end footer -->
</header><!-- end header -->


<!-- Main Content -->
<section class="main clearfix">

    <section class="top" style="background: url('/img/default_cover_detail.jpg');">
        <div class="wrapper content_header clearfix">
            

<div class="work_nav">

    <ul class="btn clearfix">
        
        <li><a class="previous disabled"></a></li>
        
        <li><a href="/" class="grid" data-title="Portfolio"></a></li>
        
        <li><a href="/2025/12/04/Learning/UnrealDebug/" class="next" data-title="Untitled"></a></li>
        
    </ul>

</div><!-- end work_nav -->
            <h1 class="title">Untitled</h1>
        </div>
    </section><!-- end top -->

    <section class="wrapper">
        <div class="content">

            <!-- Gallery -->
            

            <!-- Content -->
            <p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205123239125.png" alt="image-20251205123239125"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SOCKET <span class="title">RemoteCaptury::openTcpSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 01 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line">    <span class="comment">// 函数通过调用 socket 创建一个套接字。如果创建失败（返回 INVALID_SOCKET），函数直接返回错误状态</span></span><br><span class="line">    SOCKET sok = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (sok == INVALID_SOCKET)</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 02 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line">    <span class="comment">// 如果 localAddress 的端口号不为 0，函数会尝试将套接字绑定到指定的本地地址。如果绑定失败，同样关闭套接字并返回错误</span></span><br><span class="line">    <span class="keyword">if</span> (localAddress.sin_port != <span class="number">0</span> &amp;&amp; <span class="built_in">bind</span>(sok, (sockaddr*)&amp;localAddress, <span class="built_in">sizeof</span>(localAddress)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(sok);</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 03 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line">    <span class="comment">// 1. 先设成非阻塞</span></span><br><span class="line">    u_long NonBlocking = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ioctlsocket</span>(sok, FIONBIO, &amp;NonBlocking) == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(sok);</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 尝试发起 connect</span></span><br><span class="line">    <span class="type">int</span> ConnectResult = ::<span class="built_in">connect</span>(sok, (sockaddr*)&amp;remoteAddress, <span class="built_in">sizeof</span>(remoteAddress));</span><br><span class="line">    <span class="keyword">if</span> (ConnectResult == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="type">int</span> Err = <span class="built_in">WSAGetLastError</span>();</span><br><span class="line">        <span class="keyword">if</span> (Err != WSAEWOULDBLOCK &amp;&amp; Err != WSAEINPROGRESS &amp;&amp; Err != WSAEALREADY) &#123;</span><br><span class="line">            <span class="comment">// 真错误，直接失败</span></span><br><span class="line">            <span class="built_in">closesocket</span>(sok);</span><br><span class="line">            <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 连接正在进行中，用 select 等待一小段时间</span></span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> MaxWaitMillis = <span class="number">1000</span>; <span class="comment">// 1 秒上限</span></span><br><span class="line">        fd_set WriteSet;</span><br><span class="line">        <span class="built_in">FD_ZERO</span>(&amp;WriteSet);</span><br><span class="line">        <span class="built_in">FD_SET</span>(sok, &amp;WriteSet);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">timeval</span> Tv;</span><br><span class="line">        Tv.tv_sec = MaxWaitMillis / <span class="number">1000</span>;</span><br><span class="line">        Tv.tv_usec = (MaxWaitMillis % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> Sel = <span class="built_in">select</span>((<span class="type">int</span>)(sok + <span class="number">1</span>), <span class="literal">nullptr</span>, &amp;WriteSet, <span class="literal">nullptr</span>, &amp;Tv);</span><br><span class="line">        <span class="keyword">if</span> (Sel &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 超时或 select 出错，都当失败</span></span><br><span class="line">            <span class="built_in">closesocket</span>(sok);</span><br><span class="line">            <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. select 说 socket 可写了，用 SO_ERROR 再确认一次</span></span><br><span class="line">        <span class="type">int</span> so_error = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> optLen = <span class="built_in">sizeof</span>(so_error);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">getsockopt</span>(sok, SOL_SOCKET, SO_ERROR, (<span class="type">char</span>*)&amp;so_error, &amp;optLen) == SOCKET_ERROR || so_error != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">closesocket</span>(sok);</span><br><span class="line">            <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 走到这说明 connect 已经完成了，可以恢复成阻塞模式</span></span><br><span class="line">    u_long Blocking = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">ioctlsocket</span>(sok, FIONBIO, &amp;Blocking);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 04 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setSocketTimeout</span>(sok, <span class="number">500</span>);</span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 05 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sok;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数实现了客户端创建socket，且用非阻塞模式connect。</p>
<p>非阻塞是“通过修改套接字模式”实现的——代码在 socket() 之后、connect() 之前把套接字设为非阻塞，因此 connect() 就是在非阻塞模式下执行的；连接完成后再把套接字恢复成阻塞。</p>
<ul>
<li><p>服务端也会作为客户端的角色去连接别的服务（第三服务），比如<strong>MySQL</strong></p>
</li>
<li><p>FD：这里的 fd 就是「文件描述符」（Unix 上）或「socket handle &#x2F; SOCKET」（Windows 上），本质是操作系统给套接字分配的一个句柄&#x2F;索引，用来在用户态代码和内核 TCP 实现之间标识该连接。</p>
</li>
</ul>
<h1 id="网络编程关注的问题"><a href="#网络编程关注的问题" class="headerlink" title="网络编程关注的问题"></a>网络编程关注的问题</h1><ul>
<li>连接的建立<ol>
<li>接收客户端的连接</li>
<li>作为客户端连接第三方服务</li>
</ol>
</li>
<li>连接的断开<ol>
<li>主动断开连接</li>
<li>被动断开连接</li>
</ol>
</li>
<li>消息的到达<ol>
<li>read 直接去检测消息是否到达</li>
<li><strong>io 多路复用</strong>去检测消息是否到达，read 函数</li>
</ol>
</li>
<li>消息发送完毕<ol>
<li>write 直接去检测是否可以将数据发送</li>
<li><strong>io 多路复用</strong>去检测，write 函数将数据发送出去</li>
</ol>
</li>
</ul>
<p>主要卡的说就是这个read和write</p>
<p>这里多路复用就是是否阻塞。阻塞就是卡网络线程。</p>
<p><code>ioctlsocket(sok, FIONBIO, &amp;NonBlocking)</code>这个就是设置是否在阻塞。</p>
<p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205142827661.png" alt="image-20251205142827661"></p>
<p>这张图是前面大图的绿色部分。需要读取一个临时的传输buffer。</p>
<p>其中buffer的部分是否包含东西，如果不包含东西（读的时候）&#x2F;或者buffer满了（写的时候），就会<strong>阻塞读取</strong>。这个线程就卡在这里。</p>
<p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205144248299.png" alt="image-20251205144248299"></p>
<p>在阻塞模型中（原来的代码）。</p>
<p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205144319439.png" alt="image-20251205144319439"></p>
<h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Av41187M8/">https://www.bilibili.com/video/BV1Av41187M8/</a></p>


            <!-- Tags -->
            


<div class="tags">
    
</div>



            <!-- Comments -->
            <div>
                




            </div>
        </div><!-- end content -->
    </section>

    <!-- Table of Contents will be generated by toc-collapse.js -->

</section><!-- end main -->

<script>
	window.UI_LANG = {"en":{"menu":{"home":"Home","archives":"Archives","about":"About"},"footer":{"copyright":"Copyright © %year% %author%","powered":"Powered by %hexo%","modified":"Modified based on %theme%"},"buttons":{"language":"EN / 中"}},"zh":{"menu":{"home":"首页","archives":"归档","about":"关于"},"footer":{"copyright":"版权 © %year% %author%","powered":"由 %hexo% 驱动","modified":"基于 %theme% 主题定制"},"buttons":{"language":"中 / EN"}}};
	window.UI_DEFAULT_LANG = 'en';
</script>

<!-- After footer scripts -->

<!-- jQuery -->

<script src="/js/jquery.js"></script>


<!-- Custom Code -->

<script src="/js/main.js"></script>


<script src="/js/article-collapse.js"></script>


<script src="/js/toc-collapse.js"></script>


<script src="/js/shadertoy-embed.js"></script>


<script src="/js/image-zoom.js"></script>


<script src="/js/lang-toggle.js"></script>


<!-- Gallery -->
<script src="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Code Block Expansion Script -->
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Initialize code block expansion
    function initCodeBlockExpansion() {
        const codeBlocks = document.querySelectorAll('figure.highlight');
        
        codeBlocks.forEach(function(codeBlock) {
            // Skip if already processed
            if (codeBlock.closest('.code-block-container')) return;
            
            // Remove table structure and keep only code content
            const table = codeBlock.querySelector('table');
            if (table) {
                const codeCell = table.querySelector('td.code');
                if (codeCell) {
                    // Create a new pre element with code content
                    const newPre = document.createElement('pre');
                    newPre.className = 'code';
                    newPre.innerHTML = codeCell.innerHTML;
                    
                    // Replace table with pre element
                    codeBlock.innerHTML = '';
                    codeBlock.appendChild(newPre);
                }
            }
            
            // Get the code content height
            const codeContent = codeBlock.querySelector('pre.code');
            if (!codeContent) return;
            
            const actualHeight = codeContent.scrollHeight;
            const maxHeight = 400; // Same as CSS max-height
            
            // Create button container and copy button for all code blocks
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'code-buttons';
            
            // Create copy button (for all code blocks)
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-code-button';
            copyButton.textContent = '复制代码';
            copyButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                copyCodeToClipboard(codeContent, copyButton);
            });
            buttonsContainer.appendChild(copyButton);

            // Only add expansion if content is taller than max height
            if (actualHeight > maxHeight) {
                // Wrap the code block in a container
                const container = document.createElement('div');
                container.className = 'code-block-container collapsed';
                codeBlock.parentNode.insertBefore(container, codeBlock);
                container.appendChild(codeBlock);

                // Create expand button
                const expandButton = document.createElement('button');
                expandButton.className = 'expand-button';
                expandButton.textContent = '展开代码';
                buttonsContainer.appendChild(expandButton);

                // Add buttons container to the wrapper
                container.appendChild(buttonsContainer);

                // Add click handler
                expandButton.addEventListener('click', function() {
                    if (container.classList.contains('collapsed')) {
                        // Expand to full screen
                        showFullscreenCode(codeBlock, expandButton);
                    }
                });
            } else {
                // For code blocks that don't need expansion, just add copy button
                const container = document.createElement('div');
                container.className = 'code-block-container';
                codeBlock.parentNode.insertBefore(container, codeBlock);
                container.appendChild(codeBlock);
                container.appendChild(buttonsContainer);
            }
        });
    }
    
    function showFullscreenCode(codeBlock, button) {
        // Create fullscreen modal
        const modal = document.createElement('div');
        modal.className = 'code-fullscreen-modal active';
        
        const content = document.createElement('div');
        content.className = 'code-fullscreen-content';
        
        // Clone the closest code container (includes wrapper if present)
        const sourceContainer = codeBlock.closest('.code-block-container');
        const clonedBlock = (sourceContainer || codeBlock).cloneNode(true);

        // Remove any buttons that don't make sense inside the modal
        const extraneousControls = clonedBlock.querySelectorAll('.code-buttons, .copy-code-button, .expand-button');
        extraneousControls.forEach(function(el) {
            el.parentNode && el.parentNode.removeChild(el);
        });
        
        // Ensure wrapper/container fills the modal and isn't marked as collapsed
        const wrapper = clonedBlock.classList.contains('code-block-container')
            ? clonedBlock
            : clonedBlock.querySelector('.code-block-container');
        if (wrapper) {
            wrapper.classList.remove('collapsed');
            wrapper.style.margin = '0';
        }
        
        // Find and update the pre.code element in cloned block
        const clonedPre = (wrapper || clonedBlock).querySelector('pre.code');
        if (clonedPre) {
            clonedPre.scrollTop = 0;
        }

        content.appendChild(clonedBlock);
        
        // Create close button
        const closeButton = document.createElement('button');
        closeButton.className = 'close-fullscreen';
        closeButton.textContent = '关闭';
        content.appendChild(closeButton);
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // Prevent body scrolling
        document.body.style.overflow = 'hidden';
        
        // Close handlers
        function closeModal() {
            document.body.removeChild(modal);
            document.body.style.overflow = '';
        }
        
        closeButton.addEventListener('click', closeModal);
        
        // Close on backdrop click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // Close on escape key
        function handleKeydown(e) {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', handleKeydown);
            }
        }
        document.addEventListener('keydown', handleKeydown);
    }
    
    // Function to copy code to clipboard
    function copyCodeToClipboard(codeElement, button) {
        let code = codeElement.textContent || codeElement.innerText;
        
        // Use modern Clipboard API if available
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(code).then(function() {
                showCopySuccess(button);
            }).catch(function(err) {
                console.error('复制失败:', err);
                fallbackCopy(code, button);
            });
        } else {
            fallbackCopy(code, button);
        }
    }

    // Fallback copy method for older browsers
    function fallbackCopy(text, button) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.top = '0';
        textArea.style.left = '0';
        textArea.style.width = '2em';
        textArea.style.height = '2em';
        textArea.style.padding = '0';
        textArea.style.border = 'none';
        textArea.style.outline = 'none';
        textArea.style.boxShadow = 'none';
        textArea.style.background = 'transparent';
        
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopySuccess(button);
            }
        } catch (err) {
            console.error('复制失败:', err);
        }
        
        document.body.removeChild(textArea);
    }

    // Show copy success feedback
    function showCopySuccess(button) {
        const originalText = button.textContent;
        button.classList.add('copied');
        button.textContent = '已复制 ✓';
        
        setTimeout(function() {
            button.classList.remove('copied');
            button.textContent = originalText;
        }, 2000);
    }

    // Initialize on page load
    initCodeBlockExpansion();
    
    // Re-initialize if new content is loaded (for SPA-like behavior)
    const observer = new MutationObserver(function(mutations) {
        let needsReinit = false;
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length > 0) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && (node.matches('figure.highlight') || node.querySelector('figure.highlight'))) {
                        needsReinit = true;
                    }
                });
            }
        });
        if (needsReinit) {
            setTimeout(initCodeBlockExpansion, 100);
        }
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
});
</script>

<!-- Mermaid Initialization -->
<script type="text/javascript">
    // Wait for document ready
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof mermaid !== 'undefined') {
            // Initialize with proper configuration
            mermaid.initialize({ 
                startOnLoad: false,
                theme: 'default',
                securityLevel: 'loose'
            });
            
            // Find and process mermaid code blocks
            const codeBlocks = document.querySelectorAll('figure.highlight.plaintext .code');
            
            codeBlocks.forEach((codeElement, index) => {
                let code = codeElement.textContent || codeElement.innerText;
                
                // Check if it's a mermaid diagram
                if (code.trim().match(/^(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram|journey|pie|gitgraph|erDiagram)/)) {
                    // Critical fix: Remove ALL leading/trailing whitespace and newlines
                    code = code.trim().replace(/^\s+|\s+$/g, '');
                    
                    // Create mermaid div
                    const mermaidDiv = document.createElement('div');
                    mermaidDiv.className = 'mermaid';
                    // Set the cleaned code without any extra whitespace
                    mermaidDiv.textContent = code;
                    mermaidDiv.id = 'mermaid-diagram-' + index;
                    
                    // Replace the entire figure element
                    const figureElement = codeElement.closest('figure');
                    if (figureElement) {
                        figureElement.parentNode.replaceChild(mermaidDiv, figureElement);
                    }
                }
            });
            
            // Initialize mermaid diagrams with explicit selector
            setTimeout(() => {
                mermaid.init(undefined, document.querySelectorAll('.mermaid'));
            }, 100);
        }
    });
</script>

<!-- ShaderToy Placeholder Processing -->
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for other scripts to load
    setTimeout(function() {
        // Find all elements with shadertoy-placeholder class
        const elements = document.querySelectorAll('.shadertoy-placeholder[data-id]');
        
        console.log('Found shadertoy-placeholder elements:', elements.length);

        elements.forEach(element => {
            const shaderID = element.getAttribute('data-id');
            console.log('Processing shadertoy-placeholder element with ID:', shaderID);
            
            if (shaderID) {
                // Create iframe container
                const container = document.createElement('div');
                container.style.cssText = `
                    position: relative;
                    width: 100%;
                    height: 400px;
                    margin: 20px 0;
                    border: 2px solid #bfbbbb;
                    border-radius: 8px;
                    overflow: hidden;
                    background-color: #f6f6f6;
                `;

                // Create iframe
                const iframe = document.createElement('iframe');
                iframe.src = `https://www.shadertoy.com/embed/${shaderID}?gui=true&t=10&paused=false&muted=false`;
                iframe.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    border: none;
                `;
                iframe.allowFullscreen = true;
                iframe.loading = 'lazy';

                container.appendChild(iframe);
                element.parentNode.insertBefore(container, element);
                element.parentNode.removeChild(element);
            }
        });
    }, 1000); // Wait a full second for everything to load
});
</script>

<!-- Disqus Comments -->


</body>

</html>