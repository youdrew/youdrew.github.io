<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Eugene&#39;s Page</title>
    <link>http://example.com/</link>
    
    <atom:link href="http://example.com/rss.xml" rel="self" type="application/rss+xml"/>
    
    <description></description>
    <pubDate>Fri, 05 Dec 2025 06:52:57 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title></title>
      <link>http://example.com/2025/12/05/Learning/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/</link>
      <guid>http://example.com/2025/12/05/Learning/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/</guid>
      <pubDate>Fri, 05 Dec 2025 04:31:03 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;&lt;img src=&quot;C:&#92;Users&#92;Eugene&#92;AppData&#92;Roaming&#92;Typora&#92;typora-user-images&#92;image-20251205123239125.png&quot; alt=&quot;image-20251205123239125&quot;&gt;&lt;/p&gt;
&lt;figu</description>
        
      
      
      
      <content:encoded><![CDATA[<p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205123239125.png" alt="image-20251205123239125"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SOCKET <span class="title">RemoteCaptury::openTcpSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 01 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line">    <span class="comment">// 函数通过调用 socket 创建一个套接字。如果创建失败（返回 INVALID_SOCKET），函数直接返回错误状态</span></span><br><span class="line">    SOCKET sok = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (sok == INVALID_SOCKET)</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 02 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line">    <span class="comment">// 如果 localAddress 的端口号不为 0，函数会尝试将套接字绑定到指定的本地地址。如果绑定失败，同样关闭套接字并返回错误</span></span><br><span class="line">    <span class="keyword">if</span> (localAddress.sin_port != <span class="number">0</span> &amp;&amp; <span class="built_in">bind</span>(sok, (sockaddr*)&amp;localAddress, <span class="built_in">sizeof</span>(localAddress)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(sok);</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 03 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line">    <span class="comment">// 1. 先设成非阻塞</span></span><br><span class="line">    u_long NonBlocking = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ioctlsocket</span>(sok, FIONBIO, &amp;NonBlocking) == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(sok);</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 尝试发起 connect</span></span><br><span class="line">    <span class="type">int</span> ConnectResult = ::<span class="built_in">connect</span>(sok, (sockaddr*)&amp;remoteAddress, <span class="built_in">sizeof</span>(remoteAddress));</span><br><span class="line">    <span class="keyword">if</span> (ConnectResult == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="type">int</span> Err = <span class="built_in">WSAGetLastError</span>();</span><br><span class="line">        <span class="keyword">if</span> (Err != WSAEWOULDBLOCK &amp;&amp; Err != WSAEINPROGRESS &amp;&amp; Err != WSAEALREADY) &#123;</span><br><span class="line">            <span class="comment">// 真错误，直接失败</span></span><br><span class="line">            <span class="built_in">closesocket</span>(sok);</span><br><span class="line">            <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 连接正在进行中，用 select 等待一小段时间</span></span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> MaxWaitMillis = <span class="number">1000</span>; <span class="comment">// 1 秒上限</span></span><br><span class="line">        fd_set WriteSet;</span><br><span class="line">        <span class="built_in">FD_ZERO</span>(&amp;WriteSet);</span><br><span class="line">        <span class="built_in">FD_SET</span>(sok, &amp;WriteSet);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">timeval</span> Tv;</span><br><span class="line">        Tv.tv_sec = MaxWaitMillis / <span class="number">1000</span>;</span><br><span class="line">        Tv.tv_usec = (MaxWaitMillis % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> Sel = <span class="built_in">select</span>((<span class="type">int</span>)(sok + <span class="number">1</span>), <span class="literal">nullptr</span>, &amp;WriteSet, <span class="literal">nullptr</span>, &amp;Tv);</span><br><span class="line">        <span class="keyword">if</span> (Sel &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 超时或 select 出错，都当失败</span></span><br><span class="line">            <span class="built_in">closesocket</span>(sok);</span><br><span class="line">            <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. select 说 socket 可写了，用 SO_ERROR 再确认一次</span></span><br><span class="line">        <span class="type">int</span> so_error = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> optLen = <span class="built_in">sizeof</span>(so_error);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">getsockopt</span>(sok, SOL_SOCKET, SO_ERROR, (<span class="type">char</span>*)&amp;so_error, &amp;optLen) == SOCKET_ERROR || so_error != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">closesocket</span>(sok);</span><br><span class="line">            <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 走到这说明 connect 已经完成了，可以恢复成阻塞模式</span></span><br><span class="line">    u_long Blocking = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">ioctlsocket</span>(sok, FIONBIO, &amp;Blocking);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 04 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setSocketTimeout</span>(sok, <span class="number">500</span>);</span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 05 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sok;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数实现了客户端创建socket，且用非阻塞模式connect。</p><p>非阻塞是“通过修改套接字模式”实现的——代码在 socket() 之后、connect() 之前把套接字设为非阻塞，因此 connect() 就是在非阻塞模式下执行的；连接完成后再把套接字恢复成阻塞。</p><ul><li><p>服务端也会作为客户端的角色去连接别的服务（第三服务），比如<strong>MySQL</strong></p></li><li><p>FD：这里的 fd 就是「文件描述符」（Unix 上）或「socket handle &#x2F; SOCKET」（Windows 上），本质是操作系统给套接字分配的一个句柄&#x2F;索引，用来在用户态代码和内核 TCP 实现之间标识该连接。</p></li></ul><h1 id="网络编程关注的问题"><a href="#网络编程关注的问题" class="headerlink" title="网络编程关注的问题"></a>网络编程关注的问题</h1><ul><li>连接的建立<ol><li>接收客户端的连接</li><li>作为客户端连接第三方服务</li></ol></li><li>连接的断开<ol><li>主动断开连接</li><li>被动断开连接</li></ol></li><li>消息的到达<ol><li>read 直接去检测消息是否到达</li><li><strong>io 多路复用</strong>去检测消息是否到达，read 函数</li></ol></li><li>消息发送完毕<ol><li>write 直接去检测是否可以将数据发送</li><li><strong>io 多路复用</strong>去检测，write 函数将数据发送出去</li></ol></li></ul><p>主要卡的说就是这个read和write</p><p>这里多路复用就是是否阻塞。阻塞就是卡网络线程。</p><p><code>ioctlsocket(sok, FIONBIO, &amp;NonBlocking)</code>这个就是设置是否在阻塞。</p><p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205142827661.png" alt="image-20251205142827661"></p><p>这张图是前面大图的绿色部分。需要读取一个临时的传输buffer。</p><p>其中buffer的部分是否包含东西，如果不包含东西（读的时候）&#x2F;或者buffer满了（写的时候），就会<strong>阻塞读取</strong>。这个线程就卡在这里。</p><p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205144248299.png" alt="image-20251205144248299"></p><p>在阻塞模型中（原来的代码）。</p><p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205144319439.png" alt="image-20251205144319439"></p><h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><p><a href="https://www.bilibili.com/video/BV1Av41187M8/">https://www.bilibili.com/video/BV1Av41187M8/</a></p>]]></content:encoded>
      
      
      
      
      <comments>http://example.com/2025/12/05/Learning/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title></title>
      <link>http://example.com/2025/12/04/Learning/UnrealDebug/</link>
      <guid>http://example.com/2025/12/04/Learning/UnrealDebug/</guid>
      <pubDate>Thu, 04 Dec 2025 08:51:40 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Debug方法和问题记录&quot;&gt;&lt;a href=&quot;#Debug方法和问题记录&quot; class=&quot;headerlink&quot; title=&quot;Debug方法和问题记录&quot;&gt;&lt;/a&gt;Debug方法和问题记录&lt;/h1&gt;&lt;h2 id=&quot;不常见写法&quot;&gt;&lt;a href=&quot;#不常见写法&quot; c</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Debug方法和问题记录"><a href="#Debug方法和问题记录" class="headerlink" title="Debug方法和问题记录"></a>Debug方法和问题记录</h1><h2 id="不常见写法"><a href="#不常见写法" class="headerlink" title="不常见写法"></a>不常见写法</h2><h3 id="DWORD"><a href="#DWORD" class="headerlink" title="DWORD"></a>DWORD</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line"><span class="function">DWORD <span class="title">RemoteCaptury::receiveLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="meta">#<span class="keyword">else</span></span></span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">RemoteCaptury::receiveLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="meta">#<span class="keyword">endif</span></span></span></span><br></pre></td></tr></table></figure><p>因为跨平台和线程 API 要求不同，所以代码用了条件编译把线程入口和成员函数的返回&#x2F;参数类型对齐。<br><u>DWORD 是 Windows API 常用的整型别名（通常为 32-bit 无符号整型）</u>，在 Windows 线程入口函数中作为返回类型表示线程返回码。<br>void* 表示“指向任意类型的指针”，常用作通用参数和返回值（例如 pthread 线程入口用 void* arg 传递实例指针，返回 void* 表示线程返回值）。</p><h2 id="debug方法"><a href="#debug方法" class="headerlink" title="debug方法"></a>debug方法</h2><h3 id="Log标记用时"><a href="#Log标记用时" class="headerlink" title="Log标记用时"></a>Log标记用时</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 统计时间</span></span><br><span class="line"><span class="built_in">UE_LOG</span>(LogCapturyRemote, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;RemoteCaptury::disconnect(): waiting for receiveThread %s&quot;</span>),*(FDateTime::<span class="built_in">Now</span>().<span class="built_in">ToString</span>()));</span><br><span class="line"><span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(STAT_RemoteCapturyWaitReceive);</span><br><span class="line"><span class="built_in">WaitForSingleObject</span>(receiveThread, INFINITE);</span><br><span class="line"><span class="built_in">UE_LOG</span>(LogCapturyRemote, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;RemoteCaptury::disconnect(): receiveThread finished %s&quot;</span>),*(FDateTime::<span class="built_in">Now</span>().<span class="built_in">ToString</span>()));</span><br></pre></td></tr></table></figure><p><u>Warning      LogCapturyRemote          RemoteCaptury::disconnect(): waiting for receiveThread 2025.12.04-16.48.31</u><br>Warning      LogCapturyRemote          RemoteCaptury::receiveLoop() - Reconnect failed, retrying… 2025.12.04-16.48.46<br>Warning      LogCapturyRemote          RemoteCaptury::receiveLoop() - Retrying reconnect… 2025.12.04-16.48.46<br>Warning      LogCapturyRemote          stopping receive loop<br><u>Warning      LogCapturyRemote          RemoteCaptury::disconnect(): receiveThread finished 2025.12.04-16.48.46</u></p>]]></content:encoded>
      
      
      
      
      <comments>http://example.com/2025/12/04/Learning/UnrealDebug/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title></title>
      <link>http://example.com/2025/11/24/Learning/CodeReview/</link>
      <guid>http://example.com/2025/11/24/Learning/CodeReview/</guid>
      <pubDate>Mon, 24 Nov 2025 10:04:38 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;蓝图代码质量检测&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;工具类型&lt;/th&gt;
&lt;th&gt;代表工具 &amp;#x2F; 方案&lt;/th&gt;
&lt;th&gt;核心能力&lt;/th&gt;
&lt;th&gt;适用场景&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;UE 官方内</description>
        
      
      
      
      <content:encoded><![CDATA[<p>蓝图代码质量检测</p><table><thead><tr><th>工具类型</th><th>代表工具 &#x2F; 方案</th><th>核心能力</th><th>适用场景</th></tr></thead><tbody><tr><td>UE 官方内置工具</td><td>Blueprint Analyzer（UE4.26+）</td><td>统计蓝图圈复杂度、节点数量、分支深度，检测冗余节点 &#x2F; 无效连线，支持导出分析报告</td><td>基础复杂度检测，无需额外安装</td></tr><tr><td>UE 社区开源工具</td><td>Blueprint Metrics（GitHub）</td><td>专门针对 UE4&#x2F;5 的蓝图圈复杂度计算工具，可自定义阈值、生成可视化报表，支持批量扫描</td><td>中小型团队，可二次开发集成 CR 流程</td></tr><tr><td>UE 插件市场工具</td><td><a href="https://www.fab.com/zh-cn/listings/10850cb2-be1d-43d2-971d-922c73d218f3">Linter</a> &#x2F; UE Blueprint Quality Checker</td><td>Linter能实现代码规则检测<br /><br />配置圈复杂度 &#x2F; 代码规范阈值，提交蓝图前自动检测，违规则拦截</td><td>快速集成到 UE 编辑器工作流</td></tr><tr><td>企业级工业化工具链</td><td>Epic Industrial Framework &#x2F; Autodesk ShotGrid + UE 集成</td><td>内置蓝图 CR 流程，结合圈复杂度、性能、合规性检测，适配大型团队协作</td><td>3A 游戏、大型商用 UE 项目</td></tr><tr><td>通用代码质量工具适配</td><td>SonarQube + 社区蓝图转译插件</td><td>将蓝图转译为抽象语法树（AST），复用 SonarQube 的圈复杂度分析和 CR 流程</td><td>已有 SonarQube 质量体系的团队</td></tr><tr><td>自定义脚本 &#x2F; 工具</td><td>基于 UE 的 Editor Utility Widget（EUW）开发</td><td>按需定制圈复杂度计算规则、CR 审批流程，适配团队个性化需求</td><td>有 UE 二次开发能力的团队</td></tr></tbody></table><p><a href="https://www.fab.com/zh-cn/listings/14d7ba87-a587-406d-9369-ed75fa0a55ed">蓝图助手</a>:一个很不错的代码整理工具，<a href="https://www.youtube.com/watch?v=MQ70ASNunPQ">演示视频</a></p><p><a href="https://codepen.io/dhvoksdw-the-encoder/pen/EaKbeVe">https://codepen.io/dhvoksdw-the-encoder/pen/EaKbeVe</a></p>]]></content:encoded>
      
      
      
      
      <comments>http://example.com/2025/11/24/Learning/CodeReview/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title></title>
      <link>http://example.com/2025/11/24/Learning/Capturymarkerless/</link>
      <guid>http://example.com/2025/11/24/Learning/Capturymarkerless/</guid>
      <pubDate>Mon, 24 Nov 2025 03:53:22 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;无标记动作捕捉使用及插件接入&quot;&gt;&lt;a href=&quot;#无标记动作捕捉使用及插件接入&quot; class=&quot;headerlink&quot; title=&quot;无标记动作捕捉使用及插件接入&quot;&gt;&lt;/a&gt;无标记动作捕捉使用及插件接入&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://www.f</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="无标记动作捕捉使用及插件接入"><a href="#无标记动作捕捉使用及插件接入" class="headerlink" title="无标记动作捕捉使用及插件接入"></a>无标记动作捕捉使用及插件接入</h1><p><a href="https://www.fab.com/listings/69ee923d-1a3a-42be-8f2a-9924b6e7b79a">CapturyLiveLink</a>_5.2</p><p><a href="http://doc.captury.com/python.html">API文档</a></p><p><a href="http://doc.captury.com/CapturyLive/index.html#overview">官方教程</a></p><p>172.26.7.51</p><p>Blueprint Runtime Error: “Attempted to access index -1 from array ARkit Value of length 0!”. Node:  Set ARkit Head Rotation Graph:  EventGraph Function:  Execute Ubergraph ABP Main Last ZTY Body Blueprint:  ABP_Main_LastZTY_Body<br>Blueprint Runtime Error: “Attempted to access index -1 from array ARkit Value of length 0!”. Node:  Set ARkit Head Rotation Graph:  EventGraph Function:  Execute Ubergraph ABP Main Last ZTY Body Blueprint:  ABP_Main_LastZTY_Body<br>Blueprint Runtime Error: “Attempted to access index -1 from array ARkit Value of length 0!”. Node:  Set ARkit Head Rotation Graph:  EventGraph Function:  Execute Ubergraph ABP Main Last ZTY Body Blueprint:  ABP_Main_LastZTY_Body<br>Blueprint Runtime Error: “Attempted to access index -1 from array ARkit Value of length 0!”. Node:  Set headRoll Graph:  EventGraph Function:  Execute Ubergraph ABP Main Last ZTY Body Blueprint:  ABP_Main_LastZTY_Body</p><p>我的Livelink人物动捕数据接入之后，人物没有反应。</p><h2 id="Captury原始插件底层sock阻塞问题"><a href="#Captury原始插件底层sock阻塞问题" class="headerlink" title="Captury原始插件底层sock阻塞问题"></a>Captury原始插件底层sock阻塞问题</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>在插件接入的时候（插件已经完成了接入，数据已经连通），但遇到一个问题：</p><p>用户反馈，如果要从Captury信号源切换到别的信号源的时候，会发生卡顿的现象。</p><p>卡顿时间在固定的20s左右。</p><p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205150209762.png" alt="image-20251205150209762"><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205150637519.png" alt="image-20251205150637519"></p><p>且这个问题仅仅发生在<u>Captury信号源没连接上的状态</u>中。如果信号连接上了，切换这个操作不会发生卡顿。</p><h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>这个操作背后的逻辑是，用户切到别的信号源，我会销毁掉已经生成的CapturyLivelink，确保Livelink信号池子干净。</p><p>同时，刷新信号的按钮也会出现这个问题，因为刷新的时候，我背后做的操作是：先删除掉老的CapturyLivelink，然后在创建新的连接数据。</p><p>且为了防止出现底层数据竞争的问题。我永远只允许一个CapturyLivelink信号源出现。</p><p>所以，在切到别的信号源的时候，我永远会销毁掉老的信号源。而问题就发生在删除老的信号源上面，只要一旦要销毁没有连上的老的信号源，就会发生这个20s左右的卡顿。</p><p>可是为什么是“没有连接上”才会发生卡顿，而正常情况下不会呢？<u>暂时不得而知。所以暂时推断问题应该在底层断连逻辑这一块。</u></p><p>通过Unreal Insight发现，在执行了Captury_disconnect操作之后。整个系统陷入等待，时间会有三十多秒。</p><p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205153031066.png" alt="image-20251205153031066"></p><p>所以这里确定了是断连操作造成了这个卡顿。</p><p>然后 我在卡顿的（这十几秒里）时候，暂停了IDE，看看当前Game停在了哪里，Game停在了</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">WaitForSingleObject</span>(receiveThread, INFINITE);</span><br></pre></td></tr></table></figure><p>这一句话。这句话是我前几天加的，考虑到两个CapturyLivelink会出现多线程的问题，底层占用会导致崩溃，所以我写了需要等待底下工作的线程真正地退出，才算完成退出操作。</p><p>所以我意识到了，问题应该是出在了receiveThread线程的loop里。</p><p>于是开始在整个链路上打Log寻找罪魁祸首看看是哪个接口造成的。<br>并且在链路中添加更多地退出机制（stopReceiving、bExternalShutdownRequested），看看能否去掉卡顿。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line"><span class="function">DWORD <span class="title">RemoteCaptury::receiveLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="meta">#<span class="keyword">else</span></span></span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">RemoteCaptury::receiveLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="meta">#<span class="keyword">endif</span></span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">bool</span> handshaking = !handshakeFinished;</span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;01 starting receive loop %d %s&quot;), testcount++, *(FDateTime::Now().ToString()));</span></span><br><span class="line">    <span class="comment">//log(&quot;starting receive loop\n&quot;);</span></span><br><span class="line">    <span class="keyword">while</span> (!stopReceiving</span><br><span class="line">       &amp;&amp; !bExternalShutdownRequested </span><br><span class="line">       &amp;&amp; (!handshaking || !handshakeFinished)) &#123;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;02 receive loop iteration %d %s&quot;), testcount++, *(FDateTime::Now().ToString()));</span></span><br><span class="line">       </span><br><span class="line">       <span class="keyword">if</span> (!<span class="built_in">receive</span>(sock)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (sock == <span class="number">-1</span></span><br><span class="line">             &amp;&amp; !stopReceiving</span><br><span class="line">             &amp;&amp; !bExternalShutdownRequested )</span><br><span class="line">             &#123;</span><br><span class="line">                <span class="built_in">deleteActors</span>();</span><br><span class="line">                cameras.<span class="built_in">clear</span>();</span><br><span class="line">                numCameras = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;03 socket closed, reconnecting %d %s&quot;), testcount++, *(FDateTime::Now().ToString()));</span></span><br><span class="line">                <span class="keyword">if</span> (isStreamThreadRunning) &#123;</span><br><span class="line">                   stopStreamThread = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                   <span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">                   <span class="built_in">WaitForSingleObject</span>(streamThread, <span class="number">1000</span>);</span><br><span class="line">                   <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                   <span class="type">void</span>* retVal;</span><br><span class="line">                   <span class="built_in">pthread_join</span>(streamThread, &amp;retVal);</span><br><span class="line">                   <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;03 a socket closed, reconnecting %d %s&quot;), testcount++, *(FDateTime::Now().ToString()));</span></span><br><span class="line"></span><br><span class="line">             <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;04-1 %d %s&quot;), testcount++, *(FDateTime::Now().ToString()));</span></span><br><span class="line">             <span class="keyword">while</span> (!stopReceiving) &#123;</span><br><span class="line">                <span class="comment">// 停止重连</span></span><br><span class="line">                sock = <span class="built_in">openTcpSocket</span>();</span><br><span class="line">                <span class="comment">//UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;04-2 %d %s&quot;), testcount++, *(FDateTime::Now().ToString()));</span></span><br><span class="line">                <span class="keyword">if</span> (sock != <span class="number">-1</span>)</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">sleepMicroSeconds</span>(<span class="number">1000</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;04-3 %d %s&quot;), testcount++, *(FDateTime::Now().ToString()));</span></span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (streamWhat != CAPTURY_STREAM_NOTHING)</span><br><span class="line">                <span class="built_in">Captury_startStreamingImagesAndAngles</span>(<span class="keyword">this</span>, streamWhat, streamCamera, (<span class="type">int</span>)streamAngles.<span class="built_in">size</span>(), streamAngles.<span class="built_in">data</span>());</span><br><span class="line">                <span class="comment">//UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;05 %d %s&quot;), testcount++, *(FDateTime::Now().ToString()));</span></span><br><span class="line">             </span><br><span class="line">             handshaking = <span class="literal">false</span>; <span class="comment">// this is a lie but makes it go into the normal loop</span></span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//log(&quot;stopping receive loop\n&quot;);</span></span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;06 %d %s&quot;), testcount++, *(FDateTime::Now().ToString()));</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果Log查出问题了：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Display LogCaptury CapturyLiveLink: request shutdown</span><br><span class="line">Warning LogCapturyRemote Captury_stopStreaming() called</span><br><span class="line">Warning LogCapturyRemote Captury_disconnect() called</span><br><span class="line">Warning LogCapturyRemote RemoteCaptury::disconnect() called</span><br><span class="line"></span><br><span class="line">Warning LogCapturyRemote 01 starting receive loop 267 2025.12.04-18.57.03</span><br><span class="line">Warning LogCapturyRemote 02 receive loop iteration 268 2025.12.04-18.57.03</span><br><span class="line">Warning LogCapturyRemote 03 socket closed, reconnecting 269 2025.12.04-18.57.03</span><br><span class="line">Warning LogCapturyRemote 03 a socket closed, reconnecting 270 2025.12.04-18.57.03</span><br><span class="line">Warning LogCapturyRemote Captury_disconnect() called</span><br><span class="line">Warning LogCapturyRemote 04-1 271 2025.12.04-18.57.03</span><br><span class="line">Warning LogCapturyRemote RemoteCaptury::disconnect() called</span><br><span class="line">Warning LogCapturyRemote openTcpSocket() 01 2025.12.04-18.57.03</span><br><span class="line">Warning LogCapturyRemote openTcpSocket() 02 2025.12.04-18.57.03</span><br><span class="line">Warning LogCapturyRemote openTcpSocket() 03 2025.12.04-18.57.03</span><br><span class="line">Display LogCaptury CapturyLiveLink: request shutdown</span><br><span class="line">Warning LogCapturyRemote Captury_stopStreaming() called</span><br><span class="line">Warning LogCapturyRemote Captury_disconnect() called</span><br><span class="line">Warning LogCapturyRemote RemoteCaptury::disconnect() called</span><br><span class="line">Warning LogCapturyRemote RemoteCaptury::disconnect() **: waiting for receiveThread 2025.12.04-18.57.05</span><br><span class="line">Warning LogCapturyRemote 04-2 272 2025.12.04-18.57.24</span><br><span class="line">Warning LogCapturyRemote 04-3 273 2025.12.04-18.57.24</span><br><span class="line">Warning LogCapturyRemote 06 274 2025.12.04-18.57.24</span><br><span class="line">Warning LogCapturyRemote RemoteCaptury::disconnect() **: receiveThread finished 2025.12.04-18.57.24</span><br><span class="line"></span><br><span class="line">Display LogCaptury CapturyLiveLink: request shutdown</span><br><span class="line">Warning LogCapturyRemote Captury_stopStreaming() called</span><br><span class="line">Warning LogCapturyRemote Captury_disconnect() called</span><br><span class="line">Warning LogCapturyRemote RemoteCaptury::disconnect() called</span><br></pre></td></tr></table></figure><p>其中openTcpSocket()+数字的部分以及RemoteCaptury::disconnect() 是我游戏线程。</p><p>当我下达关机指令的时候，remote线程卡在了04-1和04-2之间。并且remote线程是活的。所以大家都在等remote线程。</p><p>而这两个Log之间夹的函数就是sock &#x3D; openTcpSocket();</p><p>这个函数的作用是：创建一个 TCP，套接字并尝试与远程地址建立连接。</p><p>下面是原始的代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SOCKET <span class="title">RemoteCaptury::openTcpSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log</span>(<span class="string">&quot;opening TCP socket\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    SOCKET sok = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (sok == <span class="number">-1</span>)</span><br><span class="line">       <span class="keyword">return</span> (SOCKET)<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (localAddress.sin_port != <span class="number">0</span> &amp;&amp; <span class="built_in">bind</span>(sok, (sockaddr*) &amp;localAddress, <span class="built_in">sizeof</span>(localAddress)) != <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="built_in">closesocket</span>(sok);</span><br><span class="line">       <span class="keyword">return</span> (SOCKET)<span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">connect</span>(sok, (sockaddr*) &amp;remoteAddress, <span class="built_in">sizeof</span>(remoteAddress)) != <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="built_in">closesocket</span>(sok);</span><br><span class="line">       <span class="keyword">return</span> (SOCKET)<span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set read timeout</span></span><br><span class="line">    <span class="built_in">setSocketTimeout</span>(sok, <span class="number">500</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> WIN32</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">log</span>(<span class="string">&quot;connected to %s:%d\n&quot;</span>, <span class="built_in">inet_ntop</span>(AF_INET, &amp;remoteAddress.sin_addr, buf, <span class="number">100</span>), <span class="built_in">ntohs</span>(remoteAddress.sin_port));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sok;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过加Log发现，函数卡在了。</p><p><code>if (::connect(sok, (sockaddr*) &amp;remoteAddress, sizeof(remoteAddress)) != 0) </code></p><p>这个if判断里面，而这个接口是windows的sock接口。ok，至此，已经找到罪魁祸首了。</p><h3 id="底层逻辑阐述"><a href="#底层逻辑阐述" class="headerlink" title="底层逻辑阐述"></a>底层逻辑阐述</h3><p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205123239125.png" alt="image-20251205123239125"></p><p>这一节想解释清楚两件事：</p><ol><li><strong>为什么阻塞式 <code>connect</code> 会在「没连上」的时候卡住几十秒</strong>；</li><li>这个行为和阻塞 &#x2F; 非阻塞、缓冲区、IO 多路复用之间的关系。</li></ol><h4 id="1-阻塞-connect-为什么会卡很久"><a href="#1-阻塞-connect-为什么会卡很久" class="headerlink" title="1. 阻塞 connect 为什么会卡很久"></a>1. 阻塞 <code>connect</code> 为什么会卡很久</h4><p>原始代码里的 <code>openTcpSocket</code> 使用的是<strong>阻塞 socket + 阻塞 <code>connect</code></strong>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SOCKET sok = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (::<span class="built_in">connect</span>(sok, (sockaddr*)&amp;remoteAddress, <span class="built_in">sizeof</span>(remoteAddress)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(sok);</span><br><span class="line">        <span class="keyword">return</span> (SOCKET)<span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在阻塞模式下：</p><ul><li><code>connect</code> 会进入内核，等待 TCP 三次握手完成或者失败；</li><li>如果远端服务没开 &#x2F; IP 不可达 &#x2F; 包被丢弃，系统会按自己的重试策略不断发 SYN、等待回应；</li><li>在这段时间里，调用 <code>connect</code> 的线程会一直被挂起，直到<strong>内核判定“连接失败”并超时返回</strong>；</li><li>这个超时通常是几十秒级（你实际观测到的就是 ~20s）。</li></ul><p>结合上面的 receiveLoop，可以看到：</p><ul><li><code>receiveLoop</code> 在重连时会反复调用 <code>sock = openTcpSocket();</code>；</li><li>当 Captury 端没开的时候，每次 <code>openTcpSocket()</code> 都会在 <code>connect</code> 内部卡到系统超时；</li><li>你的 <code>disconnect()</code> 又在 <code>WaitForSingleObject(receiveThread, INFINITE);</code> 等这个线程自然退出；</li><li>于是 Game 线程就被这一条阻塞式 <code>connect</code> 间接拖住了几十秒。</li></ul><p>也就是说，这里并不是逻辑死锁，而是<strong>单纯被内核的阻塞连接等待住了</strong>。</p><h4 id="2-阻塞-I-O、缓冲区和-IO-多路复用问题（扩展）"><a href="#2-阻塞-I-O、缓冲区和-IO-多路复用问题（扩展）" class="headerlink" title="2. 阻塞 I&#x2F;O、缓冲区和 IO 多路复用问题（扩展）"></a>2. 阻塞 I&#x2F;O、缓冲区和 IO 多路复用问题（扩展）</h4><p>阻塞的问题不只出现在 <code>connect</code>，也同样存在于 <code>read</code> &#x2F; <code>write</code>（WinSock 里的 <code>recv</code> &#x2F; <code>send</code>）：</p><ul><li>阻塞模式下：<ul><li><code>recv</code> 在缓冲区“没数据可读”时会一直等；</li><li><code>send</code> 在发送缓冲区满时会一直等；</li><li>线程就挂在这些系统调用里，直到有数据或有空位。</li></ul></li></ul><p>这几张图，其实就是描述：应用线程在访问一个<strong>内核缓冲区</strong>——</p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205142827661.png" alt="image-20251205142827661" style="zoom:25%;" /><ul><li>读的时候：如果缓冲区里<strong>暂时没数据</strong>，阻塞 <code>read/recv</code> 会卡住线程；</li><li>写的时候：如果缓冲区已经<strong>写满</strong>，阻塞 <code>write/send</code> 会卡在那儿等内核把旧数据发走。</li></ul><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205144248299.png" alt="image-20251205144248299" style="zoom:25%;" /><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205144319439.png" alt="image-20251205144319439" style="zoom:25%;" /><p>在“阻塞模型”下（原来的代码），如果网络线程直接在这些调用上阻塞：</p><ul><li><p>它就<strong>没法及时响应退出信号</strong>（<code>stopReceiving</code> &#x2F; <code>bExternalShutdownRequested</code> 等）；</p></li><li><p>像 <code>disconnect()</code> 这种需要“等待线程正常退出”的逻辑，也都会被一起拖住。比如下下面这张图片，多线程的阻塞模式，会在有大量连接调用的时候，开辟多个线程，去做连接，一个服务一个连接，这个服务断掉了这个，这个线程占用才结束，这是一个很古早的调用方式，因为线程其实也是很珍贵的资源，一台电脑总共也没几个线程。（回到我的项目里，因为我只允许运行一个Captury线程，而且Game线程会等这个线程，所以整个游戏卡着。当然我这么做也有别的考量）</p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205191914919.png" alt="image-20251205191914919" style="zoom:25%;" /></li></ul><p> <strong>IO 多路复用（<code>select</code> &#x2F; <code>poll</code> &#x2F; <code>epoll</code> &#x2F; <code>WSAPoll</code>）</strong>，本质上是在做一件事：</p><ul><li>不把线程挂死在 <code>read/write/connect</code> 上，而是：<ul><li>先在一个“描述符集合”上等「可读 &#x2F; 可写 &#x2F; 异常」事件；</li><li>只有当内核告诉你“这个 fd 已经准备好”时，再真正去 <code>read/recv</code> 或 <code>write/send</code>；</li><li>这个等待可以设置自定义超时（例如 10ms、100ms、1s），并在每次醒来时检查退出条件。</li></ul></li></ul><h4 id="3-非阻塞-ioctlsocket-在这里的作用"><a href="#3-非阻塞-ioctlsocket-在这里的作用" class="headerlink" title="3. 非阻塞 + ioctlsocket 在这里的作用"></a>3. 非阻塞 + <code>ioctlsocket</code> 在这里的作用</h4><p><code>ioctlsocket(sok, FIONBIO, &amp;NonBlocking)</code> 就是把 socket 从“阻塞模式”切换到“非阻塞模式”。</p><p>在非阻塞模式下：</p><ul><li><code>connect</code> 不再把线程挂死，而是：<ul><li>立刻返回一个错误码（例如 <code>WSAEWOULDBLOCK / WSAEINPROGRESS</code>），表示“连接还在进行中”；</li><li>后续由你自己用 <code>select</code> &#x2F; <code>WSAPoll</code> 等来轮询「这条连接是否已经成功&#x2F;失败」，并且可以<strong>自己控制最大等待时间</strong>；</li></ul></li><li><code>read/recv</code>、<code>write/send</code> 遇到没数据 &#x2F; 缓冲区满时，也会立刻返回 <code>EWOULDBLOCK</code>，由你的逻辑决定下一步怎么做，而不是直接卡死线程。</li></ul><p>总结一下这一节：</p><ul><li><strong>根因</strong>：阻塞 <code>connect</code> 在目标不可达时会触发系统级长超时，线程被内核挂起几十秒；</li><li><strong>放大器</strong>：你的 <code>receiveLoop</code> 在重连路径里频繁调用 <code>openTcpSocket()</code>，而 <code>disconnect()</code> 又必须等线程退出；</li><li><strong>改成非阻塞的目的</strong>：用 <code>ioctlsocket(FIONBIO)</code> + <code>select</code> 自己控制等待时长和退出时机，把“不可控的 20s 超时”变成“可控的 1s 以内失败”，从而让 <code>disconnect()</code> 快速返回。</li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><img src="C:\Users\Eugene\AppData\Roaming\Typora\typora-user-images\image-20251205123239125.png" alt="image-20251205123239125"></p><p>非阻塞是“通过修改套接字模式”实现的——代码在 socket() 之后、connect() 之前把套接字设为非阻塞，因此 connect() 就是在非阻塞模式下执行的；连接完成后再把套接字恢复成阻塞。</p><ul><li>所以其实我这个修改后的代码，并不是完全非阻塞的。</li></ul><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>因为这里调用了底层 WinSock 的 connect。<br>它是 Windows 提供的系统调用，没办法在内部加条件判断。</p><p>我们只能：</p><ul><li>要么换一种调用方式（非阻塞 + 自己用 select&#x2F;WSAPoll 控制超时）；</li><li>要么在调用 connect 前后做逻辑，比如提前检测 stopReceiving，或者调用后在另一个线程里强制 closesocket。</li></ul><p>但这个方案不是很问题，需要维护另外一个线程来关闭这个线程。听起来就很麻烦。所以我用前者，来改造一个非阻塞的sock。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SOCKET <span class="title">RemoteCaptury::openTcpSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 01 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line">    <span class="comment">// 函数通过调用 socket 创建一个套接字。如果创建失败（返回 INVALID_SOCKET），函数直接返回错误状态</span></span><br><span class="line">    SOCKET sok = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (sok == INVALID_SOCKET)</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 02 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line">    <span class="comment">// 如果 localAddress 的端口号不为 0，函数会尝试将套接字绑定到指定的本地地址。如果绑定失败，同样关闭套接字并返回错误</span></span><br><span class="line">    <span class="keyword">if</span> (localAddress.sin_port != <span class="number">0</span> &amp;&amp; <span class="built_in">bind</span>(sok, (sockaddr*)&amp;localAddress, <span class="built_in">sizeof</span>(localAddress)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(sok);</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 03 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line">    <span class="comment">// 1. 先设成非阻塞</span></span><br><span class="line">    u_long NonBlocking = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ioctlsocket</span>(sok, FIONBIO, &amp;NonBlocking) == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(sok);</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 尝试发起 connect</span></span><br><span class="line">    <span class="type">int</span> ConnectResult = ::<span class="built_in">connect</span>(sok, (sockaddr*)&amp;remoteAddress, <span class="built_in">sizeof</span>(remoteAddress));</span><br><span class="line">    <span class="keyword">if</span> (ConnectResult == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="type">int</span> Err = <span class="built_in">WSAGetLastError</span>();</span><br><span class="line">        <span class="keyword">if</span> (Err != WSAEWOULDBLOCK &amp;&amp; Err != WSAEINPROGRESS &amp;&amp; Err != WSAEALREADY) &#123;</span><br><span class="line">            <span class="comment">// 真错误，直接失败</span></span><br><span class="line">            <span class="built_in">closesocket</span>(sok);</span><br><span class="line">            <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 连接正在进行中，用 select 等待一小段时间</span></span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> MaxWaitMillis = <span class="number">1000</span>; <span class="comment">// 1 秒上限</span></span><br><span class="line">        fd_set WriteSet;</span><br><span class="line">        <span class="built_in">FD_ZERO</span>(&amp;WriteSet);</span><br><span class="line">        <span class="built_in">FD_SET</span>(sok, &amp;WriteSet);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">timeval</span> Tv;</span><br><span class="line">        Tv.tv_sec = MaxWaitMillis / <span class="number">1000</span>;</span><br><span class="line">        Tv.tv_usec = (MaxWaitMillis % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> Sel = <span class="built_in">select</span>((<span class="type">int</span>)(sok + <span class="number">1</span>), <span class="literal">nullptr</span>, &amp;WriteSet, <span class="literal">nullptr</span>, &amp;Tv);</span><br><span class="line">        <span class="keyword">if</span> (Sel &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 超时或 select 出错，都当失败</span></span><br><span class="line">            <span class="built_in">closesocket</span>(sok);</span><br><span class="line">            <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. select 说 socket 可写了，用 SO_ERROR 再确认一次</span></span><br><span class="line">        <span class="type">int</span> so_error = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> optLen = <span class="built_in">sizeof</span>(so_error);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">getsockopt</span>(sok, SOL_SOCKET, SO_ERROR, (<span class="type">char</span>*)&amp;so_error, &amp;optLen) == SOCKET_ERROR || so_error != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">closesocket</span>(sok);</span><br><span class="line">            <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 走到这说明 connect 已经完成了，可以恢复成阻塞模式</span></span><br><span class="line">    u_long Blocking = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">ioctlsocket</span>(sok, FIONBIO, &amp;Blocking);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 04 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setSocketTimeout</span>(sok, <span class="number">500</span>);</span><br><span class="line">    <span class="comment">// UE_LOG(LogCapturyRemote , Warning, TEXT(&quot;openTcpSocket() 05 %s&quot;), *(FDateTime::Now().ToString()));</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sok;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数实现了客户端创建socket，且用非阻塞模式connect。然后恢复阻塞。</p><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol><li><a href="https://www.bilibili.com/video/BV1Av41187M8/">网络多线程细节处理：Socket阻塞与非阻塞</a></li></ol>]]></content:encoded>
      
      
      
      
      <comments>http://example.com/2025/11/24/Learning/Capturymarkerless/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Unreal RemoteControl Note</title>
      <link>http://example.com/2025/11/21/Notes/Unreal%20RemoteControl%20Note/</link>
      <guid>http://example.com/2025/11/21/Notes/Unreal%20RemoteControl%20Note/</guid>
      <pubDate>Fri, 21 Nov 2025 03:21:56 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;虚幻5远程控制（RemoteControl）笔记&quot;&gt;&lt;a href=&quot;#虚幻5远程控制（RemoteControl）笔记&quot; class=&quot;headerlink&quot; title=&quot;虚幻5远程控制（RemoteControl）笔记&quot;&gt;&lt;/a&gt;虚幻5远程控制（Remote</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="虚幻5远程控制（RemoteControl）笔记"><a href="#虚幻5远程控制（RemoteControl）笔记" class="headerlink" title="虚幻5远程控制（RemoteControl）笔记"></a>虚幻5远程控制（RemoteControl）笔记</h1><h2 id="基础介绍"><a href="#基础介绍" class="headerlink" title="基础介绍"></a>基础介绍</h2><h3 id="什么是？"><a href="#什么是？" class="headerlink" title="什么是？"></a>什么是？</h3><table><thead><tr><th><code>WebControl.StartServer</code></th><th>启动网页服务器并开始在端口 <code>30010</code> 上聆听传入请求。</th></tr></thead><tbody><tr><td><code>WebControl.StopServer</code></td><td>停止网页服务器，禁止再处理任何对虚幻编辑器实例的请求。</td></tr><tr><td><code>WebControl.EnableServerOnStartup</code></td><td>每当此项目在虚幻引擎中以任何支持的模式打开（在虚幻编辑器主窗口中、在编辑器中运行（PIE）会话中、或在虚幻编辑器的 <code>-游戏</code> 模式下）时，便自动启动Web服务器。</td></tr></tbody></table><p>如果要在打包后使用，需要把预设拖到场景中。关于打包后使用可以参考这个<a href="https://www.bilibili.com/video/BV1G84y167Vs/">视频</a></p><p><img src="https://s2.loli.net/2025/11/21/q9QmgrIvkUp3Y2M.png" alt="image-20251121150628085"></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li>UnrealFest2022介绍RemoteControl带中文的<a href="https://www.bilibili.com/video/BV1Cv4y1L7gH/?spm_id_from=333.337.search-card.all.click&vd_source=60b376a57ab956cf81ad81ef20747a92">搬运视频</a></li></ul>]]></content:encoded>
      
      
      
      <category domain="http://example.com/tags/Unreal-Engine/">Unreal Engine</category>
      
      <category domain="http://example.com/tags/Game-Development/">Game Development</category>
      
      
      <comments>http://example.com/2025/11/21/Notes/Unreal%20RemoteControl%20Note/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>UE5 GAS Learning Notes</title>
      <link>http://example.com/2025/09/21/Notes/UE5%20GAS%20Learning%20Notes/</link>
      <guid>http://example.com/2025/09/21/Notes/UE5%20GAS%20Learning%20Notes/</guid>
      <pubDate>Sun, 21 Sep 2025 04:34:56 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Unreal-GAS系统使用学习&quot;&gt;&lt;a href=&quot;#Unreal-GAS系统使用学习&quot; class=&quot;headerlink&quot; title=&quot;Unreal GAS系统使用学习&quot;&gt;&lt;/a&gt;Unreal GAS系统使用学习&lt;/h1&gt;&lt;h2 id=&quot;前置知识&quot;&gt;&lt;a </description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Unreal-GAS系统使用学习"><a href="#Unreal-GAS系统使用学习" class="headerlink" title="Unreal GAS系统使用学习"></a>Unreal GAS系统使用学习</h1><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p><a href="https://www.bilibili.com/video/BV1ud4y1y7a8/">UE网络架构</a></p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Gameplay Ability System，简称(GAS)是一个健壮的、高度可扩展的、gameplay框架,通常用于构建RPG、MOBA等游戏的完整战斗逻辑框架。通过GAS,可以快速地制作游戏中的主动&#x2F;被动技能、各种效果buff、计算属性伤害、处理玩家各种战斗状态逻辑。</p><p>GAS试图<u>将机制提取为通用的游戏设计模式</u>，并提供框架来解决常见的Gameplay实现问题，同时使上下文因项目而异。</p><h3 id="GAS提供了哪些功能"><a href="#GAS提供了哪些功能" class="headerlink" title="GAS提供了哪些功能?"></a>GAS提供了哪些功能?</h3><ol><li>实现了带有消耗和冷却功能的角色技能</li><li>处理数值属性(生命、魔法、攻击力、防御力)</li><li>应用状态效果(击飞、着火、眩晕)</li><li>应用游戏标签(GameplayTags)</li><li>生成特效和音效</li><li>完整的网络复制、预测功能</li></ol><h3 id="适合使用GAS的项目"><a href="#适合使用GAS的项目" class="headerlink" title="适合使用GAS的项目"></a>适合使用GAS的项目</h3><ol><li><p>C++项目,开发人员有充足的C++开发经验</p></li><li><p>使用Dedicated Server专用服务器的联机游戏（单纯的游戏逻辑服务端，与Dedicated Server相对的是Listen Server，其中一位玩家充当服务器，容易出现“主机优势”）</p></li><li><p>项目有大量且复杂的技能逻辑设计需求</p></li></ol><h3 id="GAS的主要优势"><a href="#GAS的主要优势" class="headerlink" title="GAS的主要优势"></a>GAS的主要优势</h3><ul><li><strong>网络复制（Network Replication）：</strong> 不必担心你的属性或减益效果得不到妥善地应用或复制。GAS会为你处理内部逻辑。</li><li><strong>模块化（Modularity）：</strong> 添加或更改游戏机制通常与实现和赋予新技能一样简单。通过将Gameplay功能分解为单独的资产，技能系统可以在完全不同的游戏对象或机制之间提供通用的通信层。例如，生命值（Health）可以划分到自己的属性集，并通过来自各种系统的Gameplay效果进行交互。</li><li><strong>快速迭代（Fast iteration）：</strong> GAS可以轻松更改单个游戏规则，而无需修改整个系统。用于计算游戏的数据源可以轻松交换，并且可以从相应的Gameplay效果中修改动作效果。</li></ul><h3 id="我为什么学习GAS"><a href="#我为什么学习GAS" class="headerlink" title="我为什么学习GAS"></a>我为什么学习GAS</h3><p>编写样板代码通常易出错且耗时，尤其是对于多人游戏而言。例如，你不希望花费大量时间来确保你的生命（Health）值正确复制，或者在你决定具有相同行为的能量（Energy）值时，复制相同的代码行。</p><p>GAS通过提供尽可能实现常见Gameplay功能的基础来解决这些问题，同时保持机制中立。GAS并非强制使用诸如生命值（Health）、弹药（Ammo）、近战攻击（Melee Attack）或毒药减益（Poison Debuff）之类的概念，而是提供了能够定义、复制和使用 <strong>属性（Attributes）</strong> 、 <strong>技能（Abilities）</strong> 和 <strong>效果（Effects）</strong> 的工具，然后你可以将这些工具专用于满足给定Gameplay机制的需求。</p><p><u>于我而言</u>：公司的项目需要使用到联网的游戏服务。所以你会在我的笔记中看到一些斜体的备注，这些备注意味着对我自己项目的备注。可以忽略。</p><h2 id="GAS的组件"><a href="#GAS的组件" class="headerlink" title="GAS的组件"></a>GAS的组件</h2><h3 id="ASC：who谁能放技能？"><a href="#ASC：who谁能放技能？" class="headerlink" title="ASC：who谁能放技能？"></a>ASC：who谁能放技能？</h3><p>Ability System Component（ASC）是整个 GAS 的基础组件。ASC 本质上是一个 UActorComponent，用于处理整个框架下的交互逻辑，包括使用技能（GameplayAbility）、包含属性（AttributeSet）、处理各种效果（GameplayEffect）。所有需要应用 GAS 的对象（Actor），都必须拥有 GAS 组件。（即所有有技能交互的角色都是ASC）。</p><ul><li>ASC是一种角色组件，负责和GA、GE、AS打交道。</li><li>一般只放在Character or PlayerState上。</li><li>拥有 ASC 的 Actor 被称为 ASC 的 OwnerActor，ASC 实际作用的 Actor 叫做 AvatarActor。</li></ul><h3 id="GA：How-技能的逻辑？"><a href="#GA：How-技能的逻辑？" class="headerlink" title="GA：How:技能的逻辑？"></a><strong>GA</strong>：How:技能的逻辑？</h3><p>Gameplay Ability（GA）<u>标识了游戏中一个对象（Actor）可以做的行为或技能</u>。它代表角色可以执行的任何技能或行为。<br>能力（Ability）可以是普通攻击或者吟唱技能，可以是角色被击飞倒地，还可以是使用某种道具，交互某个物件，甚至跳跃、飞行等角色行为也可以是Ability。<br>Ability可以被赋予对象或从对象的ASC中移除，对象同时可以激活多个GameplayAbility。</p><ul><li>基本的移动输入、UI交互行为则不能或不建议通过GA来实现。</li><li>通过蓝图继承GamePlay Ability来实现</li></ul><h4 id="GA的执行流程"><a href="#GA的执行流程" class="headerlink" title="GA的执行流程"></a>GA的执行流程</h4><div class="mermaid" style="background: white; border: 1px solid #e1e1e1; border-radius: 4px; padding: 20px;">graph TD    A[TryActivateAbility] --> B{CanActivateAbility}    B -->|Yes| C[ActivateAbility]    B -->|No| D[EndAbility]    C --> E[Start AbilityTask]    E -->|Some Time Later| F[CommitAbility]    F -->|Can't Afford| D    F --> G[Start AbilityTask]    G -->|Some Time Later| H[Apply GameplayEffects]    G --> I[Start AbilityTask]    I -->|Some Time Later| J[Apply GameplayEffects]    I -->|Some Time Later| K[End Ability]    D --> L[OnEndAbility]    K --> L    L --> M[Cleanup]</div><ol><li><span style="color: blue;">TryActivateAbility</span> ：首先判断一下能不能执行。</li><li><span style="color: green;">ActivateAbility</span>：执行一套技能（有技能动画，比如发射一个火焰）。</li><li><span style="color: #9C27B0;">CommitAbility</span>：技能释放了成功了，要扣蓝。</li><li><span style="color: #ffeb3b;">Start AbilityTask</span> * 2:技能执行中…技能执行结束。然后应用对应效果。</li></ol><p>其中ActivateAbility和End Ability是类似于BeginPlay和EndPlay这样的函数，在蓝图中调用。</p><h4 id="蓝图中的设置"><a href="#蓝图中的设置" class="headerlink" title="蓝图中的设置"></a>蓝图中的设置</h4><h4 id="主要选项解释"><a href="#主要选项解释" class="headerlink" title="主要选项解释"></a>主要选项解释</h4><h5 id="常见蓝图"><a href="#常见蓝图" class="headerlink" title="常见蓝图"></a>常见蓝图</h5><ul><li>EndAbility 结束这个能力</li></ul><h5 id="高级设置"><a href="#高级设置" class="headerlink" title="高级设置"></a>高级设置</h5><div style="text-align: center;">  <img src="https://s2.loli.net/2025/10/29/Ndl5QoW8hUkyKrw.png" alt="image-20251028173049722" width="50%" /></div><ul><li><p><strong>Replication Policy</strong>（复制策略）： 决定该Ability的激活、执行等信息是否在网络上传播。常见选项有：</p><ul><li>Not Replicated：仅本地执行，不同步到其他客户端&#x2F;服务器。</li><li>Replicated：在服务器和客户端之间同步。</li></ul></li><li><p><strong>Instancing Policy</strong>（实例化策略）： 决定Ability的实例化方式。</p><ul><li>Non-Instanced：所有激活者共享同一个Ability对象，适合无状态逻辑。</li><li>Instanced Per Actor：每个拥有者有独立实例，适合有状态逻辑。</li><li>Instanced Per Execution：每次激活都新建实例，适合需要隔离状态的复杂技能。</li></ul></li><li><p><strong>Server Respects Remote Ability Cancellation</strong>（服务器尊重远端取消）：勾选后，服务器会响应客户端请求取消Ability的操作。适合需要客户端主动取消技能的场景。</p></li><li><p><strong>Retrigger Instanced Ability</strong>（可重复触发实例化Ability）：允许Ability在已激活时再次被激活（会重新实例化），适合可叠加或可重复释放的技能。</p></li><li><p><strong>Net Execution Policy</strong>（网络执行策略）：决定Ability的激活和执行在哪端进行。</p><ul><li>Local Predicted：客户端预测执行，服务器校验。</li><li>Local Only：仅本地执行。</li><li>Server Only：仅服务器执行。</li><li>Server Initiated：服务器发起，客户端可参与。</li></ul></li><li><p><strong>Net Security Policy</strong>（网络安全策略）：控制Ability的安全等级，防止被恶意客户端滥用。</p><ul><li>Client Or Server：客户端和服务器都可激活。</li><li>Server Only Execution：只有服务器可激活。</li><li>Server Only Execution and Data：只有服务器可激活且数据仅在服务器。</li></ul></li></ul><h4 id="GA要做的事情"><a href="#GA要做的事情" class="headerlink" title="GA要做的事情"></a>GA要做的事情</h4><div style="text-align: center;">  <img src="https://s2.loli.net/2025/10/29/jaloAZzDKkq5fx2.png" alt="image-20251028200009953" width="50%" /></div><p>一般GA要做的事有：</p><ul><li>设置GA的Tag、CD、Cost等属性。</li><li>获取必要信息，主要通过Get Actor Info。如果是通过Event调用的GA（使用Activate Ability From Event节点作为输入），还可以通过Gameplay Event Data获取。</li><li>编写逻辑，如播放动画、应用GE、应用冲量等。</li><li>一定不要忘了EndAbility。</li></ul><h4 id="GA的调用"><a href="#GA的调用" class="headerlink" title="GA的调用"></a>GA的调用</h4><p>GA的调用分成了主动调用（释放技能）和被动调用（挨打）两类，下面依次介绍不同的调用方法。</p><h5 id="主动调用"><a href="#主动调用" class="headerlink" title="主动调用"></a>主动调用</h5><p>在蓝图中主要有by Class和by Tag 两种调用方法。</p><div style="text-align: center;">  <img src="https://pic4.zhimg.com/v2-0671623b3bf57f42b92903bfc3acb667_1440w.jpg" alt="img" width="50%" /></div><p>byClass一次只能Activate一个GA，byTag可以Activate任意多个GA，配合Tag容器使用。</p><p>如果使用EnhancedInputAction插件来管理输入，要注意在某些设置下trigger会每帧都进行输出（本人测试环境为4.27，UE5似乎有一些改动。<br>1.62GB<br>古代山谷项目就使用了新版输入插件和GAS系统，可以看一看实现方法）。</p><p>只要能获取ASC，就可以在任何地方调用GA，比如行为树Task蓝图，甚至在GA蓝图中调用其他GA。</p><h5 id="被动调用"><a href="#被动调用" class="headerlink" title="被动调用"></a>被动调用</h5><p>Trigger可以理解为一个Tag，当ASC组件收到一个Trigger时，就会自动调用所有拥有该Trigger的GA。</p><p>Trigger的Tag在GA的details面板中设置。</p><div style="text-align: center;">  <img src="https://pic2.zhimg.com/v2-9fdb393dae4753b3539245b335c3a531_1440w.jpg" alt="img" width="50%" /></div><p>Trigger的触发方式有三种，分别是：</p><ul><li>Gameplay Event: 当Owner收到一个带有Tag的Gameplay Event（<strong>不是Gameplay Effect的GE！</strong>）时<strong>调用一次</strong>GA，此时Owner<strong>不会拥有对应的Tag</strong>。</li><li>Owner Tag Added: 当Owner<strong>获取对应Tag</strong>的时候<strong>调用一次</strong>GA。</li><li>Owner Tag Present: 当Owner<strong>拥有Tag</strong>时调用GA，失去Tag时移除。</li></ul><p>一般使用第一种方法，并配合SendGameplayEventToActor节点使用，如下图所示。（这张图是很久以前截的，Tag建议以Event开头）</p><div style="text-align: center;"><img src="https://pica.zhimg.com/v2-0759f3f09591c5a808113d8841733b38_1440w.jpg" alt="img" style="zoom: 50%;" / width="50%" /></div><p>受击效果的例子，发送一个Tag为Hit的Event给碰撞检测到的Actor</p><p>使用Gameplay Event调用的好处是，可以传入数据（Payload），是除了Get Actor Info外的另一种信息传递方法。</p><p>此时应该删除ActiveAbility节点，转而使用ActivateAbilityFromEvent事件。（<strong>不要通过在左上角重载函数的方式，右键空白处搜索才是对的</strong>）</p><h3 id="GE：What技能改变的属性？"><a href="#GE：What技能改变的属性？" class="headerlink" title="GE：What技能改变的属性？"></a>GE：What技能改变的属性？</h3><p>Gameplay Effect（GE）是Ability对<strong>自己或他人产生影响的途径</strong>。<br>GE通常可以被理解为我们游戏中的buff。比如增益&#x2F;减益效果（修改属性）。<br>但是GAS中的GE也更加广义，释放技能时候的伤害结算，施加特殊效果的控制、霸体效果（修改GameplayTag）都是通过GE来实现的。</p><ul><li><u>GE只是一个可配置的*<em>数据表</em> *</u>，不可以添加逻辑。开发者创建一个UGameplayEffect的派生蓝图，就可以根据需求制作想要的效果。</li><li>GE是纯蓝图</li></ul><h3 id="GT：if技能改变的条件？"><a href="#GT：if技能改变的条件？" class="headerlink" title="GT：if技能改变的条件？"></a>GT：if技能改变的条件？</h3><p>FGameplayTags是一种层级标签，如Parent.Child.GrandChild。<br>通过GameplayTagManager进行注册。<br>替代了原来的Bool，或Enum的结构，可以在玩法设计中更高效的<strong>标记对象的行为或状态</strong>（比如一个灼烧效果，GE完成之后，便可以取消标签）。<br>我理解是一个在Actor下的Json。</p><ul><li>Tag的<strong>层级关系</strong>也需要合理设计，到了后期修改成本比较大。</li></ul><h3 id="Attribute-Set"><a href="#Attribute-Set" class="headerlink" title="Attribute Set"></a>Attribute Set</h3><p>负责定义和持有属性，并且管理属性的<u>变化</u>，包括<u>网络同步</u>。<br>需要在Actor中被添加为成员变量，并注册到ASC（C++）。<br>一个ASC可以拥有一个或多个（不同的）AttributeSet，因此可以角色共享一个很大的Attribute Set，也可以每个角色按需添加Attribute Set。<br>可以在属性变化前（PreAttributeChange）后（PostGameplayEffectExecute）处理相关逻辑，可以通过委托的方式绑定属性变化。</p><h3 id="Player-State"><a href="#Player-State" class="headerlink" title="Player State"></a>Player State</h3><div style="text-align: center;">  <img src="https://s2.loli.net/2025/11/21/N17ULdln2Ako5cI.png" alt="Player State 架构示意图" width="50%" /></div>PlayerState 是 Unreal Engine 中用于存储玩家相关信息的特殊 Actor 类。在多人游戏中，PlayerState 会自动在服务器和所有客户端之间复制，非常适合存储需要跨网络同步的玩家数据。<p>在 GAS 系统中，<u>ASC 可以选择挂载在 PlayerState 上而不是 Character 上</u>。这样做的好处是：</p><ul><li><strong>持久性</strong>：当角色死亡或重生时，PlayerState 依然存在，技能和属性数据不会丢失</li><li><strong>网络复制</strong>：PlayerState 天然支持网络复制，适合多人游戏场景</li><li><strong>UI 访问</strong>：UI 可以更方便地访问玩家的技能和属性信息，无需依赖具体的 Character 实例</li><li><strong>观察者模式</strong>：即使玩家处于观察者状态（没有 Character），也能保持技能系统的状态</li></ul><p>常见的做法是：</p><ul><li><strong>玩家控制的角色</strong>：ASC 放在 PlayerState 上</li><li><strong>AI 控制的角色</strong>：ASC 直接放在 Character 上</li></ul><h3 id="组件总结"><a href="#组件总结" class="headerlink" title="组件总结"></a>组件总结</h3><p>Visual：技能的视觉效果？GameplayCue<br>Async：技能的长时行动？(异步)GameplayTask<br>Send：技能的消息事件？GamePplayEvent<br>这俩是同一个东西</p><h2 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h2><h3 id="开启插件"><a href="#开启插件" class="headerlink" title="开启插件"></a>开启插件</h3><div style="text-align: center;">  <img src="https://s2.loli.net/2025/10/29/PxXeVshqdbliFYQ.png" alt="image-20251027203033649" width="50%" />  <img src="https://s2.loli.net/2025/10/29/TmQHkou6jg5PzSN.png" alt="image-20251027203540226" width="50%" /></div><ol><li><u>C++项目</u>，安装Gameplay Ability插件。</li><li>在Tools菜单下面有GameplayCue Editor有了，就说明开启成功了。</li><li>在新建的蓝图的页面可以看到GamePlay相关的东西</li></ol><h3 id="使用Rider快速添加Unreal类"><a href="#使用Rider快速添加Unreal类" class="headerlink" title="使用Rider快速添加Unreal类"></a>使用Rider快速添加Unreal类</h3><div style="text-align: center;">  <img src="https://s2.loli.net/2025/10/29/kqL2KOeURij69dr.png" alt="image-20251027215401030" width="50%" /></div><p>通过这里创建一个Character。可以快速拥有一些头文件。</p><h3 id="ASC组件架构"><a href="#ASC组件架构" class="headerlink" title="ASC组件架构"></a>ASC组件架构</h3><div class="mermaid" style="background: white; border: 1px solid #e1e1e1; border-radius: 4px; padding: 20px;">classDiagram  class ACharacter  class ARPGCharacterBase {    +AbilitySystemComponent  }  class BP_Character {    +公共逻辑  }  class BP_PlayerCharacter {    -组装Camera等组件    -输入绑定  }  class BP_NPCCharacter  ACharacter <|-- ARPGCharacterBase  ARPGCharacterBase <|-- BP_Character  BP_Character <|-- BP_PlayerCharacter  BP_Character <|-- BP_NPCCharacter</div><p>你需要自己创建一个继承自ACharacter的C++类。</p><p>之后想用蓝图，就从这个自定义的C++Character类派生就可以了。 </p><h3 id="写一个Base-GAS-ACharacter文件"><a href="#写一个Base-GAS-ACharacter文件" class="headerlink" title="写一个Base GAS ACharacter文件"></a>写一个Base GAS ACharacter文件</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PublicDependencyModuleNames.AddRange(<span class="keyword">new</span> <span class="built_in">string</span>[]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Core&quot;</span>, <span class="string">&quot;CoreUObject&quot;</span>, <span class="string">&quot;Engine&quot;</span>, <span class="string">&quot;InputCore&quot;</span>, <span class="string">&quot;EnhancedInput&quot;</span>,</span><br><span class="line">    <span class="string">&quot;GameplayAbilities&quot;</span>,<span class="string">&quot;GameplayTags&quot;</span>,<span class="string">&quot;GameplayTasks&quot;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>在Build文件里添加如下的内容GameplayAbilities、GameplayTags、GameplayTasks。</p><p>在头文件里面添加一个AbilitySystemComponent，直接在角色上挂载 AbilitySystemComponent（ASC），可以适配多人游戏。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TObjectPtr&lt;UTCGAbilitySystemComponent&gt; AbilitySystemComponent;</span><br></pre></td></tr></table></figure><p>在.cpp中构造函数部分实例化AbilitySystemComponent（ASC）。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例化ASC</span></span><br><span class="line">AbilitySystemComponent = <span class="built_in">CreateDefaultSubobject</span>&lt;UAbilitySystemComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;AbilitySystem&quot;</span>));</span><br></pre></td></tr></table></figure><p>角色类继承IAbilitySystemInterface接口，并实现GetASC函数</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AbilitySystemInterface.h&quot;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ARPG_UNREAL_API</span> ACharacterBase : <span class="keyword">public</span> ACharacter, <span class="keyword">public</span> IAbilitySystemInterface</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function">UAbilitySystemComponent* <span class="title">GetAbilitySystemComponent</span><span class="params">()</span><span class="type">const</span> <span class="keyword">override</span></span>;</span><br></pre></td></tr></table></figure><p>在CPP中实现</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UAbilitySystemComponent* <span class="title">ACharacterBase::GetAbilitySystemComponent</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> AbilitySystemComponent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>👆这里的return即使写为null，也可能可能调用</p><p><em>这个在项目中的路径在：Source&#x2F;TCG_AwesomeLive&#x2F;CharacterSystem&#x2F;TCGCharacterBase.h</em></p><h3 id="把GA数组加入到Actor中"><a href="#把GA数组加入到Actor中" class="headerlink" title="把GA数组加入到Actor中"></a>把GA数组加入到Actor中</h3><p>可以将UE原生的UGameplayAbility直接加入到需要Ability的Actor中（也是加到这个Base GAS ACharacter文件中）</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>(BlueprintReadOnly, EditAnywhere, Category = <span class="string">&quot;Test|Abilities&quot;</span>)</span><br><span class="line">TArray&lt;TSubclassOf&lt;UGameplayAbility&gt;&gt; CharacterAbilities;</span><br></pre></td></tr></table></figure><p><strong>在C++中赋予GA</strong>：我们可以将我们所有的技能储存在一张DA表之中，然后从DA表里读取数据，并使用AbilitySystemComponent-&gt;GiveAbility将数据赋予ASC。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加能力</span></span><br><span class="line"><span class="keyword">for</span>(FTCGAblityInfo&amp; Info : AllAbilitiesInfo)&#123;</span><br><span class="line">    <span class="keyword">if</span> (Info.AbilityClass == <span class="literal">nullptr</span>)</span><br><span class="line">       <span class="keyword">continue</span>;</span><br><span class="line">    CharacterAbilities.<span class="built_in">Add</span>(Info.AbilityClass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> StartupAbility : CharacterAbilities)</span><br><span class="line">&#123;</span><br><span class="line">    AbilitySystemComponent-&gt;<span class="built_in">GiveAbility</span>(</span><br><span class="line">       <span class="built_in">FGameplayAbilitySpec</span>(StartupAbility, <span class="number">1</span>, INDEX_NONE, <span class="keyword">this</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样我们就可以在继承了Base Character的子类中，看到Ability的选项了。</p><div style="text-align: center;">  <img src="https://s2.loli.net/2025/10/29/KYsEzGVCQ1Ibwre.png" alt="image-20251028184812916" width="50%" /></div>赋予GA的方式有很多，比如在需要的蓝图中调用<u>Give Ability</u>节点。还可以使用GE赋予GA。<p>在官方的Lyra案例里面使用AbilitySet来储存一类Ability，通过加载来实现赋予。参看下文Unreal官方案例“赋予GA”部分。</p><h2 id="Unreal官方案例"><a href="#Unreal官方案例" class="headerlink" title="Unreal官方案例"></a>Unreal官方案例</h2><p>UE中有一个非常不错的官方示例<a href="https://dev.epicgames.com/documentation/zh-cn/unreal-engine/lyra-sample-game-in-unreal-engine?application_version=5.0">Lyra</a>里面展示了一个完整的GAS系统。</p><h3 id="项目里的设置"><a href="#项目里的设置" class="headerlink" title="项目里的设置"></a>项目里的设置</h3><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/zWIduBsAxTriGkX.png" alt="image-20251111183652281" width="50%" /></div><p>这个项目里开发者设置了一些调整选项，可以设定一些debug的参数。</p><p>比如子弹射击停留时间，生成的bot的数量。</p><h3 id="项目蓝图常见前缀标识"><a href="#项目蓝图常见前缀标识" class="headerlink" title="项目蓝图常见前缀标识"></a>项目蓝图常见前缀标识</h3><p><strong>WID_</strong><br>全称可理解为 Weapon Item Definition。<br>用途：武器类的“物品定义”蓝图资产，继承自 ULyraInventoryItemDefinition（你在代码里看到的基类）。<br><strong>ID_</strong><br>可理解为（Generic）Item Definition。<br>用途：非武器的一般物品定义（比如消耗品、弹药、包裹、可堆叠资源等）也继承 ULyraInventoryItemDefinition，用 ID_ 前缀区分与 WID_（武器专用）资产。<br><strong>B</strong>_<br>B_ 前缀在 Lyra 中通常代表一个 Blueprint 类资产（等同很多团队常用的 BP_，Lyra 项目里取了更短的 B_）。</p><h3 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h3><ul><li>这一部分我主要参考的是<a href="https://zhuanlan.zhihu.com/p/1934717850632823338">这里</a>加上了一些我自己的补充。整体结构采用了原本的结构，但是有我自己的删减，可以对照地看。</li></ul><h4 id="初始化Ability-System"><a href="#初始化Ability-System" class="headerlink" title="初始化Ability System"></a>初始化Ability System</h4><h5 id="创建ASC"><a href="#创建ASC" class="headerlink" title="创建ASC"></a>创建ASC</h5><p>ASC用于总体控制GAS功能，可以挂在Character上或者PlayerState上，对于角色会死亡重生的场景，挂在PlayerState上更合适，不会因Character销毁而丢失数据。因此Lyra选择把ASC挂在了PlayerState上，这样还有额外作用，就是按Tab键显示计分板这种战斗无关的功能，也可以用GA实现，以往的习惯都是硬编码。</p><p>ULyraAbilitySystemComponent本身是一个Manager，与数据无关，所以PlayerState直接New了一个对象即可：</p><blockquote><p>Source&#x2F;LyraGame&#x2F;GameModes&#x2F;LyraGameState.h&#x2F;cpp</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明</span></span><br><span class="line"><span class="built_in">UPROPERTY</span>(VisibleAnywhere, Category = <span class="string">&quot;Lyra|PlayerState&quot;</span>)</span><br><span class="line">TObjectPtr&lt;ULyraAbilitySystemComponent&gt; AbilitySystemComponent;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建</span></span><br><span class="line">AbilitySystemComponent = ObjectInitializer.<span class="built_in">CreateDefaultSubobject</span>&lt;ULyraAbilitySystemComponent&gt;(<span class="keyword">this</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;AbilitySystemComponent&quot;</span>));</span><br><span class="line">AbilitySystemComponent-&gt;<span class="built_in">SetIsReplicated</span>(<span class="literal">true</span>);</span><br><span class="line">AbilitySystemComponent-&gt;<span class="built_in">SetReplicationMode</span>(EGameplayEffectReplicationMode::Mixed);</span><br></pre></td></tr></table></figure><h5 id="ASC里面也会记录Actor"><a href="#ASC里面也会记录Actor" class="headerlink" title="ASC里面也会记录Actor"></a>ASC里面也会记录Actor</h5><blockquote><p>Plugins&#x2F;Runtime&#x2F;GameplayAbilities&#x2F;Source&#x2F;GameplayAbilities&#x2F;Public&#x2F;AbilitySystemComponent.h</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The actor that owns this component logically */</span></span><br><span class="line">    <span class="built_in">UPROPERTY</span>(ReplicatedUsing = OnRep_OwningActor)</span><br><span class="line">    TObjectPtr&lt;AActor&gt; OwnerActor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The actor that is the physical representation used for abilities. Can be NULL */</span></span><br><span class="line">    <span class="built_in">UPROPERTY</span>(ReplicatedUsing = OnRep_OwningActor)</span><br><span class="line">    TObjectPtr&lt;AActor&gt; AvatarActor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Cached off data about the owning actor that abilities will need to frequently access (movement component, mesh component, anim instance, etc) */</span></span><br><span class="line">    TSharedPtr&lt;FGameplayAbilityActorInfo&gt;  AbilityActorInfo;</span><br></pre></td></tr></table></figure><p>ASC也会记录关联Actor的信息：</p><p><strong>OwnerActor</strong>挂在哪个Actor上，这里是PlayerState；</p><p><strong>AvatarActor</strong>是使用Ability实体，这里是Character。</p><p>这两个属性是ASC经常要获取的变量，除此之外，还有多个与Actor关联的属性会被高频读取，为了提高读取性能，ASC索性把它们复制了一份，集中存储在<strong>AbilityActorInfo</strong>变量中，包括了PlayerController，SkeletalMeshComponent，AnimInstance，MovementComponent，AffectedAnimInstanceTag。</p><h5 id="赋予GA（前建立Experience做数据衔接）"><a href="#赋予GA（前建立Experience做数据衔接）" class="headerlink" title="赋予GA（前建立Experience做数据衔接）"></a>赋予GA（前建立Experience做数据衔接）</h5><p>创建完ASC后，要往这个容器里赋予GA了，表示Actor有这些能力。</p><p>Lyra工程高度模块化，配置比较分散，使用AbilitySet来储存一类Ability，通过加载来实现自动化配置和赋予GA。</p><p>首先创建一个Experience，<u>首先什么是Experience？</u></p><ul><li><p>定义角色： Experience（通过 ULyraExperienceDefinition）把一组运行时行为、资源和规则打包成一个可切换的体验（例如不同模式、地图或玩法配置）。</p></li><li><p>主要用途：在游戏启动或切换体验时告诉引擎“要启用哪些 GameFeatures、默认的 Pawn 数据、以及需要执行哪些动作&#x2F;赋能”</p></li><li><p>原因</p><ul><li>统一配置与可切换性：把调表（技能、效果、默认 pawn 等）放到 Experience 里，便于在不同玩法&#x2F;模式间切换和复用，不用把能力写死在代码里。</li><li>数据驱动与延迟加载：Experience 可以在运行时启&#x2F;停 GameFeatures、注入资源，再把需要的能力&#x2F;效果批量下发。</li><li>作用域与生命周期可控：通过 Experience 可以在启用时授予、停用时撤销，方便整体管理和热加载。</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>(BlueprintType, Const)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ULyraExperienceDefinition</span> : <span class="keyword">public</span> UPrimaryDataAsset</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">UPROPERTY</span>(EditDefaultsOnly, Category = Gameplay)</span><br><span class="line">    TArray&lt;FString&gt; GameFeaturesToEnable;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UPROPERTY</span>(EditDefaultsOnly, Category=Gameplay)</span><br><span class="line">    TObjectPtr&lt;<span class="type">const</span> ULyraPawnData&gt; DefaultPawnData;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UPROPERTY</span>(EditDefaultsOnly, Instanced, Category=<span class="string">&quot;Actions&quot;</span>)</span><br><span class="line">    TArray&lt;TObjectPtr&lt;UGameFeatureAction&gt;&gt; Actions;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UPROPERTY</span>(EditDefaultsOnly, Category=Gameplay)</span><br><span class="line">    TArray&lt;TObjectPtr&lt;ULyraExperienceActionSet&gt;&gt; ActionSets;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>如图Lyra的结构。</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/jlbEy7vf4z2D6xF.png" alt="image-20251111172739503" width="50%" /></div><p>继承自ULyraExperienceDefinition的：B_BasicShooterTestB_BasicShooterTest这个数据类里的Action分组里面，有需要授予的GA的DA表。</p><p>比如：**AbilitySet_<strong>Elimination（下面那个） 和 HeroData_ShooterGame里面的</strong>AbilitySet_**ShooterHero。</p><ul><li>首先看AbilitySet_Elimination  DA表（它继承自LyraAbilitySet）。</li></ul><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/khSfJeNB3I5Fvcq.png" alt="image-20251111171556976" width="50%" /></div><p>  打开这个AbilitySet_Elimination，里面包含两个GA。<br>  GA_ShowLeaderboard_TDM用于按Tab显示计分板。<br>  GA_AutoRespawn用于死亡复活，这两个GA与Character战斗无关，在没用Character时也能执行。</p><ul><li>然后看AbilitySet_ShooterPistol DA表（储存在总表的HeroData_ShooterGame里面 它继承自ULyraPawnData）</li></ul><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/abXfUKiehOG3lHs.png" alt="image-20251111174500121" width="50%" /></div><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/4Zt68goQNHmdsOk.png" alt="AbilitySet_ShooterHero" width="50%" /></div><p>  包含Character相关的GA，数量较多。比如GA_Hero_Jump实现了跳跃，GA_Emote实现了跳舞。</p><ul><li>然后还有一个AbilitySet_ShooterPisto</li></ul><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/ls8hrwJVOjfkMZF.png" alt="image-20251111181356512" width="50%" /></div><p>  它不是定义在B_BasicShooterTestB_BasicShooterTest这张大表里面的。</p><p>  而是通过WID_Pistol被具体的蓝图调用。</p><p>然后对每个GA，调用UAbilitySystemComponent::GiveAbility函数进行赋予。</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/Je2w7BSxbQEapTV.png" alt="image-20251111185235151" style="zoom:25%;" / width="50%" /></div><p>会在很多地方调用。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FGameplayAbilitySpecHandle <span class="title">UAbilitySystemComponent::GiveAbility</span><span class="params">(<span class="type">const</span> FGameplayAbilitySpec&amp; Spec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ABILITYLIST_SCOPE_LOCK</span>();</span><br><span class="line">    FGameplayAbilitySpec&amp; OwnedSpec = ActivatableAbilities.Items[ActivatableAbilities.Items.<span class="built_in">Add</span>(Spec)];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (OwnedSpec.Ability-&gt;<span class="built_in">GetInstancingPolicy</span>() == EGameplayAbilityInstancingPolicy::InstancedPerActor)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="comment">// Create the instance at creation time</span></span><br><span class="line">       <span class="built_in">CreateNewInstanceOfAbility</span>(OwnedSpec, Spec.Ability);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">OnGiveAbility</span>(OwnedSpec);</span><br><span class="line">    <span class="built_in">MarkAbilitySpecDirty</span>(OwnedSpec, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogAbilitySystem, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s: GiveAbility %s [%s] Level: %d Source: %s&quot;</span>), *<span class="built_in">GetNameSafe</span>(<span class="built_in">GetOwner</span>()), *<span class="built_in">GetNameSafe</span>(Spec.Ability), *Spec.Handle.<span class="built_in">ToString</span>(), Spec.Level, *<span class="built_in">GetNameSafe</span>(Spec.SourceObject.<span class="built_in">Get</span>()));</span><br><span class="line">    <span class="built_in">UE_VLOG</span>(<span class="built_in">GetOwner</span>(), VLogAbilitySystem, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;GiveAbility %s [%s] Level: %d Source: %s&quot;</span>), *<span class="built_in">GetNameSafe</span>(Spec.Ability), *Spec.Handle.<span class="built_in">ToString</span>(), Spec.Level, *<span class="built_in">GetNameSafe</span>(Spec.SourceObject.<span class="built_in">Get</span>()));</span><br><span class="line">    <span class="keyword">return</span> OwnedSpec.Handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数参数为FGameplayAbilitySpec，表示“这次赋予”的描述信息。</p><p>不仅包含这次赋予的描述信息，比如GA的Class，指定GA的等级，GA绑定的输入Tag。而且也是GA在ASC上的runtime表示，有很多runtime信息。每个Spec都有唯一的ID，称为Handle，通过自增赋予，各系统间Spec的传递都通过Handle实现。</p><p>值得注意的是Spec.SourceObject属性，表示这个GA所关联的最“密切”的Object，在创建时由我们指定。<br>比如GA_Weapon_Fire_Pistol，是枪开火的GA，SourceObject就是武器B_WeaponInstance_Pistol；<br>GA_Hero_Jump是角色跳跃的GA，SourceObejct就是Character；<br>GA_ShowLeaderboard_TDM则是与战斗无关的打开计分板的GA，OurceObject就是PlayerStat。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">USTRUCT(BlueprintType)</span><br><span class="line">struct GAMEPLAYABILITIES_API FGameplayAbilitySpec : public FFastArraySerializerItem</span><br><span class="line">&#123;</span><br><span class="line">GENERATED_USTRUCT_BODY()</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    UPROPERTY(NotReplicated)</span><br><span class="line">    TArray&lt;TObjectPtr&lt;UGameplayAbility&gt;&gt; NonReplicatedInstances;</span><br><span class="line"></span><br><span class="line">    UPROPERTY()</span><br><span class="line">    TArray&lt;TObjectPtr&lt;UGameplayAbility&gt;&gt; ReplicatedInstances;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加时，首先把Spec加入到ActivatableAbilities数组中，然后根据Policy创建一个GA的实例，默认的InstancedPerActor是要创建的。创建完成后，如果GA设置为网络同步，就加入到Spec.ReplicatedInstances中，否则加入Spec.NonReplicatedInstances。</p><h5 id="注册Trigger"><a href="#注册Trigger" class="headerlink" title="注册Trigger"></a>注册Trigger</h5><p>GA可以绑定一些Trigger，实际是Tag，当发出GamePlayEvent，并指定对应Tag后，就能激活GA了。</p><p>所以这里的Tag为了更方便做判断具体的GA。</p><ul><li>首先是InputTag，它本身非GAS框架内的，是Lyra自己做的一套输入和GA的映射。InputTag在AbilitySet中指定</li></ul><p><img src="https://s2.loli.net/2025/11/21/DQgqibLETr14JHR.png" alt="image-20251111191635777">AbilitySet_ShooterPisto</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/FAmWtpUSy94lQez.png" alt="image-20251111191708052" width="50%" /></div><p>AbilitySet_ShooterPistol </p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/1yWC6gVZHb38UPz.png" alt="image-20251111191718509" width="50%" /></div><p>AbilitySet_ShooterPisto</p><p>创建Spec时会把InputTag添加到其DynamicSpecSourceTags，DynamicSpecSourceTags是一个通用Tag容器。<br>该Tags在结构体FGameplayAbilitySpec里面，<u>也就是说，一个FGameplayAbilitySpec代表的是传递的一个Ability的能力，然后里面有很多DynamicAbilityTags</u>。</p><p>注册的路径如下：</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/AzSXP7UNWFsfot1.png" alt="image-20251111205815528" width="50%" /></div><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ULyraAbilitySet::GiveToAbilitySystem</span><span class="params">(ULyraAbilitySystemComponent* LyraASC, FLyraAbilitySet_GrantedHandles* OutGrantedHandles, UObject* SourceObject)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Grant the attribute sets.</span></span><br><span class="line">    <span class="keyword">for</span> (int32 SetIndex = <span class="number">0</span>; SetIndex &lt; GrantedAttributes.<span class="built_in">Num</span>(); ++SetIndex)</span><br><span class="line">    &#123;</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Grant the gameplay abilities.</span></span><br><span class="line">    <span class="keyword">for</span> (int32 AbilityIndex = <span class="number">0</span>; AbilityIndex &lt; GrantedGameplayAbilities.<span class="built_in">Num</span>(); ++AbilityIndex)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="type">const</span> FLyraAbilitySet_GameplayAbility&amp; AbilityToGrant = GrantedGameplayAbilities[AbilityIndex];</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(AbilityToGrant.Ability))</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="built_in">UE_LOG</span>(LogLyraAbilitySystem, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;GrantedGameplayAbilities[%d] on ability set [%s] is not valid.&quot;</span>), AbilityIndex, *<span class="built_in">GetNameSafe</span>(<span class="keyword">this</span>));</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ULyraGameplayAbility* AbilityCDO = AbilityToGrant.Ability-&gt;<span class="built_in">GetDefaultObject</span>&lt;ULyraGameplayAbility&gt;();</span><br><span class="line"></span><br><span class="line">       <span class="function">FGameplayAbilitySpec <span class="title">AbilitySpec</span><span class="params">(AbilityCDO, AbilityToGrant.AbilityLevel)</span></span>;</span><br><span class="line">       AbilitySpec.SourceObject = SourceObject;</span><br><span class="line">       AbilitySpec.<span class="built_in">GetDynamicSpecSourceTags</span>().<span class="built_in">AddTag</span>(AbilityToGrant.InputTag);</span><br><span class="line"></span><br><span class="line">       <span class="type">const</span> FGameplayAbilitySpecHandle AbilitySpecHandle = LyraASC-&gt;<span class="built_in">GiveAbility</span>(AbilitySpec);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (OutGrantedHandles)</span><br><span class="line">       &#123;</span><br><span class="line">          OutGrantedHandles-&gt;<span class="built_in">AddAbilitySpecHandle</span>(AbilitySpecHandle);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Grant the gameplay effects.</span></span><br><span class="line">    <span class="keyword">for</span> (int32 EffectIndex = <span class="number">0</span>; EffectIndex &lt; GrantedGameplayEffects.<span class="built_in">Num</span>(); ++EffectIndex)</span><br><span class="line">    &#123;</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在授予ASC Ability的时候，将Tags Effect等信息一并传入。</p><p>授予GA的逻辑，以上就是服务器初始化ASC并赋予GA的全部过程。</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/4H9xKOcQBbezAFY.png" alt="image-20251111210326498" width="50%" /></div><h4 id="同步客户端"><a href="#同步客户端" class="headerlink" title="同步客户端"></a>同步客户端</h4><h5 id="ASC"><a href="#ASC" class="headerlink" title="ASC"></a>ASC</h5><p>首先，ASC作为一个Component挂在PlayerState上，是可以同步的。</p><p>由于AvatarActor是Character，因此OwnerActor和AvatarActor的最终设置，需要客户端的Character创建后才能执行。</p><p>具体为Character创建后，触发LyraHeroComponent的加载资源流程，当加载完成并且客户端获取到PlayerState后，就把当前阶段设置为DataAvailabe，并最终设置OwnerActor和AvatarActor。</p><h5 id="GASpec"><a href="#GASpec" class="headerlink" title="GASpec"></a>GASpec</h5><p>Spec存于ActivatableAbilities容器中，本身是FastArray，标记了Replicated，可正常网络同步</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>(ReplicatedUsing = OnRep_ActivateAbilities, BlueprintReadOnly, Transient, Category = <span class="string">&quot;Abilities&quot;</span>)</span><br><span class="line">FGameplayAbilitySpecContainer ActivatableAbilities;</span><br></pre></td></tr></table></figure><p>Spec同步到客户端后，FastArray会触发FGameplayAbilitySpec::PostReplicatedAdd()方法，里面再和服务器同样的UAbilitySystemComponent::OnGiveAbility()方法来注册Spec。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FGameplayAbilitySpec::PostReplicatedAdd</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> FGameplayAbilitySpecContainer&amp; InArraySerializer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (InArraySerializer.Owner)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        InArraySerializer.Owner-&gt;<span class="built_in">OnGiveAbility</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于不同步但InstancedPerActor的GA，会在此时创建实例，加入到NonReplicatedInstances数组，然后再注册AbilityTriggers。</p><h5 id="Spec的GA实例"><a href="#Spec的GA实例" class="headerlink" title="Spec的GA实例"></a>Spec的GA实例</h5><p>首先，GA实例只同步给Autonomous客户端，不会同步给SimulateProxy。然后，会把GA实例作为ASC的SubObject进行同步，这是SubObject同步是UE自身支持的机制。</p><p>主要代码如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//同步GA</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UAbilitySystemComponent::AddReplicatedInstancedAbility</span><span class="params">(UGameplayAbility* GameplayAbility)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="type">const</span> ELifetimeCondition LifetimeCondition = bReplicateAbilitiesToSimulatedProxies ? COND_None : COND_ReplayOrOwner;</span><br><span class="line">    <span class="built_in">AddReplicatedSubObject</span>(GameplayAbility, LifetimeCondition);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubObject同步</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UActorComponent::AddReplicatedSubObject</span><span class="params">(UObject* SubObject, ELifetimeCondition NetCondition)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (AActor* MyOwner=<span class="built_in">GetOwner</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        MyOwner-&gt;<span class="built_in">AddActorComponentReplicatedSubObject</span>(<span class="keyword">this</span>, SubObject, NetCondition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同步到客户端后表现如下：</p><div style="text-align: center;"><img src="https://pic2.zhimg.com/v2-64548e8ebc3b26b89cb095f2c552d39d_1440w.jpg" alt="img" width="50%" /></div><h2 id="常用调整命令行"><a href="#常用调整命令行" class="headerlink" title="常用调整命令行"></a>常用调整命令行</h2><p>ShowDebug AbilitySystem 展示Ability相关的内容</p><h2 id="踩坑记录"><a href="#踩坑记录" class="headerlink" title="踩坑记录"></a>踩坑记录</h2><h3 id="GAS网络生成的BP需要考虑所有者"><a href="#GAS网络生成的BP需要考虑所有者" class="headerlink" title="GAS网络生成的BP需要考虑所有者"></a>GAS网络生成的BP需要考虑所有者</h3><p><img src="https://s2.loli.net/2025/11/21/YdyXqrBw7hKoGuT.png" alt="image-20251114160307855" style="zoom:25%;" /><img src="https://s2.loli.net/2025/11/21/KmIpqniL5s7ESuj.png" alt="image-20251114160401410" style="zoom: 33%;" /></p><p>如果是在Server端生成的BP，一定要指定“Owner”，它意味着是这个生成的东西在各网络设备之间指定的所有者。<br>当这个所有者内部需要执行一个网络的Event的时候，它需要通知一个客户端，如果没有Owner，这个Event会被拒绝执行。</p><h3 id="随机数问题"><a href="#随机数问题" class="headerlink" title="随机数问题"></a>随机数问题</h3><p>注意网络端和服务端生成随机数会不一样。</p><h3 id="在GE里拿到“事件触发者”和“事件被影响者”"><a href="#在GE里拿到“事件触发者”和“事件被影响者”" class="headerlink" title="在GE里拿到“事件触发者”和“事件被影响者”"></a>在GE里拿到“事件触发者”和“事件被影响者”</h3><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/21/D9VA2s5EpevFXxL.png" alt="image-20251120172105945" width="50%" /></div><p>如上图，我有一个需求，投掷物。<br>需要给GE传递“投掷物这个物体”和“被撞的人”。<br>其中，在我这里，“被撞的人”是要执行的ASC的所有者（即这里的Instigator），在应用GE的时候必须提供。</p><p>调用 BP_ApplyGameplayEffectToTarget 时，它内部会：</p><ul><li>用「作为 Target 的 ASC 的 Owner &#x2F; Avatar Actor」来构造 FGameplayEffectContextHandle；</li><li>在这个 EffectContext 里自动填好 Instigator、EffectCauser 等字段；</li><li>把这个 EffectContext 放进 FGameplayEffectSpec，最后应用到 Target；</li></ul><p>（正如图上所示，它其实有两个Target节点，上面那个是调用这个事件的Target（蓝图中常见），下面那个是被命中的“被撞的人”，因为碰巧都叫Target所以在这里重复了）</p><p>这个比较好理解。但，实际上GC一个内部结构里，有三个储存用来表达“事件责任相关人”的变量：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>(BlueprintType, meta = (HasNativeBreak = <span class="string">&quot;/Script/GameplayAbilities.AbilitySystemBlueprintLibrary.BreakGameplayCueParameters&quot;</span>, HasNativeMake = <span class="string">&quot;/Script/GameplayAbilities.AbilitySystemBlueprintLibrary.MakeGameplayCueParameters&quot;</span>))</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FGameplayCueParameters</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">GENERATED_USTRUCT_BODY</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Instigator actor, the actor that owns the ability system component */</span></span><br><span class="line">    <span class="built_in">UPROPERTY</span>(BlueprintReadWrite, Category=GameplayCue)</span><br><span class="line">    TWeakObjectPtr&lt;AActor&gt; Instigator;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The physical actor that actually did the damage, can be a weapon or projectile */</span></span><br><span class="line">    <span class="built_in">UPROPERTY</span>(BlueprintReadWrite, Category=GameplayCue)</span><br><span class="line">    TWeakObjectPtr&lt;AActor&gt; EffectCauser;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Object this effect was created from, can be an actor or static object. Useful to bind an effect to a gameplay object */</span></span><br><span class="line">    <span class="built_in">UPROPERTY</span>(BlueprintReadWrite, Category=GameplayCue)</span><br><span class="line">    TWeakObjectPtr&lt;<span class="type">const</span> UObject&gt; SourceObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在文件UE_5.6\Engine\Plugins\Runtime\GameplayAbilities\Source\GameplayAbilities\Public\GameplayEffectTypes.h中</p><p>这三个分别是：Instigator、EffectCauser、SourceObject。</p><p>按照说明，他们“责任”分别的作用是</p><ul><li>Instigator：谁是「施加这个效果的控制者」，通常是 Pawn&#x2F;Character。</li><li>EffectCauser：是哪一个 Actor&#x2F;Component「具体造成了这次效果」，比如武器、投掷物。</li><li>SourceObject：一个完全开放给你用的 UObject*，可以是武器实例、技能实例、DataAsset、投掷物等。</li></ul><p>这三个字段的值，不一定都有，是否自动填，取决于你走的 GAS 调用路径。通常应用的路径上，Instigator和EffectCauser都是同一个值，都是这个ASC的拥有者。但是SourceObject通常是空的（通过GA主动和触发的GE有机会把GA的SourceObejct传入进去），所以可以自己指定，用作自己的参数。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li><p><a href="https://www.bilibili.com/video/BV1X5411V7jh/">官方教学视频</a>:我看着这个视频作为最初的入门</p></li><li><p><a href="https://zhuanlan.zhihu.com/p/486808688">知乎GAS系统快速入门</a></p></li><li><p><a href="https://dev.epicgames.com/documentation/zh-cn/unreal-engine/gameplay-ability-system-for-unreal-engine">Unreal官方的GAS讲解</a></p></li><li><p><a href="https://www.bilibili.com/video/BV1vj4vzkELp?spm_id_from=333.788.player.switch&vd_source=60b376a57ab956cf81ad81ef20747a92&p=14">关于GA的讲解</a>：别忘了可以点开B站的AI翻译</p></li><li><p><a href="https://www.bilibili.com/video/BV1Nv42127HS">一个很不错的关于</a>GAS系统实操讲解</p></li><li><p><a href="https://www.bilibili.com/video/BV1K7421Z7vm/">一个很不错的Lyra示例的讲解</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/1934717850632823338">文字讲解Lyra结构</a>适合作为研究基础，然后配合上面的视频看。</p></li></ol>]]></content:encoded>
      
      
      
      <category domain="http://example.com/tags/Unreal-Engine/">Unreal Engine</category>
      
      <category domain="http://example.com/tags/Game-Development/">Game Development</category>
      
      <category domain="http://example.com/tags/Gameplay-Ability-System/">Gameplay Ability System</category>
      
      <category domain="http://example.com/tags/GAS/">GAS</category>
      
      <category domain="http://example.com/tags/C/">C++</category>
      
      <category domain="http://example.com/tags/Network-Programming/">Network Programming</category>
      
      <category domain="http://example.com/tags/RPG/">RPG</category>
      
      <category domain="http://example.com/tags/Game-Framework/">Game Framework</category>
      
      
      <comments>http://example.com/2025/09/21/Notes/UE5%20GAS%20Learning%20Notes/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Aximmetry Learning Notes</title>
      <link>http://example.com/2025/09/13/Notes/Aximmetry/</link>
      <guid>http://example.com/2025/09/13/Notes/Aximmetry/</guid>
      <pubDate>Sat, 13 Sep 2025 04:34:56 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Aximmetry-低成本XR方案折腾笔记&quot;&gt;&lt;a href=&quot;#Aximmetry-低成本XR方案折腾笔记&quot; class=&quot;headerlink&quot; title=&quot;Aximmetry 低成本XR方案折腾笔记&quot;&gt;&lt;/a&gt;Aximmetry 低成本XR方案折腾笔记&lt;/</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Aximmetry-低成本XR方案折腾笔记"><a href="#Aximmetry-低成本XR方案折腾笔记" class="headerlink" title="Aximmetry 低成本XR方案折腾笔记"></a>Aximmetry 低成本XR方案折腾笔记</h1><h2 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h2><p>我需要搭建出一套非常低成本的XR方案，调研的时候考虑国内一些自研方案，以及Hecoos等主流方案，测试期暂时使用Aximmetry作为演示方案。以下是Aximmetry在本次测试中所使用到的内容。</p><h3 id="各版本之间的区别"><a href="#各版本之间的区别" class="headerlink" title="各版本之间的区别"></a>各版本之间的区别</h3><ol><li><strong>Studio Edition</strong>（工作室版）：适合非常小的或家庭工作室，如 YouTube 创作者等。该版本可通过 HDMI 或 USB 采集设备在一台 PC 上使用多个摄像头，可通过显卡的 HDMI&#x2F;DP&#x2F;DVI 端口生成一个或多个视频输出，还可直接将输出流式传输到 YouTube、Facebook、Twitch 或任何基于 RTMP 的视频服务。带水印的 Studio 版本可无限期用于非商业用途，也可通过订阅计划去除水印。</li><li><strong>Professional Edition</strong>（专业版）：适用于小型专业工作室，支持在一台 PC 上最多使用 4 个 SDI&#x2F;ndi 输入 &#x2F; 输出端口，如 3 个 SDI 摄像机输入和 1 个 SDI 复合输出，且不需要任何摄像机跟踪解决方案，仅使用固定摄像机与虚拟摄像机运动。</li><li><strong>Broadcast Edition</strong>（广播版）：适用于需要摄像机跟踪功能的专业工作室，可在一台 PC 上设置无限数量的 SDI&#x2F;ndi 输入 &#x2F; 输出端口（仅受硬件性能限制），也可在多 PC 配置中使用。此外，广播版还具备先进的混合现实解决方案，支持多摄像机跟踪、行业标准的色度键控器、高质量实时图形、摄像机偏移和镜头畸变的自动校准等功能。</li></ol><h2 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h2><h3 id="使用环境的基本内容"><a href="#使用环境的基本内容" class="headerlink" title="使用环境的基本内容"></a>使用环境的基本内容</h3><table><thead><tr><th align="center">软件名字</th><th align="center">版本</th><th align="left">备注</th></tr></thead><tbody><tr><td align="center">Aximmetry Composer</td><td align="center"><img src="https://s2.loli.net/2025/10/10/lEkaSNv1s2z4dqC.png" alt="image-20251009155943445" style="zoom: 20%;" /></td><td align="left">这个软件是主要用来做合成和接收跟踪内容的</td></tr><tr><td align="center">Aximmetry UE</td><td align="center"><img src="https://s2.loli.net/2025/10/10/KUfiXBt4mxwEL8Z.png" alt="image-20251009160407488" style="zoom:20%;" /></td><td align="left">Aximmetry自己改的UE，他们有修改渲染管线（目测是为了加水印）。他们该版本的引擎是基于UE5.5进行修改的。可以看到在引擎的插件目录里有两个插件。有源码也没有引入外部的库。但是Aximmetry修改了渲染管线，猜测是防止盗版。</td></tr><tr><td align="center">UE工程</td><td align="center">5.5</td><td align="left">一个使用Aximmetry UE制作的场景。建议创建一个5.5的原始的UE工程，方便将插件重新编译及测试插件。</td></tr></tbody></table><h3 id="建立基本的工程"><a href="#建立基本的工程" class="headerlink" title="建立基本的工程"></a>建立基本的工程</h3><h4 id="进入工程的设置"><a href="#进入工程的设置" class="headerlink" title="进入工程的设置"></a>进入工程的设置</h4><div align="center"><img src="https://s2.loli.net/2025/10/10/knatfO9CcYjvASd.png" alt="image-20251009155003718" style="zoom: 20%;" /></div><p>在Composer的开始设置中，主要考虑输入的内容（左边的输入设置），这个是实景的拍摄相机。输出视频的大小（右边的输出设置），这个是最终输出画面的设置。以及下面的UE渲染设置。</p><h4 id="节点设置"><a href="#节点设置" class="headerlink" title="节点设置"></a>节点设置</h4><div align="center"><img src="https://s2.loli.net/2025/10/10/T4rdGiu85asXlDe.png" alt="image-20251009161750537" style="zoom: 20%;" /></div><ol><li>VirtualCam节点：工程里添加一个镜头，如图连线。</li><li>主节点：里面添加镜头和工程，并使用Live模式。</li><li>Green：添加测试用到视频素材，这里可以使用一个绿幕素材，Aximmetry会自动对其进行抠像。</li><li>Camera Tracking：相机追踪节点，这里面的选项待会儿要<u>填写上AximmetryEye</u></li></ol><p>完成之后点击Composer上面的Play按钮，且让工程在编辑器状态下运行起来，就会有合成的画面了。</p><h4 id="设置UE内容"><a href="#设置UE内容" class="headerlink" title="设置UE内容"></a>设置UE内容</h4><div align="center"><img src="https://s2.loli.net/2025/10/27/7NWYjuvm6zro2ng.png" alt="image-20251011142232445" style="zoom: 20%;" /></div><p>在场景中添加相机。</p><h3 id="设置相机运镜"><a href="#设置相机运镜" class="headerlink" title="设置相机运镜"></a>设置相机运镜</h3><h4 id="手动设置"><a href="#手动设置" class="headerlink" title="手动设置"></a>手动设置</h4><div align="center"><img src="https://s2.loli.net/2025/10/10/PUwAjTpJatG6O9s.png" alt="image-20250930144118468" style="zoom: 20%;" /></div><p>在这里可以用来设置相机的运动属性等信息。A和B代表着起始点和最终点。点击最左边的按钮可以让相机运动起来。</p><p>点击“摄影机&#x2F;渲染设置”的编辑操作，可以在Aximmetry的渲染出来的窗口画面里，直接拖动相机位置。使用↑↓←→按钮调整相机坐标。</p><h4 id="Iphone相机跟踪"><a href="#Iphone相机跟踪" class="headerlink" title="Iphone相机跟踪"></a>Iphone相机跟踪</h4><div align="center"><img src="https://s2.loli.net/2025/10/27/radVntHOELqgh2b.png" alt="image-20251013114229527" style="zoom: 20%;" /> <img src="https://s2.loli.net/2025/10/27/DR1TGPCjvgM3nqu.png" alt="image-20251013114601929" style="zoom: 20%;" /></div><p>在AppStore（IOS）下载Aximmetry Eye这个软件。然后通过网线<strong>有线连接</strong>（重点，无线我测试有问题），最好套上一个散热器（不然，一会儿手机就烫得不行然后断连了，然后数据飘逸了）。然后在连接的时候，选择发送Tracking Data（如图）即可（因为实际上我们只需要摄影机姿态数据）。连接完成之后，就可以在Flow页面Camera Tracking的节点细节面板里面看到手机这个选项了。</p><div align="center"><img src="https://s2.loli.net/2025/10/27/Vc49YvN7KrCqOuP.png" alt="image-20251013203732954" style="zoom: 20%;" /></div><p><u>每次初始化的时候Iphone所在的位置以及轴向</u>，就会被当作场景的中心点。</p><ul><li>请参看参考资料，部分有视频。</li></ul><h4 id="相机的FOV设定"><a href="#相机的FOV设定" class="headerlink" title="相机的FOV设定"></a>相机的FOV设定</h4><div align="center"><img src="https://s2.loli.net/2025/10/27/iSkpaB3lJKqGV2f.png" alt="image-20251013202543178" style="zoom: 20%;" /></div><p>FOV也可以进行手动标定，一般相机上的镜头标尺不是很准。<br>所以需要一些精确的标定。<br>可以在合成画面中，左右&#x2F;上下横移：如果虚拟旋转速度比真实的快，那么需要减小Zoom、反之亦然。</p><h4 id="Iphone外参手动标定"><a href="#Iphone外参手动标定" class="headerlink" title="Iphone外参手动标定"></a>Iphone外参手动标定</h4><div align="center"><img src="https://s2.loli.net/2025/10/27/X8FjOHlqyeSdKvx.png" alt="image-20251027113433462" style="zoom: 20%;" /></div><p>首先在相机的上方增加增加一个Actor物体，命名为CameraLocation。</p><p>Aximmetry的逻辑是 相机生成在原点 然后+-手机Aximmetry Eye上的偏移值，就是相机在运行时候的位置。</p><p>所以需要在CameraLocation，修改其位置，至实际上物理相机距离中心原点的位置。</p><h3 id="相机的标定"><a href="#相机的标定" class="headerlink" title="相机的标定"></a>相机的标定</h3><h4 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h4><p>相机标定的概念包括两部分：镜头标定和跟踪标定。</p><h6 id="镜头校准的概念"><a href="#镜头校准的概念" class="headerlink" title="镜头校准的概念"></a>镜头校准的概念</h6><p><strong>镜头校准</strong>的概念是，演播室摄像机镜头的固有特性（ <em>例如镜头畸变、中心偏移等</em> ）始终会导致图像及其色彩失真，而虚拟摄像机（ <em>演播室摄像机的虚拟对应物</em> ）默认会呈现完美图像（ <em>图像和&#x2F;或色彩均无畸变</em> ）。镜头校准的目标是将二者（演播室摄像机镜头与虚拟摄影机）统一在一起。（畸变校准）</p><h6 id="跟踪校准的概念"><a href="#跟踪校准的概念" class="headerlink" title="跟踪校准的概念"></a>跟踪校准的概念</h6><p>跟踪校准的概念是，跟踪系统只能测量其跟踪设备的位置和旋转，而虚拟制作需要演播室摄像机无视差点（ <em>靠近摄像机传感器</em> ）的位置和旋转。跟踪校准的目标是计算这两个位置和旋转之间的差异。</p><h4 id="工具介绍"><a href="#工具介绍" class="headerlink" title="工具介绍"></a>工具介绍</h4><p><a href="https://aximmetry.com/learn/virtual-production-workflow/tracking/calibration/about-the-concept-of-camera-calibration/">官网对于标定内容的总结</a>里面提及了Aximmetry有两个标定工具：<a href="https://www.youtube.com/watch?v=Lb2BuzxM4h0">Basic Calibrator</a>和Camera Calibrator，在软件路径下可以看到这两个工具。</p><ul><li><a href="https://aximmetry.com/learn/virtual-production-workflow/tracking/calibration/basic-calibrator/">Basic Calibrator</a> 手动校准相机或调整现有的校准配置文件。</li><li><a href="https://aximmetry.com/learn/virtual-production-workflow/tracking/calibration/camera-calibrator/">Camera Calibrator</a> 自动校准相机。</li></ul><div align="center"><img src="https://s2.loli.net/2025/10/10/kstDo52JFy1ATgE.png" alt="image-20251009165746851" style="zoom: 20%;" /> <img src="https://s2.loli.net/2025/10/10/gc4PLZmDqfJalM2.png" alt="image-20251009165932446" style="zoom: 20%;" /></div><h5 id="Basic-Calibrator"><a href="#Basic-Calibrator" class="headerlink" title="Basic Calibrator"></a>Basic Calibrator</h5><p>Basic Calibrator 是 Aximmetry 提供的手动相机校准工具，用于调整相机的内外参数，确保虚拟场景与真实摄像机的透视和运动保持一致。</p><p><strong>官方教程</strong>：<a href="https://www.youtube.com/watch?v=Lb2BuzxM4h0">Aximmetry Basic Calibrator Tutorial</a></p><h6 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h6><ul><li><strong>Z（Zoom）</strong>：表示最小放大值，即镜头的变焦参数</li><li><strong>F（Focus）</strong>：代表镜头的对焦距离</li></ul><h6 id="校准步骤"><a href="#校准步骤" class="headerlink" title="校准步骤"></a>校准步骤</h6><p><strong>1. 配置相机属性（Properties）</strong></p><p>首先需要在 Basic Calibrator 中设置相机的基本参数：</p><ul><li><strong>传感器尺寸（Sensor Size）</strong>：输入摄像机传感器的物理尺寸<ul><li>示例：索尼 FX3 的传感器尺寸为 35.6 x 23.8 mm</li></ul></li><li><strong>相机高度（Camera Height）</strong>：测量并输入相机距离地面的实际高度<ul><li>这个参数对于跟踪校准非常重要</li></ul></li></ul><p><strong>2. 设置虚拟地平面</strong></p><ul><li><strong>Pan Virtual</strong>：设置虚拟场景中地平面的高度</li><li>确保虚拟地平面与真实地面对齐，这是后续校准的基准</li></ul><p><strong>3. 添加校准点（Calibration Points）</strong></p><ul><li>点击 <strong>Add</strong> 按钮添加校准点</li><li><strong>建议使用 5 个以上的校准点</strong>，以获得更准确的校准结果</li><li><strong>注意事项</strong>：<ul><li>不要在画面边缘位置添加校准点，因为镜头边缘的畸变较大</li><li>校准点应均匀分布在画面的中心区域</li><li>选择画面中清晰可辨的参考点（如地面标记、墙角等）</li></ul></li></ul><p><strong>4. 调整焦距（Focal Length）</strong></p><p>这是校准的核心步骤，需要通过观察虚拟网格与真实场景的匹配程度来调整：</p><ul><li><strong>判断标准</strong>：横向或纵向平移相机，观察虚拟网格与地面标记的相对运动速度<ul><li>如果<strong>虚拟网格旋转速度比真实标记快</strong>：需要<strong>增加 Focal Length</strong> 值</li><li>如果<strong>虚拟网格旋转速度比真实标记慢</strong>：需要<strong>减小 Focal Length</strong> 值</li></ul></li><li><strong>调整方法</strong>：<ul><li>逐步微调 Focal Length 参数</li><li>重复测试相机移动，直到虚拟网格与真实场景完美同步</li></ul></li></ul><p><strong>5. 验证校准结果</strong></p><ul><li>在不同位置和角度测试相机运动</li><li>确保虚拟场景与真实场景在各个方向上都能保持一致</li><li>如果发现偏差，可以添加更多校准点或重新调整参数</li></ul><h6 id="校准技巧"><a href="#校准技巧" class="headerlink" title="校准技巧"></a>校准技巧</h6><ul><li>使用稳定的三脚架或云台，避免相机抖动影响校准精度</li><li>在光线充足的环境下进行校准，确保参考点清晰可见</li><li>定期重新校准，特别是在更换镜头或调整焦距后</li><li>保存校准配置文件，方便后续使用</li></ul><h6 id="支持的跟踪系统类型"><a href="#支持的跟踪系统类型" class="headerlink" title="支持的跟踪系统类型"></a>支持的跟踪系统类型</h6><p>Basic Calibrator 目前支持两种类型的跟踪系统校准：</p><div align="center"><img src="https://s2.loli.net/2025/10/10/7eXmrFl6TStBQ8V.png" alt="image-20251009170158715" style="zoom: 20%;" /></div><ul><li><p><strong>6DOF（6 自由度跟踪系统）</strong></p><ul><li><strong>定义</strong>：能够同时获取摄像机在三维空间中的位置（X、Y、Z）和旋转（Pitch俯仰、Yaw偏航、Roll翻滚）数据</li><li><strong>特点</strong>：实现摄像机的完整空间运动追踪</li><li><strong>应用场景</strong>：高精度虚拟制作和混合现实场景</li><li><strong>典型设备</strong>：来自外部的专业跟踪系统（如 OptiTrack、Vicon 等）</li></ul></li><li><p><strong>PTZ（Pan-Tilt-Zoom）</strong></p><ul><li><strong>定义</strong>：具备云台（水平旋转）、俯仰（垂直旋转）和变焦功能的摄像机</li><li><strong>特点</strong>：不具备完整的空间位置追踪能力，主要追踪旋转和变焦参数</li><li><strong>应用场景</strong>：场景监控或简单虚拟制作</li><li><strong>典型设备</strong>：PTZ 摄像机系统</li></ul></li></ul><h6 id="设备配置示例"><a href="#设备配置示例" class="headerlink" title="设备配置示例"></a>设备配置示例</h6><p><strong>在设备映射器中添加 Aximmetry Eye：</strong></p><div align="center"><img src="https://s2.loli.net/2025/10/10/xMOXDgvkuVticse.png" alt="image-20250930155931126" style="zoom: 20%;" /></div><div align="center"><img src="https://s2.loli.net/2025/10/10/LM2ldp7bxyBaIYR.png" alt="image-20250930164348165" style="zoom: 20%;" /></div><p><strong>重要提示</strong>：使用 Aximmetry Eye 时，一定要通过<strong>网线有线连接</strong>才能获得稳定的跟踪数据。无线连接可能导致数据延迟或连接不稳定。</p><h2 id="其他思考"><a href="#其他思考" class="headerlink" title="其他思考"></a>其他思考</h2><h5 id="关于Iphone同步问题"><a href="#关于Iphone同步问题" class="headerlink" title="关于Iphone同步问题"></a>关于Iphone同步问题</h5><p>因为Iphone在之前的版本中并不支持时间吗和Genlock，所以在同步上就会有很多问题。</p><p>论坛里提及了<a href="https://my.aximmetry.com/post/3885-aximmetry-eye-as-a-tracker-for-a-studio">这个问题</a>。是否可以使用iphone17支持了GenLock是否可以直接拿来使用作为外部跟踪器。</p><p><a href="https://www.youtube.com/watch?v=jjsrc01caGQ">Youtube里面提到的Blackmgiac为Iphone制作的外部同步设备</a></p><h2 id="使用时候的问题"><a href="#使用时候的问题" class="headerlink" title="使用时候的问题"></a>使用时候的问题</h2><h3 id="引擎版本不兼容问题"><a href="#引擎版本不兼容问题" class="headerlink" title="引擎版本不兼容问题"></a>引擎版本不兼容问题</h3><p>官网也提到了这个<a href="https://aximmetry.com/learn/virtual-production-workflow/obtaining-graphics-and-virtual-assets/creating-content-in-unreal-editor/advanced-information-and-features/how-to-install-third-party-code-plugins-for-unreal-editor-for-aximmetry/">问题</a>，这会涉及到一些别的插件的重新编译、兼容性的问题。</p><p>Aximmetry 的 UE 版本不是官方完整源码版，因此想要重新编译复杂 C++ 插件（特别是依赖私有模块或渲染管线扩展的）往往会失败。</p><p>可以：</p><ol><li>使用蓝图或纯资源插件；</li><li>寻找已为该版本预编译的二进制包；</li><li>如果必须用 C++ 插件，尝试在官方 UE5.5 建工程验证，确认可以跑通，然后再到Aximmetry的引擎中去跑。</li></ol><h3 id="采集卡格式不兼容问题"><a href="#采集卡格式不兼容问题" class="headerlink" title="采集卡格式不兼容问题"></a>采集卡格式不兼容问题</h3><p> 在项目设置上会出现采集卡识别不到型号&#x2F;分辨率等问题，或是采集卡断掉之后，画面呈现黑的。<br>这时候需要拔掉插件卡重新插入，然后重启软件。</p><h2 id="自己写一个XR软件"><a href="#自己写一个XR软件" class="headerlink" title="自己写一个XR软件"></a>自己写一个XR软件</h2><p>我们有自研的需求，考虑到Aximmetry的以“片的形式”放一个采集卡画面到场景中的实现逻辑较为简单，所以在这里手搓一个XR软件，用于给后面的大软件进行操作逻辑整理，我设想的是，这是一个编辑器下的工具，可以依托UE完成整个合成和渲染操作，而不是Aximmetry。</p><p>实现的功能比较简单：<br>主要实现：</p><ol><li>接入绿幕图像</li><li>绿幕一直朝向摄影机</li><li>相机的多机位切换及多机位运动</li><li>控制对应的屏幕全屏显示</li></ol><h3 id="接入绿幕图像"><a href="#接入绿幕图像" class="headerlink" title="接入绿幕图像"></a>接入绿幕图像</h3><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/y1OqgboQ6aPUC2Y.png" alt="image-20251104155838931" style="zoom: 25%;" / width="50%" /></div><p>新建一个场景，并新建MediaPlate到场景中。</p><p>导入绿幕视频（可以直接把UE支持的格式的视频拖拽到UE的编辑器面板里）并连接MediaPlate。</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/BHVDa1MwzeqQ48v.png" alt="image-20251104160039501" style="zoom:25%;" / width="50%" /></div><p>修改绿幕材质（直接把MediaPlate的材质复制出来一份到本地），并新增一个MF_ChromKeyer，并按照如图所示进行修改材质的节点，然后将复制出来的材质赋予MediaPlate。</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/PZQh3SBgt4rVCk8.png" alt="image-20251104160012519" style="zoom:25%;" / width="50%" /></div><p>修改子材质，对抠像的内容选择绿色的部分。保存，即可完成抠像，这里暂时使用一个临时的视频素材，正式使用的时候，这里可以使用一个采集卡接入的视频流。</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/J3sL9ITyld1aU7N.png" alt="image-20251104160147691" style="zoom:25%;" / width="50%" /></div><p>截止到这里，我们已经可以在场景中显示一个抠像的Plate了。</p><p>但是这样的Level无法保存下来。离开场景之后MediaPlate里面的素材会丢。</p><p>所以我们还要完善一下材质：</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/oQZX4KiqvwxtS6g.png" alt="image-20251104165145468" style="zoom:25%;" / width="50%" /></div><p>新建一个MediaPlayer，将里面播放的内容添加为刚刚导入的绿幕视频文件。</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/H3TibIsC7qyrcxB.png" alt="image-20251104165246306" style="zoom:25%;" / width="50%" /></div><p>新建一个MediaTexture，里面的媒体指定为刚刚新建的MediaPlayer。</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/OfosrTMUuvA3eDB.png" alt="image-20251104165327820" style="zoom:25%;" / width="50%" /></div><p>然后把MediaTexture拖动到MediaPlate的材质里面，并修改输入源。保存之后，MediaPlate就正常了。<br>至此，我们已经完成了绿幕接入这一项。</p><h3 id="绿幕一直朝向摄影机"><a href="#绿幕一直朝向摄影机" class="headerlink" title="绿幕一直朝向摄影机"></a>绿幕一直朝向摄影机</h3><p>但是我们会发现一个问题，当我们切换不同相机的视角的时候，所以需要设置相机的摄影机朝向。</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/TxhUdEkNbzIm5VG.png" alt="image-20251104171602887" style="zoom:15%;" / width="50%" /></div><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/sCjGTwNf2xbSK5H.png" alt="image-20251104172150884" style="zoom:25%;" / width="50%" /></div><p>否则就会出现这种明显的片的形式。</p><h3 id="相机的多机位切换及多机位运动"><a href="#相机的多机位切换及多机位运动" class="headerlink" title="相机的多机位切换及多机位运动"></a>相机的多机位切换及多机位运动</h3><p>因为我们是直接控制UE里的摄影机器，所以不管是在Play状态下还是在Editor状态下，都可以直接依靠UE的Sequence功能实现镜头的运动。但是切换并不能很好的实现。所以可以用我的软件实现快速的镜头切换。</p><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/z2WNlO39Sgft6np.png" alt="image-20251104174529386" style="zoom:33%;" / width="50%" /></div><p>在运行时，可以点击这个控制台，来操作相机进行切换。</p><h3 id="控制对应的屏幕全屏显示"><a href="#控制对应的屏幕全屏显示" class="headerlink" title="控制对应的屏幕全屏显示"></a>控制对应的屏幕全屏显示</h3><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/9NtOGMbeDqkXQcn.png" alt="image-20251104174853388" width="50%" /></div><p>选择需要把画面渲染到的屏幕，然后选择渲染分辨率，对画面进行全屏渲染。然后直播的时候，可以用OBS采集对应的窗口画面，进行直播。</p><p>于是我们就绕开了Aximmetry及其引擎，在UE中进行合成和渲染，并且也方便使用开源的UE及其周边子插件，而不是被Aximmetry的特殊版本引擎所限制。</p><p>当然这个插件目前还有很多问题。Just for Fun.如果要使用还要解决很多问题，比如标定等。</p><h2 id="所有源码"><a href="#所有源码" class="headerlink" title="所有源码"></a>所有源码</h2><h3 id="软件的整体结构"><a href="#软件的整体结构" class="headerlink" title="软件的整体结构"></a>软件的整体结构</h3><div style="text-align: center;"><img src="https://s2.loli.net/2025/11/04/Gt92glkBQOUXjNF.png" alt="image-20251104180744538" width="50%" /></div><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><h3 id="STcgXRViewport-cpp"><a href="#STcgXRViewport-cpp" class="headerlink" title="STcgXRViewport.cpp"></a>STcgXRViewport.cpp</h3><p><strong>文件路径</strong>: <code>Private\STcgXRViewport.cpp</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;STcgXRViewport.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRViewportClient.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;PreviewScene.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Editor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LevelEditor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Engine/World.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Engine/Level.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GameFramework/Actor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CineCameraActor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CineCameraComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LevelEditorViewport.h&quot;</span> <span class="comment">// FLevelEditorViewportClient</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXR.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造函数，初始化自定义Viewport</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::Construct</span><span class="params">(<span class="type">const</span> FArguments&amp; InArgs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SEditorViewport::<span class="built_in">Construct</span>(SEditorViewport::<span class="built_in">FArguments</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建自定义ViewportClient</span></span><br><span class="line"><span class="function">TSharedRef&lt;FEditorViewportClient&gt; <span class="title">STcgXRViewport::MakeEditorViewportClient</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!PreviewScene.<span class="built_in">IsValid</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        PreviewScene = <span class="built_in">MakeUnique</span>&lt;FPreviewScene&gt;(FPreviewScene::<span class="built_in">ConstructionValues</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ViewportClient = <span class="built_in">MakeShared</span>&lt;FTcgXRViewportClient&gt;(PreviewScene.<span class="built_in">Get</span>(), <span class="built_in">StaticCastSharedRef</span>&lt;SEditorViewport&gt;(<span class="built_in">SharedThis</span>(<span class="keyword">this</span>)));</span><br><span class="line">    ViewportClient-&gt;<span class="built_in">SetViewMode</span>(VMI_Lit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从第一个主编辑器视口复制相机参数</span></span><br><span class="line">    <span class="keyword">if</span> (GEditor)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (FEditorViewportClient* VC : GEditor-&gt;<span class="built_in">GetAllViewportClients</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (VC &amp;&amp; VC-&gt;<span class="built_in">IsPerspective</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">const</span> FVector Loc = VC-&gt;<span class="built_in">GetViewLocation</span>();</span><br><span class="line">                <span class="type">const</span> FRotator Rot = VC-&gt;<span class="built_in">GetViewRotation</span>();</span><br><span class="line">                <span class="type">const</span> <span class="type">bool</span> bIsOrtho = VC-&gt;<span class="built_in">IsOrtho</span>();</span><br><span class="line">                <span class="type">const</span> <span class="type">float</span> FOV = VC-&gt;ViewFOV; <span class="comment">// 使用源视口FOV</span></span><br><span class="line">                <span class="type">const</span> <span class="type">float</span> OrthoWidth = <span class="number">2048.f</span>; <span class="comment">// 默认正交宽度</span></span><br><span class="line">                ViewportClient-&gt;<span class="built_in">SetCameraFrom</span>(Loc, Rot, FOV, OrthoWidth, bIsOrtho);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 应用缓存参数（如果UI在Client创建前触发了设置，不会崩溃）</span></span><br><span class="line">    <span class="built_in">ApplyCachedParams</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ViewportClient.<span class="built_in">ToSharedRef</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::ApplyCachedParams</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ViewportClient.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (CachedFOV.<span class="built_in">IsSet</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFOV</span>(CachedFOV.<span class="built_in">GetValue</span>()); CachedFOV.<span class="built_in">Reset</span>(); &#125;</span><br><span class="line">    <span class="keyword">if</span> (CachedExposure.<span class="built_in">IsSet</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetExposure</span>(CachedExposure.<span class="built_in">GetValue</span>()); CachedExposure.<span class="built_in">Reset</span>(); &#125;</span><br><span class="line">    <span class="keyword">if</span> (CachedFocalLength.<span class="built_in">IsSet</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFocalLength</span>(CachedFocalLength.<span class="built_in">GetValue</span>()); CachedFocalLength.<span class="built_in">Reset</span>(); &#125;</span><br><span class="line">    <span class="keyword">if</span> (CachedAperture.<span class="built_in">IsSet</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetAperture</span>(CachedAperture.<span class="built_in">GetValue</span>()); CachedAperture.<span class="built_in">Reset</span>(); &#125;</span><br><span class="line">    <span class="keyword">if</span> (CachedFocusDistance.<span class="built_in">IsSet</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFocusDistance</span>(CachedFocusDistance.<span class="built_in">GetValue</span>()); CachedFocusDistance.<span class="built_in">Reset</span>(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XR状态控制接口</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetShowKeyed</span><span class="params">(<span class="type">bool</span> b)</span> </span>&#123; <span class="keyword">if</span> (ViewportClient) ViewportClient-&gt;<span class="built_in">SetShowKeyed</span>(b); &#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetVirtualCamMove</span><span class="params">(<span class="type">bool</span> b)</span> </span>&#123; <span class="keyword">if</span> (ViewportClient) ViewportClient-&gt;<span class="built_in">SetVirtualCamMove</span>(b); &#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetMixedRealityBlend</span><span class="params">(<span class="type">bool</span> b)</span> </span>&#123; <span class="keyword">if</span> (ViewportClient) ViewportClient-&gt;<span class="built_in">SetMixedRealityBlend</span>(b); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">STcgXRViewport::IsShowKeyed</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> ViewportClient ? ViewportClient-&gt;<span class="built_in">IsShowKeyed</span>() : <span class="literal">false</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">STcgXRViewport::IsVirtualCamMove</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> ViewportClient ? ViewportClient-&gt;<span class="built_in">IsVirtualCamMove</span>() : <span class="literal">false</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">STcgXRViewport::IsMixedRealityBlend</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> ViewportClient ? ViewportClient-&gt;<span class="built_in">IsMixedRealityBlend</span>() : <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工具：获取当前锁定的电影相机（如果任何一个关卡视口处于Pilot/锁定状态）</span></span><br><span class="line"><span class="function"><span class="type">static</span> UCineCameraComponent* <span class="title">GetLockedCineCamera</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!GEditor) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">const</span> TArray&lt;FLevelEditorViewportClient*&gt;&amp; Clients = GEditor-&gt;<span class="built_in">GetLevelViewportClients</span>();</span><br><span class="line">    <span class="keyword">for</span> (FLevelEditorViewportClient* LVC : Clients)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!LVC || !LVC-&gt;<span class="built_in">IsPerspective</span>()) <span class="keyword">continue</span>;</span><br><span class="line">        AActor* LockedActor = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">if</span> (AActor* CineLock = LVC-&gt;<span class="built_in">GetCinematicActorLock</span>().<span class="built_in">GetLockedActor</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            LockedActor = CineLock;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (LVC-&gt;<span class="built_in">GetActiveActorLock</span>().<span class="built_in">IsValid</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            LockedActor = LVC-&gt;<span class="built_in">GetActiveActorLock</span>().<span class="built_in">Get</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (LockedActor)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (ACineCameraActor* Cine = <span class="built_in">Cast</span>&lt;ACineCameraActor&gt;(LockedActor))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Cine-&gt;<span class="built_in">GetCineCameraComponent</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 捕获键盘输入并分发给模块做相机切换</span></span><br><span class="line"><span class="function">FReply <span class="title">STcgXRViewport::OnKeyDown</span><span class="params">(<span class="type">const</span> FGeometry&amp; MyGeometry, <span class="type">const</span> FKeyEvent&amp; InKeyEvent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (FTcgXRModule* Mod = FModuleManager::<span class="built_in">GetModulePtr</span>&lt;FTcgXRModule&gt;(<span class="string">&quot;TcgXR&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Mod-&gt;<span class="built_in">HandleKeyDown</span>(InKeyEvent.<span class="built_in">GetKey</span>()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> FReply::<span class="built_in">Handled</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SEditorViewport::<span class="built_in">OnKeyDown</span>(MyGeometry, InKeyEvent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全设置接口（优先修改锁定到关卡视口的相机，否则本地缓存/ViewportClient）</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetFOVParam</span><span class="params">(<span class="type">float</span> InFOV)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UCineCameraComponent* CineComp = <span class="built_in">GetLockedCineCamera</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        CineComp-&gt;<span class="built_in">SetFieldOfView</span>(InFOV);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ViewportClient.<span class="built_in">IsValid</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFOV</span>(InFOV); &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; CachedFOV = InFOV; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetExposureParam</span><span class="params">(<span class="type">float</span> InExposure)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UCineCameraComponent* CineComp = <span class="built_in">GetLockedCineCamera</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        FPostProcessSettings&amp; PPS = CineComp-&gt;PostProcessSettings;</span><br><span class="line">        PPS.bOverride_AutoExposureBias = <span class="literal">true</span>;</span><br><span class="line">        PPS.AutoExposureBias = InExposure;</span><br><span class="line">        CineComp-&gt;PostProcessBlendWeight = <span class="number">1.0f</span>;</span><br><span class="line">        CineComp-&gt;<span class="built_in">MarkRenderStateDirty</span>();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ViewportClient.<span class="built_in">IsValid</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetExposure</span>(InExposure); &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; CachedExposure = InExposure; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetFocalLengthParam</span><span class="params">(<span class="type">float</span> InFocal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UCineCameraComponent* CineComp = <span class="built_in">GetLockedCineCamera</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        CineComp-&gt;<span class="built_in">SetCurrentFocalLength</span>(InFocal);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ViewportClient.<span class="built_in">IsValid</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFocalLength</span>(InFocal); &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; CachedFocalLength = InFocal; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetApertureParam</span><span class="params">(<span class="type">float</span> InAperture)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UCineCameraComponent* CineComp = <span class="built_in">GetLockedCineCamera</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        CineComp-&gt;<span class="built_in">SetCurrentAperture</span>(InAperture);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ViewportClient.<span class="built_in">IsValid</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetAperture</span>(InAperture); &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; CachedAperture = InAperture; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">STcgXRViewport::SetFocusDistanceParam</span><span class="params">(<span class="type">float</span> InFocus)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UCineCameraComponent* CineComp = <span class="built_in">GetLockedCineCamera</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        CineComp-&gt;FocusSettings.ManualFocusDistance = InFocus;</span><br><span class="line">        CineComp-&gt;<span class="built_in">SetFocusSettings</span>(CineComp-&gt;FocusSettings);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ViewportClient.<span class="built_in">IsValid</span>()) &#123; ViewportClient-&gt;<span class="built_in">SetFocusDistance</span>(InFocus); &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; CachedFocusDistance = InFocus; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TcgXR-cpp"><a href="#TcgXR-cpp" class="headerlink" title="TcgXR.cpp"></a>TcgXR.cpp</h3><p><strong>文件路径</strong>: <code>Private\TcgXR.cpp</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// 本文件为TcgXR插件主模块，负责插件的初始化、UI布局和命令注册。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXR.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRStyle.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRCommands.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ToolMenus.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Framework/Docking/TabManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Docking/SDockTab.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Layout/SBorder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/SBoxPanel.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SCheckBox.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SButton.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SComboBox.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SSlider.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SSpinBox.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Input/SComboButton.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/Text/STextBlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Widgets/SWindow.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Framework/Application/SlateApplication.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;STcgXRViewport.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRViewportClient.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LevelEditor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LevelEditorViewport.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SLevelViewport.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EngineUtils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Camera/CameraActor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Editor.h&quot;</span> <span class="comment">// FEditorDelegates</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">const</span> FName <span class="title">TcgXRTabName</span><span class="params">(<span class="string">&quot;TcgXRWindow&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOCTEXT_NAMESPACE <span class="string">&quot;FTcgXRModule&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::StartupModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FTcgXRStyle::<span class="built_in">Initialize</span>();</span><br><span class="line">FTcgXRStyle::<span class="built_in">ReloadTextures</span>();</span><br><span class="line"></span><br><span class="line">FTcgXRCommands::<span class="built_in">Register</span>();</span><br><span class="line"></span><br><span class="line">PluginCommands = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> FUICommandList);</span><br><span class="line">PluginCommands-&gt;<span class="built_in">MapAction</span>(</span><br><span class="line">FTcgXRCommands::<span class="built_in">Get</span>().PluginAction,</span><br><span class="line">FExecuteAction::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FTcgXRModule::PluginButtonClicked),</span><br><span class="line"><span class="built_in">FCanExecuteAction</span>());</span><br><span class="line"></span><br><span class="line">FGlobalTabmanager::<span class="built_in">Get</span>()-&gt;<span class="built_in">RegisterNomadTabSpawner</span>(TcgXRTabName,</span><br><span class="line">FOnSpawnTab::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FTcgXRModule::OnSpawnPluginTab))</span><br><span class="line">.<span class="built_in">SetDisplayName</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;TcgXRTabTitle&quot;</span>, <span class="string">&quot;TcgXR&quot;</span>))</span><br><span class="line">.<span class="built_in">SetMenuType</span>(ETabSpawnerMenuType::Hidden);</span><br><span class="line"></span><br><span class="line">UToolMenus::<span class="built_in">RegisterStartupCallback</span>(FSimpleMulticastDelegate::FDelegate::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FTcgXRModule::RegisterMenus));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (GEngine)</span><br><span class="line">&#123;</span><br><span class="line">ActorAddedHandle = GEngine-&gt;<span class="built_in">OnLevelActorAdded</span>().<span class="built_in">AddLambda</span>([<span class="keyword">this</span>](AActor* <span class="comment">/*Actor*/</span>)&#123; <span class="built_in">RefreshCameraList</span>(); &#125;);</span><br><span class="line">ActorDeletedHandle = GEngine-&gt;<span class="built_in">OnLevelActorDeleted</span>().<span class="built_in">AddLambda</span>([<span class="keyword">this</span>](AActor* <span class="comment">/*Actor*/</span>)&#123; <span class="built_in">RefreshCameraList</span>(); &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 当编辑器相机移动或切换锁定时，刷新“当前控制”文本</span></span><br><span class="line">FEditorDelegates::OnEditorCameraMoved.<span class="built_in">AddLambda</span>([<span class="keyword">this</span>](<span class="type">const</span> FVector&amp;, <span class="type">const</span> FRotator&amp;, ELevelViewportType, int32)&#123; <span class="built_in">RebuildCameraHotkeyUI</span>(); &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::ShutdownModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">UToolMenus::<span class="built_in">UnRegisterStartupCallback</span>(<span class="keyword">this</span>);</span><br><span class="line">UToolMenus::<span class="built_in">UnregisterOwner</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">FGlobalTabmanager::<span class="built_in">Get</span>()-&gt;<span class="built_in">UnregisterNomadTabSpawner</span>(TcgXRTabName);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (GEngine)</span><br><span class="line">&#123;</span><br><span class="line">GEngine-&gt;<span class="built_in">OnLevelActorAdded</span>().<span class="built_in">Remove</span>(ActorAddedHandle);</span><br><span class="line">GEngine-&gt;<span class="built_in">OnLevelActorDeleted</span>().<span class="built_in">Remove</span>(ActorDeletedHandle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FTcgXRStyle::<span class="built_in">Shutdown</span>();</span><br><span class="line">FTcgXRCommands::<span class="built_in">Unregister</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::PluginButtonClicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FGlobalTabmanager::<span class="built_in">Get</span>()-&gt;<span class="built_in">TryInvokeTab</span>(TcgXRTabName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::RegisterMenus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="function">FToolMenuOwnerScoped <span class="title">OwnerScoped</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (UToolMenu* Menu = UToolMenus::<span class="built_in">Get</span>()-&gt;<span class="built_in">ExtendMenu</span>(<span class="string">&quot;LevelEditor.MainMenu.Window&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">FToolMenuSection&amp; Section = Menu-&gt;<span class="built_in">FindOrAddSection</span>(<span class="string">&quot;WindowLayout&quot;</span>);</span><br><span class="line">Section.<span class="built_in">AddMenuEntryWithCommandList</span>(FTcgXRCommands::<span class="built_in">Get</span>().PluginAction, PluginCommands);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (UToolMenu* ToolbarMenu = UToolMenus::<span class="built_in">Get</span>()-&gt;<span class="built_in">ExtendMenu</span>(<span class="string">&quot;LevelEditor.LevelEditorToolBar.PlayToolBar&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">FToolMenuSection&amp; Section = ToolbarMenu-&gt;<span class="built_in">FindOrAddSection</span>(<span class="string">&quot;PluginTools&quot;</span>);</span><br><span class="line">FToolMenuEntry&amp; Entry = Section.<span class="built_in">AddEntry</span>(FToolMenuEntry::<span class="built_in">InitToolBarButton</span>(FTcgXRCommands::<span class="built_in">Get</span>().PluginAction));</span><br><span class="line">Entry.<span class="built_in">SetCommandList</span>(PluginCommands);</span><br><span class="line">Entry.Icon = <span class="built_in">FSlateIcon</span>(FTcgXRStyle::<span class="built_in">GetStyleSetName</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;TcgXR.PluginAction.Small&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;TcgXR.PluginAction&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FTcgXRModule::HandleKeyDown</span><span class="params">(<span class="type">const</span> FKey&amp; Key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (TWeakObjectPtr&lt;ACameraActor&gt;* Found = CameraHotkeyMap.<span class="built_in">Find</span>(Key))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">SwitchToCamera</span>(*Found);</span><br><span class="line"><span class="built_in">RebuildCameraHotkeyUI</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::BindCameraHotkey</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera, <span class="type">const</span> FKey&amp; Key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 确保一个相机只绑定一个键：先移除旧绑定</span></span><br><span class="line">TArray&lt;FKey&gt; KeysToRemove;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; Pair : CameraHotkeyMap)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (Pair.Value == Camera)</span><br><span class="line">&#123;</span><br><span class="line">KeysToRemove.<span class="built_in">Add</span>(Pair.Key);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> FKey&amp; OldKey : KeysToRemove)</span><br><span class="line">&#123;</span><br><span class="line">CameraHotkeyMap.<span class="built_in">Remove</span>(OldKey);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 同一按键重新绑定到新相机</span></span><br><span class="line">CameraHotkeyMap.<span class="built_in">Add</span>(Key, Camera);</span><br><span class="line"><span class="built_in">RebuildCameraHotkeyUI</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::SwitchToCamera</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!Camera.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line">FLevelEditorModule&amp; LevelEditorModule = FModuleManager::<span class="built_in">LoadModuleChecked</span>&lt;FLevelEditorModule&gt;(<span class="string">&quot;LevelEditor&quot;</span>);</span><br><span class="line">TSharedPtr&lt;SLevelViewport&gt; ActiveViewport = LevelEditorModule.<span class="built_in">GetFirstActiveLevelViewport</span>();</span><br><span class="line"><span class="keyword">if</span> (!ActiveViewport.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">FLevelEditorViewportClient&amp; LVC = ActiveViewport-&gt;<span class="built_in">GetLevelViewportClient</span>();</span><br><span class="line">LVC.<span class="built_in">SetActorLock</span>(Camera.<span class="built_in">Get</span>());</span><br><span class="line">LVC.<span class="built_in">UpdateViewForLockedActor</span>();</span><br><span class="line"><span class="keyword">if</span> (!ActiveViewport-&gt;<span class="built_in">IsLockedCameraViewEnabled</span>())</span><br><span class="line">&#123;</span><br><span class="line">ActiveViewport-&gt;<span class="built_in">ToggleActorPilotCameraView</span>();</span><br><span class="line">&#125;</span><br><span class="line">LVC.<span class="built_in">Invalidate</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FText <span class="title">FTcgXRModule::GetCurrentControlledCameraText</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!GEditor) <span class="keyword">return</span> <span class="built_in">LOCTEXT</span>(<span class="string">&quot;NoEditor&quot;</span>, <span class="string">&quot;当前控制: 无（未找到编辑器）&quot;</span>);</span><br><span class="line"><span class="type">const</span> TArray&lt;FLevelEditorViewportClient*&gt;&amp; Clients = GEditor-&gt;<span class="built_in">GetLevelViewportClients</span>();</span><br><span class="line"><span class="keyword">for</span> (FLevelEditorViewportClient* LVC : Clients)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!LVC || !LVC-&gt;<span class="built_in">IsPerspective</span>()) <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">if</span> (AActor* CineLock = LVC-&gt;<span class="built_in">GetCinematicActorLock</span>().<span class="built_in">GetLockedActor</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ControllingCam&quot;</span>,<span class="string">&quot;当前控制: &#123;0&#125;&quot;</span>), FText::<span class="built_in">FromString</span>(CineLock-&gt;<span class="built_in">GetActorLabel</span>()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (LVC-&gt;<span class="built_in">GetActiveActorLock</span>().<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line">AActor* Locked = LVC-&gt;<span class="built_in">GetActiveActorLock</span>().<span class="built_in">Get</span>();</span><br><span class="line"><span class="keyword">return</span> FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ControllingActor&quot;</span>,<span class="string">&quot;当前控制: &#123;0&#125;&quot;</span>), FText::<span class="built_in">FromString</span>(Locked-&gt;<span class="built_in">GetActorLabel</span>()));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">LOCTEXT</span>(<span class="string">&quot;NoCam&quot;</span>,<span class="string">&quot;当前控制: 无（未锁定相机）&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FText <span class="title">FTcgXRModule::GetBoundKeyTextForCamera</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; Pair : CameraHotkeyMap)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (Pair.Value == Camera)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;BoundKeyFmt&quot;</span>,<span class="string">&quot;已绑定: &#123;0&#125;&quot;</span>), Pair.Key.<span class="built_in">GetDisplayName</span>());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">LOCTEXT</span>(<span class="string">&quot;NoKeyBound&quot;</span>,<span class="string">&quot;未绑定&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::RefreshCameraList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">CachedCameras.<span class="built_in">Reset</span>();</span><br><span class="line"><span class="keyword">if</span> (GEditor)</span><br><span class="line">&#123;</span><br><span class="line">UWorld* World = GEditor-&gt;<span class="built_in">GetEditorWorldContext</span>().<span class="built_in">World</span>();</span><br><span class="line"><span class="keyword">if</span> (World)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (TActorIterator&lt;ACameraActor&gt; <span class="built_in">It</span>(World); It; ++It)</span><br><span class="line">&#123;</span><br><span class="line">CachedCameras.<span class="built_in">Add</span>(*It);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">RebuildCameraHotkeyUI</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::RebuildCameraHotkeyUI</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">TSharedPtr&lt;SVerticalBox&gt; Panel = CameraListPanel.<span class="built_in">Pin</span>();</span><br><span class="line"><span class="keyword">if</span> (!Panel.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line">Panel-&gt;<span class="built_in">ClearChildren</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 顶部显示当前控制的相机</span></span><br><span class="line">Panel-&gt;<span class="built_in">AddSlot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock)</span><br><span class="line">.<span class="built_in">Text_Lambda</span>([<span class="keyword">this</span>]()&#123; <span class="keyword">return</span> <span class="built_in">GetCurrentControlledCameraText</span>(); &#125;)</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">int32 Index = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (TWeakObjectPtr&lt;ACameraActor&gt; Cam : CachedCameras)</span><br><span class="line">&#123;</span><br><span class="line">TWeakObjectPtr&lt;ACameraActor&gt; LocalCam = Cam;</span><br><span class="line">FText Label = FText::<span class="built_in">FromString</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;相机%d: %s&quot;</span>), Index, LocalCam.<span class="built_in">IsValid</span>() ? *LocalCam-&gt;<span class="built_in">GetActorLabel</span>() : <span class="built_in">TEXT</span>(<span class="string">&quot;(无)&quot;</span>)));</span><br><span class="line">Panel-&gt;<span class="built_in">AddSlot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(Label)</span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock)</span><br><span class="line">.<span class="built_in">Text_Lambda</span>([<span class="keyword">this</span>, LocalCam]()&#123; <span class="keyword">return</span> <span class="built_in">GetBoundKeyTextForCamera</span>(LocalCam); &#125;)</span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SComboButton)</span><br><span class="line">.<span class="built_in">ButtonContent</span>()[ <span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;BindKey&quot;</span>, <span class="string">&quot;绑定按键&quot;</span>)) ]</span><br><span class="line">.<span class="built_in">OnGetMenuContent_Lambda</span>([<span class="keyword">this</span>, LocalCam]()</span><br><span class="line">&#123;</span><br><span class="line">FMenuBuilder <span class="built_in">MenuBuilder</span>(<span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">TArray&lt;FKey&gt; Keys; Keys.<span class="built_in">Reserve</span>(<span class="number">9</span>);</span><br><span class="line">Keys.<span class="built_in">Add</span>(EKeys::One); Keys.<span class="built_in">Add</span>(EKeys::Two); Keys.<span class="built_in">Add</span>(EKeys::Three); Keys.<span class="built_in">Add</span>(EKeys::Four);</span><br><span class="line">Keys.<span class="built_in">Add</span>(EKeys::Five); Keys.<span class="built_in">Add</span>(EKeys::Six); Keys.<span class="built_in">Add</span>(EKeys::Seven); Keys.<span class="built_in">Add</span>(EKeys::Eight); Keys.<span class="built_in">Add</span>(EKeys::Nine);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> FKey&amp; K : Keys)</span><br><span class="line">&#123;</span><br><span class="line">FText KeyName = K.<span class="built_in">GetDisplayName</span>();</span><br><span class="line">MenuBuilder.<span class="built_in">AddMenuEntry</span>(KeyName, <span class="built_in">LOCTEXT</span>(<span class="string">&quot;BindKeyTip&quot;</span>,<span class="string">&quot;绑定到该键&quot;</span>), <span class="built_in">FSlateIcon</span>(), <span class="built_in">FUIAction</span>(FExecuteAction::<span class="built_in">CreateLambda</span>([<span class="keyword">this</span>, LocalCam, K]()&#123; <span class="built_in">BindCameraHotkey</span>(LocalCam, K); &#125;)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> MenuBuilder.<span class="built_in">MakeWidget</span>();</span><br><span class="line">&#125;)</span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SButton)</span><br><span class="line">.<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;SwitchNow&quot;</span>,<span class="string">&quot;切换到该相机&quot;</span>))</span><br><span class="line">.<span class="built_in">OnClicked_Lambda</span>([<span class="keyword">this</span>, LocalCam]()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">SwitchToCamera</span>(LocalCam);</span><br><span class="line"><span class="built_in">RebuildCameraHotkeyUI</span>();</span><br><span class="line"><span class="keyword">return</span> FReply::<span class="built_in">Handled</span>();</span><br><span class="line">&#125;)</span><br><span class="line">]</span><br><span class="line">];</span><br><span class="line">++Index;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRModule::CloseAllFullscreenWindows</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (TWeakPtr&lt;SWindow&gt;&amp; W : FullscreenWindows)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (TSharedPtr&lt;SWindow&gt; SW = W.<span class="built_in">Pin</span>())</span><br><span class="line">&#123;</span><br><span class="line">SW-&gt;<span class="built_in">RequestDestroyWindow</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">FullscreenWindows.<span class="built_in">Reset</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成主窗口Tab，包括Viewport、右侧摄影机控制面板、底部全屏按钮</span></span><br><span class="line"><span class="function">TSharedRef&lt;SDockTab&gt; <span class="title">FTcgXRModule::OnSpawnPluginTab</span><span class="params">(<span class="type">const</span> FSpawnTabArgs&amp; Args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">TSharedPtr&lt;STcgXRViewport&gt; ViewportWidget;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">float</span> ManualExposure = <span class="number">0.0f</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> ManualFOV = <span class="number">90.0f</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> ManualFocal = <span class="number">35.0f</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> ManualAperture = <span class="number">2.8f</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> ManualFocus = <span class="number">1000.0f</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> bUseLiveLink = <span class="literal">false</span>;</span><br><span class="line"><span class="type">static</span> TArray&lt;TSharedPtr&lt;FString&gt;&gt; ResolutionOptions;</span><br><span class="line">ResolutionOptions.<span class="built_in">Reset</span>();</span><br><span class="line">ResolutionOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;1920x1080&quot;</span>)));</span><br><span class="line">ResolutionOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;2560x1440&quot;</span>)));</span><br><span class="line">ResolutionOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;3840x2160&quot;</span>)));</span><br><span class="line"><span class="type">static</span> TArray&lt;TSharedPtr&lt;FString&gt;&gt; MonitorOptions;</span><br><span class="line"><span class="type">static</span> int32 SelectedMonitorIndex = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> TSharedPtr&lt;FString&gt; SelectedResolution = ResolutionOptions.<span class="built_in">Num</span>() &gt; <span class="number">0</span> ? ResolutionOptions[<span class="number">0</span>] : <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">MonitorOptions.<span class="built_in">Reset</span>();</span><br><span class="line">&#123;</span><br><span class="line">FDisplayMetrics Metrics;</span><br><span class="line">FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">GetDisplayMetrics</span>(Metrics);</span><br><span class="line">MonitorOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;主显示器 %dx%d&quot;</span>), Metrics.PrimaryDisplayWidth, Metrics.PrimaryDisplayHeight)));</span><br><span class="line"><span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; Metrics.MonitorInfo.<span class="built_in">Num</span>(); ++i)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="keyword">auto</span>&amp; M = Metrics.MonitorInfo[i];</span><br><span class="line">FPlatformRect Rect = M.WorkArea;</span><br><span class="line">MonitorOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;显示器%d %dx%d @(%d,%d)&quot;</span>), i, Rect.Right-Rect.Left, Rect.Bottom-Rect.Top, Rect.Left, Rect.Top)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (MonitorOptions.<span class="built_in">Num</span>() == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">MonitorOptions.<span class="built_in">Add</span>(<span class="built_in">MakeShared</span>&lt;FString&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;显示器0&quot;</span>)));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TSharedRef&lt;SDockTab&gt; Tab = <span class="built_in">SNew</span>(SDockTab)</span><br><span class="line">.<span class="built_in">TabRole</span>(ETabRole::NomadTab)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">FillWidth</span>(<span class="number">1.f</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SAssignNew</span>(ViewportWidget, STcgXRViewport)</span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">8.f</span>,<span class="number">0.f</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SVerticalBox)</span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SAssignNew</span>(CameraListPanel, SVerticalBox)</span><br><span class="line">]</span><br><span class="line"><span class="comment">// 顶部快速参数行：移除FOV和曝光</span></span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line"><span class="comment">// 焦距</span></span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;Focal&quot;</span>, <span class="string">&quot;焦距&quot;</span>))</span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SSpinBox&lt;<span class="type">float</span>&gt;).<span class="built_in">MinValue</span>(<span class="number">1.f</span>).<span class="built_in">MaxValue</span>(<span class="number">300.f</span>)</span><br><span class="line">.<span class="built_in">Value_Lambda</span>([&amp;]&#123; <span class="keyword">return</span> ManualFocal; &#125;)</span><br><span class="line">.<span class="built_in">OnValueChanged_Lambda</span>([&amp;](<span class="type">float</span> V)&#123; ManualFocal = V; <span class="keyword">if</span>(ViewportWidget.<span class="built_in">IsValid</span>()) ViewportWidget-&gt;<span class="built_in">SetFocalLengthParam</span>(V); &#125;)</span><br><span class="line">]</span><br><span class="line"><span class="comment">// 光圈</span></span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;Aperture&quot;</span>, <span class="string">&quot;光圈&quot;</span>))</span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SSpinBox&lt;<span class="type">float</span>&gt;).<span class="built_in">MinValue</span>(<span class="number">0.7f</span>).<span class="built_in">MaxValue</span>(<span class="number">32.f</span>)</span><br><span class="line">.<span class="built_in">Value_Lambda</span>([&amp;]&#123; <span class="keyword">return</span> ManualAperture; &#125;)</span><br><span class="line">.<span class="built_in">OnValueChanged_Lambda</span>([&amp;](<span class="type">float</span> V)&#123; ManualAperture = V; <span class="keyword">if</span>(ViewportWidget.<span class="built_in">IsValid</span>()) ViewportWidget-&gt;<span class="built_in">SetApertureParam</span>(V); &#125;)</span><br><span class="line">]</span><br><span class="line"><span class="comment">// 对焦</span></span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;Focus&quot;</span>, <span class="string">&quot;对焦&quot;</span>))</span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SSpinBox&lt;<span class="type">float</span>&gt;).<span class="built_in">MinValue</span>(<span class="number">1.f</span>).<span class="built_in">MaxValue</span>(<span class="number">100000.f</span>)</span><br><span class="line">.<span class="built_in">Value_Lambda</span>([&amp;]&#123; <span class="keyword">return</span> ManualFocus; &#125;)</span><br><span class="line">.<span class="built_in">OnValueChanged_Lambda</span>([&amp;](<span class="type">float</span> V)&#123; ManualFocus = V; <span class="keyword">if</span>(ViewportWidget.<span class="built_in">IsValid</span>()) ViewportWidget-&gt;<span class="built_in">SetFocusDistanceParam</span>(V); &#125;)</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SCheckBox)</span><br><span class="line">.<span class="built_in">IsChecked_Lambda</span>([] &#123; <span class="keyword">return</span> bUseLiveLink ? ECheckBoxState::Checked : ECheckBoxState::Unchecked; &#125;)</span><br><span class="line">.<span class="built_in">OnCheckStateChanged_Lambda</span>([](ECheckBoxState State) &#123; bUseLiveLink = (State == ECheckBoxState::Checked); &#125;)</span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;LiveLinkSwitch&quot;</span>, <span class="string">&quot;使用LiveLink外部相机&quot;</span>))</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SVerticalBox)</span><br><span class="line">.<span class="built_in">Visibility_Lambda</span>([] &#123; <span class="keyword">return</span> bUseLiveLink ? EVisibility::Visible : EVisibility::Collapsed; &#125;)</span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>()</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;LiveLinkTitle&quot;</span>, <span class="string">&quot;LiveLink外部相机参数&quot;</span>))</span><br><span class="line">]</span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;LiveLinkStatus&quot;</span>, <span class="string">&quot;状态: 未连接/已连接&quot;</span>))</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">VAlign</span>(VAlign_Bottom).<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SVerticalBox)</span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;MonitorLabel&quot;</span>, <span class="string">&quot;屏幕&quot;</span>))</span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SComboBox&lt;TSharedPtr&lt;FString&gt;&gt;)</span><br><span class="line">.<span class="built_in">OptionsSource</span>(&amp;MonitorOptions)</span><br><span class="line">.<span class="built_in">OnSelectionChanged_Lambda</span>([&amp;](TSharedPtr&lt;FString&gt; NewItem, ESelectInfo::Type)&#123; SelectedMonitorIndex = FMath::<span class="built_in">Clamp</span>(MonitorOptions.<span class="built_in">IndexOfByKey</span>(NewItem), <span class="number">0</span>, MonitorOptions.<span class="built_in">Num</span>()<span class="number">-1</span>); &#125;)</span><br><span class="line">.<span class="built_in">OnGenerateWidget_Lambda</span>([](TSharedPtr&lt;FString&gt; InItem)&#123; <span class="keyword">return</span> <span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(FText::<span class="built_in">FromString</span>(*InItem)); &#125;)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text_Lambda</span>([&amp;]&#123; <span class="keyword">return</span> MonitorOptions.<span class="built_in">IsValidIndex</span>(SelectedMonitorIndex) ? FText::<span class="built_in">FromString</span>(*MonitorOptions[SelectedMonitorIndex]) : <span class="built_in">LOCTEXT</span>(<span class="string">&quot;MonitorUnknown&quot;</span>,<span class="string">&quot;未知屏幕&quot;</span>); &#125;)</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ResolutionLabel&quot;</span>, <span class="string">&quot;输出分辨率&quot;</span>))</span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2.f</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SComboBox&lt;TSharedPtr&lt;FString&gt;&gt;)</span><br><span class="line">.<span class="built_in">OptionsSource</span>(&amp;ResolutionOptions)</span><br><span class="line">.<span class="built_in">OnSelectionChanged_Lambda</span>([&amp;](TSharedPtr&lt;FString&gt; NewItem, ESelectInfo::Type) &#123; SelectedResolution = NewItem; &#125;)</span><br><span class="line">.<span class="built_in">OnGenerateWidget_Lambda</span>([](TSharedPtr&lt;FString&gt; InItem) &#123; <span class="keyword">return</span> <span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text</span>(FText::<span class="built_in">FromString</span>(*InItem)); &#125;)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock).<span class="built_in">Text_Lambda</span>([&amp;] &#123; <span class="keyword">return</span> SelectedResolution.<span class="built_in">IsValid</span>() ? FText::<span class="built_in">FromString</span>(*SelectedResolution) : <span class="built_in">LOCTEXT</span>(<span class="string">&quot;ResUnknown&quot;</span>,<span class="string">&quot;未知&quot;</span>); &#125;)</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>().<span class="built_in">Padding</span>(<span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SButton)</span><br><span class="line">.<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;FullscreenBtn&quot;</span>, <span class="string">&quot;全屏显示&quot;</span>))</span><br><span class="line">.<span class="built_in">OnClicked_Lambda</span>([<span class="keyword">this</span>, ViewportWidget]() &#123;</span><br><span class="line"><span class="keyword">if</span>(!ViewportWidget.<span class="built_in">IsValid</span>()) <span class="keyword">return</span> FReply::<span class="built_in">Handled</span>();</span><br><span class="line">TSharedPtr&lt;FString&gt; LocalSelectedResolution = SelectedResolution;</span><br><span class="line">int32 LocalSelectedMonitorIndex = SelectedMonitorIndex;</span><br><span class="line">int32 W=<span class="number">1920</span>, H=<span class="number">1080</span>;</span><br><span class="line">&#123;</span><br><span class="line">FString Res= LocalSelectedResolution.<span class="built_in">IsValid</span>() ? *LocalSelectedResolution : <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;1920x1080&quot;</span>));</span><br><span class="line">FString LW, LH;</span><br><span class="line"><span class="keyword">if</span>(Res.<span class="built_in">Split</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;x&quot;</span>), &amp;LW, &amp;LH)) &#123; W = FCString::<span class="built_in">Atoi</span>(*LW); H = FCString::<span class="built_in">Atoi</span>(*LH); &#125;</span><br><span class="line">&#125;</span><br><span class="line">TSharedPtr&lt;SWindow&gt; FullscreenWindow = <span class="built_in">SNew</span>(SWindow)</span><br><span class="line">.<span class="built_in">Title</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;XRFullscreen&quot;</span>, <span class="string">&quot;XR全屏输出&quot;</span>))</span><br><span class="line">.<span class="built_in">ClientSize</span>(<span class="built_in">FVector2D</span>(W, H))</span><br><span class="line">.<span class="built_in">SizingRule</span>(ESizingRule::FixedSize)</span><br><span class="line">.<span class="built_in">SupportsMaximize</span>(<span class="literal">false</span>)</span><br><span class="line">.<span class="built_in">SupportsMinimize</span>(<span class="literal">false</span>)</span><br><span class="line">.<span class="built_in">HasCloseButton</span>(<span class="literal">true</span>)</span><br><span class="line">.<span class="built_in">UseOSWindowBorder</span>(<span class="literal">false</span>)</span><br><span class="line">.<span class="built_in">CreateTitleBar</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">TSharedPtr&lt;STcgXRViewport&gt; FSViewport;</span><br><span class="line">FullscreenWindow-&gt;<span class="built_in">SetContent</span>(<span class="built_in">SAssignNew</span>(FSViewport, STcgXRViewport));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (FSlateApplication::<span class="built_in">IsInitialized</span>())</span><br><span class="line">&#123;</span><br><span class="line">FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">AddWindow</span>(FullscreenWindow.<span class="built_in">ToSharedRef</span>());</span><br><span class="line">FDisplayMetrics Metrics; FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">GetDisplayMetrics</span>(Metrics);</span><br><span class="line">FVector2D <span class="built_in">TargetPos</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (Metrics.MonitorInfo.<span class="built_in">IsValidIndex</span>(LocalSelectedMonitorIndex))</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="keyword">auto</span>&amp; M = Metrics.MonitorInfo[LocalSelectedMonitorIndex];</span><br><span class="line">TargetPos = <span class="built_in">FVector2D</span>(M.WorkArea.Left, M.WorkArea.Top);</span><br><span class="line">&#125;</span><br><span class="line">FullscreenWindow-&gt;<span class="built_in">MoveWindowTo</span>(TargetPos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FullscreenWindows.<span class="built_in">Add</span>(FullscreenWindow);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ViewportWidget-&gt;<span class="built_in">GetClient</span>().<span class="built_in">IsValid</span>() &amp;&amp; FSViewport.<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">auto</span> Src = ViewportWidget-&gt;<span class="built_in">GetClient</span>();</span><br><span class="line"><span class="keyword">auto</span> Dst = FSViewport-&gt;<span class="built_in">GetClient</span>();</span><br><span class="line">Dst-&gt;<span class="built_in">SetCameraFrom</span>(Src-&gt;<span class="built_in">GetViewLocation</span>(), Src-&gt;<span class="built_in">GetViewRotation</span>(), Src-&gt;<span class="built_in">GetFOV</span>(), <span class="number">2048.f</span>, <span class="literal">false</span>);</span><br><span class="line">Dst-&gt;<span class="built_in">SetFOV</span>(Src-&gt;<span class="built_in">GetFOV</span>());</span><br><span class="line">Dst-&gt;<span class="built_in">SetExposure</span>(Src-&gt;<span class="built_in">GetExposure</span>());</span><br><span class="line">Dst-&gt;<span class="built_in">SetFocalLength</span>(Src-&gt;<span class="built_in">GetFocalLength</span>());</span><br><span class="line">Dst-&gt;<span class="built_in">SetAperture</span>(Src-&gt;<span class="built_in">GetAperture</span>());</span><br><span class="line">Dst-&gt;<span class="built_in">SetFocusDistance</span>(Src-&gt;<span class="built_in">GetFocusDistance</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> FReply::<span class="built_in">Handled</span>();</span><br><span class="line">&#125;)</span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>().<span class="built_in">Padding</span>(<span class="number">2</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SButton)</span><br><span class="line">.<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;CloseFullscreenBtn&quot;</span>, <span class="string">&quot;关闭所有全屏&quot;</span>))</span><br><span class="line">.<span class="built_in">OnClicked_Lambda</span>([<span class="keyword">this</span>]()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">CloseAllFullscreenWindows</span>();</span><br><span class="line"><span class="keyword">return</span> FReply::<span class="built_in">Handled</span>();</span><br><span class="line">&#125;)</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="built_in">RefreshCameraList</span>();</span><br><span class="line"><span class="keyword">return</span> Tab;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> LOCTEXT_NAMESPACE</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">IMPLEMENT_MODULE</span>(FTcgXRModule, TcgXR)</span><br></pre></td></tr></table></figure><h3 id="TcgXRCommands-cpp"><a href="#TcgXRCommands-cpp" class="headerlink" title="TcgXRCommands.cpp"></a>TcgXRCommands.cpp</h3><p><strong>文件路径</strong>: <code>Private\TcgXRCommands.cpp</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRCommands.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOCTEXT_NAMESPACE <span class="string">&quot;FTcgXRModule&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRCommands::RegisterCommands</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">UI_COMMAND</span>(PluginAction, <span class="string">&quot;TcgXR&quot;</span>, <span class="string">&quot;Execute TcgXR action&quot;</span>, EUserInterfaceActionType::Button, <span class="built_in">FInputChord</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> LOCTEXT_NAMESPACE</span></span><br></pre></td></tr></table></figure><h3 id="TcgXRStyle-cpp"><a href="#TcgXRStyle-cpp" class="headerlink" title="TcgXRStyle.cpp"></a>TcgXRStyle.cpp</h3><p><strong>文件路径</strong>: <code>Private\TcgXRStyle.cpp</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRStyle.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXR.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Framework/Application/SlateApplication.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Styling/SlateStyleRegistry.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Slate/SlateGameResources.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Interfaces/IPluginManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Styling/SlateStyleMacros.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RootToContentDir Style-&gt;RootToContentDir</span></span><br><span class="line"></span><br><span class="line">TSharedPtr&lt;FSlateStyleSet&gt; FTcgXRStyle::StyleInstance = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRStyle::Initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!StyleInstance.<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line">StyleInstance = <span class="built_in">Create</span>();</span><br><span class="line">FSlateStyleRegistry::<span class="built_in">RegisterSlateStyle</span>(*StyleInstance);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRStyle::Shutdown</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FSlateStyleRegistry::<span class="built_in">UnRegisterSlateStyle</span>(*StyleInstance);</span><br><span class="line"><span class="built_in">ensure</span>(StyleInstance.<span class="built_in">IsUnique</span>());</span><br><span class="line">StyleInstance.<span class="built_in">Reset</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FName <span class="title">FTcgXRStyle::GetStyleSetName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="function"><span class="type">static</span> FName <span class="title">StyleSetName</span><span class="params">(TEXT(<span class="string">&quot;TcgXRStyle&quot;</span>))</span></span>;</span><br><span class="line"><span class="keyword">return</span> StyleSetName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> FVector2D <span class="title">Icon16x16</span><span class="params">(<span class="number">16.0f</span>, <span class="number">16.0f</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">const</span> FVector2D <span class="title">Icon20x20</span><span class="params">(<span class="number">20.0f</span>, <span class="number">20.0f</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">const</span> FVector2D <span class="title">Icon40x40</span><span class="params">(<span class="number">40.0f</span>, <span class="number">40.0f</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">TSharedRef&lt; FSlateStyleSet &gt; <span class="title">FTcgXRStyle::Create</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">TSharedRef&lt; FSlateStyleSet &gt; Style = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FSlateStyleSet</span>(<span class="string">&quot;TcgXRStyle&quot;</span>));</span><br><span class="line">Style-&gt;<span class="built_in">SetContentRoot</span>(IPluginManager::<span class="built_in">Get</span>().<span class="built_in">FindPlugin</span>(<span class="string">&quot;TcgXR&quot;</span>)-&gt;<span class="built_in">GetBaseDir</span>() / <span class="built_in">TEXT</span>(<span class="string">&quot;Resources&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use vector image brushes from Resources/TcgXR.svg for toolbar/menu icons</span></span><br><span class="line">Style-&gt;<span class="built_in">Set</span>(<span class="string">&quot;TcgXR.PluginAction&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH_SVG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TcgXR&quot;</span>), Icon40x40));</span><br><span class="line">Style-&gt;<span class="built_in">Set</span>(<span class="string">&quot;TcgXR.PluginAction.Small&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH_SVG</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TcgXR&quot;</span>), Icon20x20));</span><br><span class="line"><span class="keyword">return</span> Style;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTcgXRStyle::ReloadTextures</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (FSlateApplication::<span class="built_in">IsInitialized</span>())</span><br><span class="line">&#123;</span><br><span class="line">FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">GetRenderer</span>()-&gt;<span class="built_in">ReloadTextureResources</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> ISlateStyle&amp; <span class="title">FTcgXRStyle::Get</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> *StyleInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TcgXRViewportClient-cpp"><a href="#TcgXRViewportClient-cpp" class="headerlink" title="TcgXRViewportClient.cpp"></a>TcgXRViewportClient.cpp</h3><p><strong>文件路径</strong>: <code>Private\TcgXRViewportClient.cpp</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FTcgXRViewportClient implementation has been moved inline to TcgXRViewportClient.h</span></span><br><span class="line"><span class="comment">// This translation unit is intentionally left empty to avoid duplicate definitions.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="STcgXRViewport-h"><a href="#STcgXRViewport-h" class="headerlink" title="STcgXRViewport.h"></a>STcgXRViewport.h</h3><p><strong>文件路径</strong>: <code>Public\STcgXRViewport.h</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SEditorViewport.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTcgXRViewportClient</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FPreviewScene</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// TcgXR自定义Viewport控件，支持XR场景显示和相机控制</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">STcgXRViewport</span> :</span> public SEditorViewport</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">    SLATE_BEGIN_ARGS(STcgXRViewport) &#123;&#125;</span><br><span class="line">    SLATE_END_ARGS()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">Construct</span><span class="params">(<span class="type">const</span> FArguments&amp; InArgs)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XR状态控制接口</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetShowKeyed</span><span class="params">(<span class="type">bool</span> b)</span>; <span class="comment">// 设置是否显示抠像</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetVirtualCamMove</span><span class="params">(<span class="type">bool</span> b)</span>; <span class="comment">// 设置是否虚拟相机运动</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetMixedRealityBlend</span><span class="params">(<span class="type">bool</span> b)</span>; <span class="comment">// 设置是否虚实融合</span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsShowKeyed</span><span class="params">()</span> <span class="type">const</span>; <span class="comment">// 是否显示抠像</span></span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsVirtualCamMove</span><span class="params">()</span> <span class="type">const</span>; <span class="comment">// 是否虚拟相机运动</span></span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsMixedRealityBlend</span><span class="params">()</span> <span class="type">const</span>; <span class="comment">// 是否虚实融合</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 访问底层ViewportClient（用于复制相机/参数到其它视口）</span></span><br><span class="line">    TSharedPtr&lt;FTcgXRViewportClient&gt; <span class="title function_">GetClient</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> ViewportClient; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 安全设置相机参数：若Client尚未就绪，则缓存稍后应用</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFOVParam</span><span class="params">(<span class="type">float</span> InFOV)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetExposureParam</span><span class="params">(<span class="type">float</span> InExposure)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFocalLengthParam</span><span class="params">(<span class="type">float</span> InFocal)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetApertureParam</span><span class="params">(<span class="type">float</span> InAperture)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFocusDistanceParam</span><span class="params">(<span class="type">float</span> InFocus)</span>;</span><br><span class="line"></span><br><span class="line">protected:</span><br><span class="line">    <span class="comment">// 创建自定义ViewportClient</span></span><br><span class="line">    virtual TSharedRef&lt;FEditorViewportClient&gt; <span class="title function_">MakeEditorViewportClient</span><span class="params">()</span> override;</span><br><span class="line">    <span class="comment">// 不显示默认工具栏</span></span><br><span class="line">    virtual TSharedPtr&lt;SWidget&gt; <span class="title function_">MakeViewportToolbar</span><span class="params">()</span> override &#123; <span class="keyword">return</span> SNullWidget::NullWidget; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 捕获键盘输入分发到模块（用于热键切换相机）</span></span><br><span class="line">    virtual FReply <span class="title function_">OnKeyDown</span><span class="params">(<span class="type">const</span> FGeometry&amp; MyGeometry, <span class="type">const</span> FKeyEvent&amp; InKeyEvent)</span> override;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    <span class="comment">// 应用所有缓存的相机参数</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">ApplyCachedParams</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    TSharedPtr&lt;FTcgXRViewportClient&gt; ViewportClient; <span class="comment">// 视口客户端</span></span><br><span class="line">    TUniquePtr&lt;FPreviewScene&gt; PreviewScene; <span class="comment">// 预览场景</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存相机参数（在Client未就绪时临时保存）</span></span><br><span class="line">    TOptional&lt;<span class="type">float</span>&gt; CachedFOV;</span><br><span class="line">    TOptional&lt;<span class="type">float</span>&gt; CachedExposure;</span><br><span class="line">    TOptional&lt;<span class="type">float</span>&gt; CachedFocalLength;</span><br><span class="line">    TOptional&lt;<span class="type">float</span>&gt; CachedAperture;</span><br><span class="line">    TOptional&lt;<span class="type">float</span>&gt; CachedFocusDistance;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="TcgXR-h"><a href="#TcgXR-h" class="headerlink" title="TcgXR.h"></a>TcgXR.h</h3><p><strong>文件路径</strong>: <code>Public\TcgXR.h</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Modules/ModuleManager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FToolBarBuilder</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FMenuBuilder</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ACinemaCameraActor</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ACameraActor</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SWindow</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SVerticalBox</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTcgXRModule</span> :</span> public IModuleInterface</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line"><span class="comment">/** IModuleInterface implementation */</span></span><br><span class="line">virtual <span class="type">void</span> <span class="title function_">StartupModule</span><span class="params">()</span> override;</span><br><span class="line">virtual <span class="type">void</span> <span class="title function_">ShutdownModule</span><span class="params">()</span> override;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** This function will be bound to Command. */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">PluginButtonClicked</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 热键：处理按键（由STcgXRViewport调用），返回是否已处理</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">HandleKeyDown</span><span class="params">(<span class="type">const</span> FKey&amp; Key)</span>;</span><br><span class="line"><span class="comment">// 热键：绑定某个相机到某个按键</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">BindCameraHotkey</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera, <span class="type">const</span> FKey&amp; Key)</span>;</span><br><span class="line"><span class="comment">// 切换关卡视口到指定相机</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">SwitchToCamera</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera)</span>;</span><br><span class="line"><span class="comment">// 刷新相机列表并重建UI</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">RefreshCameraList</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭所有全屏窗口</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">CloseAllFullscreenWindows</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示当前控制的相机名称</span></span><br><span class="line">FText <span class="title function_">GetCurrentControlledCameraText</span><span class="params">()</span> <span class="type">const</span>;</span><br><span class="line"><span class="comment">// 获取相机已绑定的按键显示文本</span></span><br><span class="line">FText <span class="title function_">GetBoundKeyTextForCamera</span><span class="params">(TWeakObjectPtr&lt;ACameraActor&gt; Camera)</span> <span class="type">const</span>;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line"><span class="type">void</span> <span class="title function_">RegisterMenus</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Spawn the XR viewport tab</span></span><br><span class="line">TSharedRef&lt;class SDockTab&gt; <span class="title function_">OnSpawnPluginTab</span><span class="params">(<span class="type">const</span> class FSpawnTabArgs&amp; Args)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重建相机热键绑定UI</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">RebuildCameraHotkeyUI</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">TSharedPtr&lt;<span class="class"><span class="keyword">class</span> <span class="title">FUICommandList</span>&gt;</span> PluginCommands;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相机与热键映射</span></span><br><span class="line">TMap&lt;FKey, TWeakObjectPtr&lt;ACameraActor&gt;&gt; CameraHotkeyMap;</span><br><span class="line">TArray&lt;TWeakObjectPtr&lt;ACameraActor&gt;&gt; CachedCameras;</span><br><span class="line">TWeakPtr&lt;SVerticalBox&gt; CameraListPanel;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听句柄</span></span><br><span class="line">FDelegateHandle ActorAddedHandle;</span><br><span class="line">FDelegateHandle ActorDeletedHandle;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全屏窗口列表</span></span><br><span class="line">TArray&lt;TWeakPtr&lt;SWindow&gt;&gt; FullscreenWindows;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="TcgXRCommands-h"><a href="#TcgXRCommands-h" class="headerlink" title="TcgXRCommands.h"></a>TcgXRCommands.h</h3><p><strong>文件路径</strong>: <code>Public\TcgXRCommands.h</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Framework/Commands/Commands.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcgXRStyle.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTcgXRCommands</span> :</span> public TCommands&lt;FTcgXRCommands&gt;</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line"></span><br><span class="line">FTcgXRCommands()</span><br><span class="line">: TCommands&lt;FTcgXRCommands&gt;(TEXT(<span class="string">&quot;TcgXR&quot;</span>), NSLOCTEXT(<span class="string">&quot;Contexts&quot;</span>, <span class="string">&quot;TcgXR&quot;</span>, <span class="string">&quot;TcgXR Plugin&quot;</span>), NAME_None, FTcgXRStyle::GetStyleSetName())</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TCommands&lt;&gt; interface</span></span><br><span class="line">virtual <span class="type">void</span> <span class="title function_">RegisterCommands</span><span class="params">()</span> override;</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">TSharedPtr&lt; FUICommandInfo &gt; PluginAction;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="TcgXRStyle-h"><a href="#TcgXRStyle-h" class="headerlink" title="TcgXRStyle.h"></a>TcgXRStyle.h</h3><p><strong>文件路径</strong>: <code>Public\TcgXRStyle.h</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Styling/SlateStyle.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTcgXRStyle</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">Initialize</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">Shutdown</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** reloads textures used by slate renderer */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ReloadTextures</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** @return The Slate style set for the Shooter game */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> ISlateStyle&amp; <span class="title function_">Get</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> FName <span class="title function_">GetStyleSetName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> TSharedRef&lt; class FSlateStyleSet &gt; <span class="title function_">Create</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> TSharedPtr&lt; <span class="class"><span class="keyword">class</span> <span class="title">FSlateStyleSet</span> &gt;</span> StyleInstance;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="TcgXRViewportClient-h"><a href="#TcgXRViewportClient-h" class="headerlink" title="TcgXRViewportClient.h"></a>TcgXRViewportClient.h</h3><p><strong>文件路径</strong>: <code>Public\TcgXRViewportClient.h</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EditorViewportClient.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;PreviewScene.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SEditorViewport.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Editor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SceneView.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// TcgXR自定义ViewportClient，负责相机控制、XR显示等</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTcgXRViewportClient</span> :</span> public FEditorViewportClient</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">    <span class="comment">// 构造函数，初始化视口参数</span></span><br><span class="line">    FTcgXRViewportClient(FPreviewScene* InPreviewScene, <span class="type">const</span> TSharedRef&lt;SEditorViewport&gt;&amp; InEditorViewport)</span><br><span class="line">        : FEditorViewportClient(nullptr, InPreviewScene, InEditorViewport)</span><br><span class="line">    &#123;</span><br><span class="line">        SetViewLocation(FVector(<span class="number">0</span>, <span class="number">-300</span>, <span class="number">200</span>));</span><br><span class="line">        SetViewRotation(FRotator(<span class="number">-10</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        SetRealtime(<span class="literal">true</span>);</span><br><span class="line">        EngineShowFlags.SetGrid(<span class="literal">true</span>);</span><br><span class="line">        EngineShowFlags.EnableAdvancedFeatures();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染主编辑器世界，保证视口内容与主场景一致</span></span><br><span class="line">    virtual UWorld* <span class="title function_">GetWorld</span><span class="params">()</span> <span class="type">const</span> override</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (GEditor) ? GEditor-&gt;GetEditorWorldContext().World() : nullptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XR相关切换</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetShowKeyed</span><span class="params">(<span class="type">bool</span> bValue)</span></span><br><span class="line">    &#123;</span><br><span class="line">        bShowKeyed = bValue;</span><br><span class="line">        EngineShowFlags.PostProcessing = bShowKeyed; <span class="comment">// 示例：切换后处理</span></span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetVirtualCamMove</span><span class="params">(<span class="type">bool</span> bValue)</span></span><br><span class="line">    &#123;</span><br><span class="line">        bVirtualCamMove = bValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetMixedRealityBlend</span><span class="params">(<span class="type">bool</span> bValue)</span></span><br><span class="line">    &#123;</span><br><span class="line">        bMixedRealityBlend = bValue;</span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 相机参数控制</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFOV</span><span class="params">(<span class="type">float</span> InFOV)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewFOV = FMath::Clamp(InFOV, <span class="number">15.f</span>, <span class="number">170.f</span>);</span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">GetFOV</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> ViewFOV; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetExposure</span><span class="params">(<span class="type">float</span> InExposure)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ManualExposureBias = FMath::Clamp(InExposure, <span class="number">-10.f</span>, <span class="number">10.f</span>);</span><br><span class="line">        bApplyExposureBias = <span class="literal">true</span>; <span class="comment">// 启用曝光补偿</span></span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">GetExposure</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> ManualExposureBias; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFocalLength</span><span class="params">(<span class="type">float</span> InFocalLength)</span></span><br><span class="line">    &#123;</span><br><span class="line">        FocalLength = FMath::Max(<span class="number">1.f</span>, InFocalLength);</span><br><span class="line">        <span class="comment">// 使用默认胶片宽度36mm将焦距映射到FOV</span></span><br><span class="line">        <span class="type">const</span> <span class="type">float</span> SensorWidth = <span class="number">36.0f</span>; <span class="comment">// mm</span></span><br><span class="line">        <span class="type">const</span> <span class="type">float</span> HFOVRadians = <span class="number">2.f</span> * FMath::Atan((SensorWidth * <span class="number">0.5f</span>) / FocalLength);</span><br><span class="line">        SetFOV(FMath::RadiansToDegrees(HFOVRadians));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">GetFocalLength</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> FocalLength; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetAperture</span><span class="params">(<span class="type">float</span> InAperture)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Aperture = FMath::Clamp(InAperture, <span class="number">0.7f</span>, <span class="number">32.f</span>);</span><br><span class="line">        bApplyDOF = <span class="literal">true</span>; <span class="comment">// 启用景深覆盖</span></span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">GetAperture</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> Aperture; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetFocusDistance</span><span class="params">(<span class="type">float</span> InDistance)</span></span><br><span class="line">    &#123;</span><br><span class="line">        FocusDistance = FMath::Max(<span class="number">1.f</span>, InDistance);</span><br><span class="line">        bApplyDOF = <span class="literal">true</span>;</span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">GetFocusDistance</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> FocusDistance; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从外部视口复制相机参数</span></span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetCameraFrom</span><span class="params">(<span class="type">const</span> FVector&amp; InLoc, <span class="type">const</span> FRotator&amp; InRot, <span class="type">float</span> InFOV, <span class="type">float</span> InOrthoWidth, <span class="type">bool</span> bInIsOrtho)</span></span><br><span class="line">    &#123;</span><br><span class="line">        SetViewLocation(InLoc);</span><br><span class="line">        SetViewRotation(InRot);</span><br><span class="line">        <span class="keyword">if</span> (bInIsOrtho)</span><br><span class="line">        &#123;</span><br><span class="line">            SetViewportType(LVT_OrthoFreelook);</span><br><span class="line">            SetOrthoZoom(InOrthoWidth);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            SetViewportType(LVT_Perspective);</span><br><span class="line">            ViewFOV = InFOV;</span><br><span class="line">        &#125;</span><br><span class="line">        Invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual <span class="type">void</span> <span class="title function_">Tick</span><span class="params">(<span class="type">float</span> DeltaSeconds)</span> override</span><br><span class="line">    &#123;</span><br><span class="line">        FEditorViewportClient::Tick(DeltaSeconds);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!bVirtualCamMove &amp;&amp; GEditor)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (FEditorViewportClient* VC : GEditor-&gt;GetAllViewportClients())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (VC &amp;&amp; VC-&gt;IsPerspective())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">const</span> FVector Loc = VC-&gt;GetViewLocation();</span><br><span class="line">                    <span class="type">const</span> FRotator Rot = VC-&gt;GetViewRotation();</span><br><span class="line">                    <span class="type">const</span> <span class="type">bool</span> bIsOrtho = VC-&gt;IsOrtho();</span><br><span class="line">                    <span class="type">const</span> <span class="type">float</span> FOV = ViewFOV; <span class="comment">// 使用当前FOV</span></span><br><span class="line">                    <span class="type">const</span> <span class="type">float</span> OrthoWidth = <span class="number">2048.f</span>;</span><br><span class="line">                    SetCameraFrom(Loc, Rot, FOV, OrthoWidth, bIsOrtho);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bVirtualCamMove)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">float</span> Speed = <span class="number">15.f</span>;</span><br><span class="line">            FRotator R = GetViewRotation();</span><br><span class="line">            R.Yaw += Speed * DeltaSeconds;</span><br><span class="line">            SetViewRotation(R);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 覆盖后处理参数：仅在需要时设置曝光补偿/景深，尽量保持与编辑器视口一致</span></span><br><span class="line">    virtual <span class="type">void</span> <span class="title function_">OverridePostProcessSettings</span><span class="params">(FSceneView&amp; View)</span> override</span><br><span class="line">    &#123;</span><br><span class="line">        FEditorViewportClient::OverridePostProcessSettings(View);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bApplyExposureBias)</span><br><span class="line">        &#123;</span><br><span class="line">            View.FinalPostProcessSettings.bOverride_AutoExposureBias = <span class="literal">true</span>;</span><br><span class="line">            View.FinalPostProcessSettings.AutoExposureBias = ManualExposureBias;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bApplyDOF)</span><br><span class="line">        &#123;</span><br><span class="line">            View.FinalPostProcessSettings.bOverride_DepthOfFieldFstop = <span class="literal">true</span>;</span><br><span class="line">            View.FinalPostProcessSettings.DepthOfFieldFstop = Aperture;</span><br><span class="line">            View.FinalPostProcessSettings.bOverride_DepthOfFieldFocalDistance = <span class="literal">true</span>;</span><br><span class="line">            View.FinalPostProcessSettings.DepthOfFieldFocalDistance = FocusDistance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XR状态查询</span></span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsShowKeyed</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> bShowKeyed; &#125;</span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsVirtualCamMove</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> bVirtualCamMove; &#125;</span><br><span class="line">    <span class="type">bool</span> <span class="title function_">IsMixedRealityBlend</span><span class="params">()</span> <span class="type">const</span> &#123; <span class="keyword">return</span> bMixedRealityBlend; &#125;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    <span class="type">bool</span> bShowKeyed = <span class="literal">false</span>; <span class="comment">// 是否显示抠像</span></span><br><span class="line">    <span class="type">bool</span> bVirtualCamMove = <span class="literal">false</span>; <span class="comment">// 是否虚拟相机运动</span></span><br><span class="line">    <span class="type">bool</span> bMixedRealityBlend = <span class="literal">true</span>; <span class="comment">// 是否虚实融合</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 相机可调参数</span></span><br><span class="line">    <span class="type">float</span> ManualExposureBias = <span class="number">0.f</span>; <span class="comment">// 曝光补偿（log2EV）</span></span><br><span class="line">    <span class="type">bool</span>  bApplyExposureBias = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">float</span> FocalLength = <span class="number">35.f</span>;   <span class="comment">// 焦距（mm）</span></span><br><span class="line">    <span class="type">float</span> Aperture = <span class="number">2.8f</span>;      <span class="comment">// 光圈（F）</span></span><br><span class="line">    <span class="type">float</span> FocusDistance = <span class="number">1000.f</span>; <span class="comment">// 对焦距离</span></span><br><span class="line">    <span class="type">bool</span>  bApplyDOF = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="TcgXR-Build-cs"><a href="#TcgXR-Build-cs" class="headerlink" title="TcgXR.Build.cs"></a>TcgXR.Build.cs</h3><p><strong>文件路径</strong>: <code>TcgXR.Build.cs</code></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnrealBuildTool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TcgXR</span> : <span class="title">ModuleRules</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TcgXR</span>(<span class="params">ReadOnlyTargetRules Target</span>) : <span class="title">base</span>(<span class="params">Target</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">PCHUsage = ModuleRules.PCHUsageMode.UseExplicitOrSharedPCHs;</span><br><span class="line"></span><br><span class="line">PublicIncludePaths.AddRange(</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">string</span>[] &#123;</span><br><span class="line"><span class="comment">// ... add public include paths required here ...</span></span><br><span class="line">&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PrivateIncludePaths.AddRange(</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">string</span>[] &#123;</span><br><span class="line"><span class="comment">// ... add other private include paths required here ...</span></span><br><span class="line">&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PublicDependencyModuleNames.AddRange(</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">string</span>[]</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;Core&quot;</span>,</span><br><span class="line"><span class="comment">// ... add other public dependencies that you statically link with here ...</span></span><br><span class="line">&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PrivateDependencyModuleNames.AddRange(</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">string</span>[]</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;Projects&quot;</span>,</span><br><span class="line"><span class="string">&quot;InputCore&quot;</span>,</span><br><span class="line"><span class="string">&quot;EditorFramework&quot;</span>,</span><br><span class="line"><span class="string">&quot;UnrealEd&quot;</span>,</span><br><span class="line"><span class="string">&quot;ToolMenus&quot;</span>,</span><br><span class="line"><span class="string">&quot;CoreUObject&quot;</span>,</span><br><span class="line"><span class="string">&quot;Engine&quot;</span>,</span><br><span class="line"><span class="string">&quot;Slate&quot;</span>,</span><br><span class="line"><span class="string">&quot;SlateCore&quot;</span>,</span><br><span class="line"><span class="string">&quot;AppFramework&quot;</span>,</span><br><span class="line"><span class="string">&quot;LevelEditor&quot;</span>,</span><br><span class="line"><span class="string">&quot;CinematicCamera&quot;</span>, <span class="comment">// 使用电影相机</span></span><br><span class="line"><span class="comment">// ... add private dependencies that you statically link with here ...</span></span><br><span class="line">&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DynamicallyLoadedModuleNames.AddRange(</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">string</span>[]</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ... add any modules that your module loads dynamically here ...</span></span><br><span class="line">&#125;</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li><a href="https://www.bilibili.com/video/BV17NQVYBEBi/">最基础概览视频</a>:我看着这个视频作为最初的入门</li><li><a href="https://www.youtube.com/watch?v=vI_b2OO4yZE">Aximmetry Eye Camera Tracking Device</a>：里面还提及了如何解决TimeCode的问题</li><li><a href="https://www.youtube.com/watch?v=dugtm2TlY44">Virtual Production demo with Aximmetry Eye mobile app</a>：这里面提及了Iphone数据流送回来的方案</li><li><a href="https://www.youtube.com/watch?v=tm_5o6eRcpM">Aximmetry Eye VIrtual Camera Tracker</a>：里面有提及标定的事情，也有提及（可能）使用WIFI6能够实现无线传输。</li></ol>]]></content:encoded>
      
      
      
      <category domain="http://example.com/tags/XR/">XR</category>
      
      <category domain="http://example.com/tags/Aximmetry/">Aximmetry</category>
      
      
      <comments>http://example.com/2025/09/13/Notes/Aximmetry/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Shader Learning Notes</title>
      <link>http://example.com/2025/08/01/Notes/Shader%20Learning%20Note/</link>
      <guid>http://example.com/2025/08/01/Notes/Shader%20Learning%20Note/</guid>
      <pubDate>Fri, 01 Aug 2025 04:34:56 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Unreal-Shader学习&quot;&gt;&lt;a href=&quot;#Unreal-Shader学习&quot; class=&quot;headerlink&quot; title=&quot;Unreal Shader学习&quot;&gt;&lt;/a&gt;Unreal Shader学习&lt;/h1&gt;&lt;h2 id=&quot;安装及基础概念&quot;&gt;&lt;a h</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Unreal-Shader学习"><a href="#Unreal-Shader学习" class="headerlink" title="Unreal Shader学习"></a>Unreal Shader学习</h1><h2 id="安装及基础概念"><a href="#安装及基础概念" class="headerlink" title="安装及基础概念"></a>安装及基础概念</h2><p><a href="https://juejin.cn/post/7164635658084941837">知乎 《Shader从入门到放弃》 在VS中可以安装ShaderToy来观测GLSL</a><br>👆这个文字教程也是很不错的</p><p><a href="https://juejin.cn/post/7089771936271564807">Unreal 5.0 材质中添加自定义 Shader 代码</a>  在UE中需要设置Shder文件的位置</p><p>&lt;img src&#x3D;”<a href="https://s2.loli.net/2025/09/13/CxzRNf1Witu69IU.png">https://s2.loli.net/2025/09/13/CxzRNf1Witu69IU.png</a>“ alt&#x3D;”Unreal Sha原本的3D流程应该是：”原画师绘制场景图（将3D场景画下来） -&gt; 建模师根据原画构建场景模型（产出3D模型）-&gt; 程序渲染（将3D模型导入到引擎中，或者其他3D渲染库），然后渲染成画面”。</p><img src="https://s2.loli.net/2025/09/13/bGh2JSUj4oK1WVI.png" alt="img" style="width: 30%;"><p>主要是两种着色器：</p><ol><li><p><strong>Fragment Shader</strong>（片元shader）：输入插值后的顶点数据，输出最终像素颜色（<code>fragColor</code>）。</p></li><li><p><strong>Vertex Shader</strong>（顶点Shader）：输入单个顶点数据（位置&#x2F;法线等），输出处理后的顶点位置（<code>gl_Position</code>）和其他插值数据。</p></li><li><p>compute shader 计算着色器</p></li><li><p>geometry shader 几何着色器</p></li><li><p>….</p></li></ol><h1 id="HLSL"><a href="#HLSL" class="headerlink" title="HLSL"></a>HLSL</h1><h2 id="基础的语法"><a href="#基础的语法" class="headerlink" title="基础的语法"></a>基础的语法</h2><table><thead><tr><th>min max<br/></th><th>最大最小<br/></th></tr></thead><tbody><tr><td>abs<br/></td><td>绝对值<br/></td></tr><tr><td>fmod<br/></td><td>取余操作<br/></td></tr><tr><td>round<br/></td><td>四舍五入<br/></td></tr><tr><td>pow<br/></td><td>指数<br/></td></tr><tr><td>sqrt rsqrt<br/></td><td>平方根 和 倒数平方根<br/></td></tr><tr><td>degrees（x） redians<br/></td><td>弧度转角度 角度转弧度<br/></td></tr><tr><td>length<br/></td><td>向量到原点的距离<br/></td></tr><tr><td>frac(sin(dot(uv, float2(12.9898, 78.233))) * 43758.5453);<br/></td><td>噪声算法<br/></td></tr><tr><td>sin cos tan<br/></td><td>三角函数<br/></td></tr><tr><td>asin acos atan<br/></td><td>他们的反函数<br/></td></tr><tr><td>sinh cosh tanh<br/></td><td>双曲线函数<br/></td></tr><tr><td>ceil<br/></td><td>数值范围函数<br/></td></tr></tbody></table><img src="https://s2.loli.net/2025/09/13/Db5ArJdyQv7E9YG.png" alt="Unreal Shader学习-1" style="width: 30%;"><h2 id="UV坐标系说明"><a href="#UV坐标系说明" class="headerlink" title="UV坐标系说明:"></a><strong>UV坐标系说明:</strong></h2><ul><li>原点 <strong>(0,0)</strong> 位于左下角</li><li>(0,1) 左上角，(1,1) 右上角，(1,0) 右下角</li></ul><h1 id="GLSL"><a href="#GLSL" class="headerlink" title="GLSL"></a>GLSL</h1><h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><h3 id="step"><a href="#step" class="headerlink" title="step"></a>step</h3><blockquote><p>如果x 小于某个值，则返回 0，如果大于等于这个值，则返回1。</p></blockquote><p>所以上面的代码可以简化成：</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if(abs(uv.x) &lt;= 2. * fwidth(uv.x)) &#123;</span></span><br><span class="line"><span class="comment">//     color = vec3(0.0, 1.0, 0.0);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// ===&gt;</span></span><br><span class="line"></span><br><span class="line">color = <span class="built_in">step</span>(<span class="built_in">abs</span>(uv.x), <span class="number">2.0</span> * <span class="built_in">fwidth</span>(uv.x)) * <span class="type">vec3</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>);</span><br></pre></td></tr></table></figure><h3 id="mix"><a href="#mix" class="headerlink" title="mix"></a>mix</h3><blockquote><p>该函数的实际上执行的就是一个简单的 <em><strong>线性差值</strong></em>。 简单的说就是：当a &#x3D; 1时，返回的值为y, 但a &#x3D; 0时，返回x的值，如果返回的值为0.5，则返回 <code>0.5x + 0.5y</code>的值，同理，如果a &#x3D; 0.2, 返回 <code>0.8 * a + 0.2 * y</code>。</p></blockquote><p>我们可以利用这个函数来做颜色叠加，颜色叠加的公式可以写为：<br>$$<br>Color&#x3D;Src.color∗(1−Dst.a)+Dst.color∗Dst.a<br>$$</p><h3 id="smoothstep"><a href="#smoothstep" class="headerlink" title="smoothstep"></a>smoothstep</h3><img src="https://s2.loli.net/2025/09/13/serIA7TCWUdJnBY.png" alt="ShaderSmoothstep" style="width: 30%;"><p>我们可以直观的看出：当x &lt; 0时，返回0，当 x &gt; 1时，返回1，如果 x 处于0~1之间时，则有一个类似于线性插值的过渡，但是请注意，这里并不是线性插值，因为在接近两端的值的时候，该函数有一个平滑的过渡。所以我们可以通过这一点来对 <code>step</code> 函数进行替换以解决锯齿的问题。</p><h3 id="floor"><a href="#floor" class="headerlink" title="floor"></a>floor</h3><p> 作用是<strong>向下取整</strong>，它会返回不大于输入值的最大整数。例如：对 <code>uv</code> 向量的每个分量（x和y）分别执行向下取整</p><p>例如：</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">floor</span>(<span class="number">3.7</span>)` → `<span class="number">3.0</span></span><br><span class="line"><span class="built_in">floor</span>(<span class="number">-1.2</span>)` → `<span class="number">-2.0</span></span><br></pre></td></tr></table></figure><h2 id="核心步骤（渲染管线）"><a href="#核心步骤（渲染管线）" class="headerlink" title="核心步骤（渲染管线）"></a>核心步骤（渲染管线）</h2><ol><li>顶点变换的过程（顶点着色器）</li><li>图元装配（按哪种方式装配图元，装配为点，线还是三角形）</li><li>光栅化（将上述的图元从矢量图形转换为像素组成的图形）</li><li>着色（片段着色器）</li><li>测试（Alpha测试，深度测试，模板测试等）&amp; 混合</li></ol><img src="https://s2.loli.net/2025/09/13/oXpMmr2g5wUtbyP.png" alt="WXWorkCapture_17531696303010" style="width: 30%;"><h2 id="坐标系"><a href="#坐标系" class="headerlink" title="坐标系"></a>坐标系</h2><div style="display: flex; gap: 20px; align-items: flex-start;"><img src="https://s2.loli.net/2025/09/13/d1zabnP8quoMp3F.png" alt="image-20250722154307710" style="width: 30%;"><img src="https://s2.loli.net/2025/09/13/hxSrfLa5FeM7UnD.png" alt="image-20250722154418915" style="width: 30%;"></div><p>这是左手坐标系 反之是右手坐标系</p><p>OpenGL是右手坐标系</p><h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><h3 id="1-最初始的实例代码-（实现一个坐标轴）"><a href="#1-最初始的实例代码-（实现一个坐标轴）" class="headerlink" title="1. 最初始的实例代码  （实现一个坐标轴）:"></a>1. 最初始的实例代码  （实现一个坐标轴）:</h3><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 归一化uv坐标到[-1,1]范围，保持宽高比</span></span><br><span class="line"><span class="type">vec2</span> fixUV(<span class="type">vec2</span> coord) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2.0</span> * (coord - <span class="number">0.5</span> * iResolution.xy) / <span class="built_in">min</span>(iResolution.x, iResolution.y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绘制网格线</span></span><br><span class="line"><span class="type">bool</span> drawGrid(<span class="type">vec2</span> uv, <span class="type">float</span> scale) &#123;</span><br><span class="line">    <span class="comment">// fract(uv * scale)：将坐标按比例缩放后取小数部分，得到每个网格内的相对坐标</span></span><br><span class="line">    <span class="comment">// fwidth(f_uv.x)：计算片段着色器中相邻像素的梯度，即当前像素到下一像素的变化率</span></span><br><span class="line">    <span class="type">vec2</span> f_uv = <span class="built_in">fract</span>(uv * scale);</span><br><span class="line">    <span class="comment">// abs(f_uv.x) &lt; fwidth(f_uv.x)：当相对坐标接近 0 时（即网格线位置），返回 true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">abs</span>(f_uv.x) &lt; <span class="built_in">fwidth</span>(f_uv.x) || <span class="built_in">abs</span>(f_uv.y) &lt; <span class="built_in">fwidth</span>(f_uv.y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绘制坐标轴</span></span><br><span class="line"><span class="type">vec3</span> drawAxis(<span class="type">vec2</span> uv) &#123;</span><br><span class="line">    <span class="type">vec3</span> color = <span class="type">vec3</span>(<span class="number">0.0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">abs</span>(uv.x) &lt; <span class="built_in">fwidth</span>(uv.x)) &#123;</span><br><span class="line">        color = <span class="type">vec3</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>); <span class="comment">// x轴为绿色</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">abs</span>(uv.y) &lt; <span class="built_in">fwidth</span>(uv.y)) &#123;</span><br><span class="line">        color = <span class="type">vec3</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>); <span class="comment">// y轴为红色</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主函数</span></span><br><span class="line"><span class="type">void</span> mainImage(<span class="keyword">out</span> <span class="type">vec4</span> fragColor, <span class="keyword">in</span> <span class="type">vec2</span> fragCoord) &#123;</span><br><span class="line">    <span class="comment">// 归一化坐标</span></span><br><span class="line">    <span class="type">vec2</span> uv = fixUV(fragCoord);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 基础背景色</span></span><br><span class="line">    <span class="type">vec3</span> color = <span class="type">vec3</span>(<span class="number">0.0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绘制网格</span></span><br><span class="line">    <span class="keyword">if</span>(drawGrid(uv, <span class="number">3.0</span>)) &#123;</span><br><span class="line">        color = <span class="type">vec3</span>(<span class="number">1.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绘制坐标轴（会覆盖网格线）</span></span><br><span class="line">    <span class="type">vec3</span> axisColor = drawAxis(uv);</span><br><span class="line">    <span class="keyword">if</span>(axisColor != <span class="type">vec3</span>(<span class="number">0.0</span>)) &#123;</span><br><span class="line">        color = axisColor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    fragColor = <span class="type">vec4</span>(color, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://www.shadertoy.com/view/Wf2fRw">https://www.shadertoy.com/view/Wf2fRw</a><br>这个shader创建了一个坐标系统，包含网格线和彩色坐标轴。</p><h3 id="2-实现函数的y-kx的绘制"><a href="#2-实现函数的y-kx的绘制" class="headerlink" title="2. 实现函数的y&#x3D;kx的绘制"></a>2. 实现函数的y&#x3D;kx的绘制</h3><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 归一化uv坐标到[-1,1]范围，保持宽高比</span></span><br><span class="line"><span class="type">vec2</span> fixUV(<span class="type">vec2</span> coord) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2.0</span> * (coord - <span class="number">0.5</span> * iResolution.xy) / <span class="built_in">min</span>(iResolution.x, iResolution.y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绘制网格线</span></span><br><span class="line"><span class="type">bool</span> drawGrid(<span class="type">vec2</span> uv, <span class="type">float</span> scale) &#123;</span><br><span class="line">    <span class="type">vec2</span> f_uv = <span class="built_in">fract</span>(uv * scale);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">abs</span>(f_uv.x) &lt; <span class="built_in">fwidth</span>(f_uv.x) || <span class="built_in">abs</span>(f_uv.y) &lt; <span class="built_in">fwidth</span>(f_uv.y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绘制坐标轴</span></span><br><span class="line"><span class="type">vec3</span> drawAxis(<span class="type">vec2</span> uv) &#123;</span><br><span class="line">    <span class="type">vec3</span> color = <span class="type">vec3</span>(<span class="number">0.0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">abs</span>(uv.x) &lt; <span class="built_in">fwidth</span>(uv.x)) &#123;</span><br><span class="line">        color = <span class="type">vec3</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>); <span class="comment">// x轴为绿色</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">abs</span>(uv.y) &lt; <span class="built_in">fwidth</span>(uv.y)) &#123;</span><br><span class="line">        color = <span class="type">vec3</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>); <span class="comment">// y轴为红色</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算点到直线距离的向量实现</span></span><br><span class="line"><span class="comment">// 这个函数计算点p到线段ab的最短距离</span></span><br><span class="line"><span class="comment">// a、b是线段的两个端点</span></span><br><span class="line"><span class="type">float</span> distLine(<span class="type">vec2</span> p, <span class="type">vec2</span> a, <span class="type">vec2</span> b) &#123;</span><br><span class="line">    <span class="type">vec2</span> ab = b - a;</span><br><span class="line">    <span class="type">vec2</span> ap = p - a;</span><br><span class="line">    <span class="type">vec2</span> ad = <span class="built_in">dot</span>(ab, ap) / <span class="built_in">dot</span>(ab, ab) * ab;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">length</span>(ap - ad);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主函数</span></span><br><span class="line"><span class="type">void</span> mainImage(<span class="keyword">out</span> <span class="type">vec4</span> fragColor, <span class="keyword">in</span> <span class="type">vec2</span> fragCoord) &#123;</span><br><span class="line">    <span class="comment">// 旧的部分</span></span><br><span class="line">    <span class="type">vec2</span> uv = fixUV(fragCoord);</span><br><span class="line">    <span class="type">vec3</span> color = <span class="type">vec3</span>(<span class="number">0.0</span>);</span><br><span class="line">    <span class="keyword">if</span>(drawGrid(uv, <span class="number">10.0</span>)) &#123;</span><br><span class="line">        color = <span class="type">vec3</span>(<span class="number">1.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">vec3</span> axisColor = drawAxis(uv);</span><br><span class="line">    <span class="keyword">if</span>(axisColor != <span class="type">vec3</span>(<span class="number">0.0</span>)) &#123;</span><br><span class="line">        color = axisColor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> d = distLine(uv, <span class="type">vec2</span>(<span class="number">0.0</span>), <span class="type">vec2</span>(<span class="number">1.0</span>));</span><br><span class="line">    color = <span class="built_in">mix</span>(color, <span class="type">vec3</span>(<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>), <span class="built_in">smoothstep</span>(<span class="number">0.002</span>, <span class="number">0.001</span>, d));</span><br><span class="line">    fragColor = <span class="type">vec4</span>(color, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://www.shadertoy.com/view/3c2fzw">https://www.shadertoy.com/view/3c2fzw</a></p><h3 id="3-实现一段复杂函数的绘制（分段绘制）"><a href="#3-实现一段复杂函数的绘制（分段绘制）" class="headerlink" title="3. 实现一段复杂函数的绘制（分段绘制）"></a>3. 实现一段复杂函数的绘制（分段绘制）</h3><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define PI 3.1415926</span></span><br><span class="line"><span class="meta">#define STEP 1.0</span></span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> fixUV(<span class="type">vec2</span> coord) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3.0</span> * (<span class="number">2.</span> * (coord.xy - <span class="number">0.5</span> * iResolution.xy) / <span class="built_in">min</span>(iResolution.x, iResolution.y));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec3</span> grid(<span class="type">vec2</span> uv) &#123;</span><br><span class="line">    <span class="type">vec3</span> color = <span class="type">vec3</span>(<span class="number">0.95</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">vec2</span> cell = <span class="number">1.0</span> - <span class="number">2.0</span> * <span class="built_in">abs</span>(<span class="built_in">fract</span>(uv) - <span class="number">0.5</span>);</span><br><span class="line">    color = <span class="built_in">mix</span>(color, <span class="type">vec3</span>(<span class="number">0.7</span>), <span class="built_in">step</span>(cell.x, <span class="number">4.0</span> * <span class="built_in">fwidth</span>(uv.x)));</span><br><span class="line">    color = <span class="built_in">mix</span>(color, <span class="type">vec3</span>(<span class="number">0.7</span>), <span class="built_in">smoothstep</span>(<span class="number">4.0</span> * <span class="built_in">fwidth</span>(uv.y), <span class="number">3.9</span> * <span class="built_in">fwidth</span>(uv.y), cell.y));</span><br><span class="line">    color = <span class="built_in">mix</span>(color, <span class="type">vec3</span>(<span class="number">0.3</span>, <span class="number">0.7</span>, <span class="number">0.8</span>), <span class="built_in">smoothstep</span>(<span class="number">2.0</span> * <span class="built_in">fwidth</span>(uv.x), <span class="number">1.9</span> * <span class="built_in">fwidth</span>(uv.x), <span class="built_in">abs</span>(uv.x)));</span><br><span class="line">    color = <span class="built_in">mix</span>(color, <span class="type">vec3</span>(<span class="number">1.0</span>, <span class="number">0.5</span>, <span class="number">0.0</span>), <span class="built_in">smoothstep</span>(<span class="number">2.0</span> * <span class="built_in">fwidth</span>(uv.x), <span class="number">1.9</span> * <span class="built_in">fwidth</span>(uv.y), <span class="built_in">abs</span>(uv.y)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> func(<span class="keyword">in</span> <span class="type">float</span> x) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sin</span>(x + <span class="built_in">sin</span>(x + <span class="built_in">sin</span>(x) * <span class="number">0.8</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> distLine(<span class="type">vec2</span> p, <span class="type">vec2</span> a, <span class="type">vec2</span> b) &#123;</span><br><span class="line">    <span class="type">vec2</span> ab = b - a;</span><br><span class="line">    <span class="type">vec2</span> ap = p - a;</span><br><span class="line">    <span class="type">vec2</span> ad = <span class="built_in">clamp</span>(<span class="built_in">dot</span>(ab, ap) / <span class="built_in">dot</span>(ab, ab), <span class="number">0.0</span>, <span class="number">1.0</span>) * ab;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">length</span>(ap - ad);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 它是一个数学计算函数，返回的是一个表示&quot;线段影响值&quot;的浮点数。</span></span><br><span class="line"><span class="comment">// 返回的 float 值表示当前像素(uv)与线段的接近程度</span></span><br><span class="line"><span class="comment">// 值范围在 0.0 到 1.0 之间：</span></span><br><span class="line"><span class="comment">// 0.0 表示像素完全在线段之外</span></span><br><span class="line"><span class="comment">// 1.0 表示像素正好在线段上</span></span><br><span class="line"><span class="comment">// 中间值表示像素在线段附近(有抗锯齿效果)</span></span><br><span class="line"><span class="type">float</span> segment(<span class="type">vec2</span> p, <span class="type">vec2</span> a, <span class="type">vec2</span> b, <span class="type">float</span> w) &#123;</span><br><span class="line">    <span class="type">float</span> f = <span class="number">0.0</span>;</span><br><span class="line">    <span class="type">vec2</span> ab = b - a;</span><br><span class="line">    <span class="type">vec2</span> ap = p - a;</span><br><span class="line">    <span class="type">float</span> proj = <span class="built_in">clamp</span>(<span class="built_in">dot</span>(ab, ap) / <span class="built_in">dot</span>(ab, ab), <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    <span class="type">float</span> d = <span class="built_in">length</span>(ap - proj * ab);</span><br><span class="line">    f = <span class="built_in">smoothstep</span>(w, w * <span class="number">0.2</span>, d);</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> plotFunc(<span class="keyword">in</span> <span class="type">vec2</span> uv) &#123;</span><br><span class="line">    <span class="type">float</span> f = <span class="number">0.0</span>;</span><br><span class="line">    <span class="comment">// 这是一个从 0 到屏幕宽度(iResolution.x)的循环</span></span><br><span class="line">    <span class="comment">// STEP 是步长(已定义为 1.0)，控制采样点的密度</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">float</span> x = <span class="number">0.0</span>; x &lt;= iResolution.x; x += STEP) &#123;</span><br><span class="line">        <span class="comment">// 上一个点的坐标</span></span><br><span class="line">        <span class="type">float</span> fx = fixUV(<span class="type">vec2</span>(x, <span class="number">0.0</span>)).x;</span><br><span class="line">        <span class="comment">// 下一个点的坐标</span></span><br><span class="line">        <span class="type">float</span> nfx = fixUV(<span class="type">vec2</span>(x + STEP, <span class="number">0.0</span>)).x;</span><br><span class="line">        f += segment(uv, <span class="type">vec2</span>(fx, func(fx)), <span class="type">vec2</span>(nfx, func(nfx)), <span class="number">0.006</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> mainImage(<span class="keyword">out</span> <span class="type">vec4</span> fragColor, <span class="keyword">in</span> <span class="type">vec2</span> fragCoord) &#123;</span><br><span class="line">    <span class="comment">// old</span></span><br><span class="line">    <span class="type">vec2</span> uv = fixUV(fragCoord.xy);</span><br><span class="line">    <span class="type">vec3</span> color = grid(uv);</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> f = plotFunc(uv);</span><br><span class="line">    color = <span class="built_in">mix</span>(color, <span class="type">vec3</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>), f);</span><br><span class="line">    fragColor = <span class="type">vec4</span>(color, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://www.shadertoy.com/view/Wc2fzw">https://www.shadertoy.com/view/Wc2fzw</a></p><h3 id="4-实现一个（静态）星芒效果"><a href="#4-实现一个（静态）星芒效果" class="headerlink" title="4. 实现一个（静态）星芒效果"></a>4. 实现一个（静态）星芒效果</h3><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define PI 3.1415926</span></span><br><span class="line"><span class="meta">#define STEP 1.0</span></span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> fixUV(<span class="type">vec2</span> coord) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4.0</span> * (<span class="number">2.</span> * (coord.xy - <span class="number">0.5</span> * iResolution.xy) / <span class="built_in">min</span>(iResolution.x, iResolution.y));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec3</span> grid(<span class="type">vec2</span> uv) &#123;</span><br><span class="line">    <span class="comment">// 坐标外其他颜色绘制改变</span></span><br><span class="line">    <span class="type">vec3</span> color = <span class="type">vec3</span>(<span class="number">0.0</span>);</span><br><span class="line">    color.rg = <span class="built_in">fract</span>(uv);</span><br><span class="line"></span><br><span class="line">    <span class="type">vec2</span> cell = <span class="number">1.0</span> - <span class="number">2.0</span> * <span class="built_in">abs</span>(<span class="built_in">fract</span>(uv) - <span class="number">0.5</span>);</span><br><span class="line">    <span class="comment">// 网格纵向</span></span><br><span class="line">    color = <span class="built_in">mix</span>(color, <span class="type">vec3</span>(<span class="number">0.7</span>), <span class="built_in">step</span>(cell.x, <span class="number">4.0</span> * <span class="built_in">fwidth</span>(uv.x)));</span><br><span class="line">    <span class="comment">// 网格横向</span></span><br><span class="line">    color = <span class="built_in">mix</span>(color, <span class="type">vec3</span>(<span class="number">0.7</span>), <span class="built_in">smoothstep</span>(<span class="number">4.0</span> * <span class="built_in">fwidth</span>(uv.y), <span class="number">3.9</span> * <span class="built_in">fwidth</span>(uv.y), cell.y));</span><br><span class="line">    <span class="comment">// 纵向坐标轴</span></span><br><span class="line">    color = <span class="built_in">mix</span>(color, <span class="type">vec3</span>(<span class="number">0.3</span>, <span class="number">0.7</span>, <span class="number">0.8</span>), <span class="built_in">smoothstep</span>(<span class="number">2.0</span> * <span class="built_in">fwidth</span>(uv.x), <span class="number">1.9</span> * <span class="built_in">fwidth</span>(uv.x), <span class="built_in">abs</span>(uv.x)));</span><br><span class="line">    <span class="comment">// 横向坐标轴</span></span><br><span class="line">    color = <span class="built_in">mix</span>(color, <span class="type">vec3</span>(<span class="number">1.0</span>, <span class="number">0.5</span>, <span class="number">0.0</span>), <span class="built_in">smoothstep</span>(<span class="number">2.0</span> * <span class="built_in">fwidth</span>(uv.x), <span class="number">1.9</span> * <span class="built_in">fwidth</span>(uv.y), <span class="built_in">abs</span>(uv.y)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> func(<span class="keyword">in</span> <span class="type">float</span> x) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sin</span>(x + <span class="built_in">sin</span>(x + <span class="built_in">sin</span>(x) * <span class="number">0.8</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> distLine(<span class="type">vec2</span> p, <span class="type">vec2</span> a, <span class="type">vec2</span> b) &#123;</span><br><span class="line">    <span class="type">vec2</span> ab = b - a;</span><br><span class="line">    <span class="type">vec2</span> ap = p - a;</span><br><span class="line">    <span class="type">vec2</span> ad = <span class="built_in">clamp</span>(<span class="built_in">dot</span>(ab, ap) / <span class="built_in">dot</span>(ab, ab), <span class="number">0.0</span>, <span class="number">1.0</span>) * ab;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">length</span>(ap - ad);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> Line(<span class="type">vec2</span> p, <span class="type">vec2</span> a, <span class="type">vec2</span> b) &#123;</span><br><span class="line">    <span class="type">float</span> d = distLine(p, a, b);</span><br><span class="line">    <span class="type">float</span> m = <span class="built_in">smoothstep</span>(<span class="number">0.02</span>, <span class="number">0.01</span>, d);</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> segment(<span class="type">vec2</span> p, <span class="type">vec2</span> a, <span class="type">vec2</span> b, <span class="type">float</span> w) &#123;</span><br><span class="line">    <span class="type">float</span> f = <span class="number">0.0</span>;</span><br><span class="line">    <span class="type">vec2</span> ab = b - a;</span><br><span class="line">    <span class="type">vec2</span> ap = p - a;</span><br><span class="line">    <span class="type">float</span> proj = <span class="built_in">clamp</span>(<span class="built_in">dot</span>(ab, ap) / <span class="built_in">dot</span>(ab, ab), <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    <span class="type">float</span> d = <span class="built_in">length</span>(ap - proj * ab);</span><br><span class="line">    f = <span class="built_in">smoothstep</span>(w, w * <span class="number">0.2</span>, d);</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> mainImage(<span class="keyword">out</span> <span class="type">vec4</span> fragColor, <span class="keyword">in</span> <span class="type">vec2</span> fragCoord) &#123;</span><br><span class="line">    <span class="type">vec2</span> uv = fixUV(fragCoord.xy);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改了绘制坐标的函数</span></span><br><span class="line">    <span class="type">vec3</span> Basecolor = grid(uv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 小坐标位置中心点弄到方块的中心</span></span><br><span class="line">    <span class="type">vec2</span> st = <span class="built_in">fract</span>(uv) - <span class="number">0.5</span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建3x3点阵</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">vec2</span> p[<span class="number">9</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">float</span> y = <span class="number">-1.0</span>; y &lt;= <span class="number">1.0</span>; y++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">float</span> x = <span class="number">-1.0</span>; x &lt;= <span class="number">1.0</span>; x++) &#123;</span><br><span class="line">            <span class="type">vec2</span> offs = <span class="type">vec2</span>(x, y);</span><br><span class="line">            p[i++] = offs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连线绘制 (使用蓝色)</span></span><br><span class="line">    <span class="type">float</span> m2 = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">        m2 += Line(st, p[i], p[<span class="number">4</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    Basecolor = <span class="built_in">mix</span>(Basecolor, <span class="type">vec3</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>), m2); <span class="comment">// 绘制连线</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绘制每个区域中间的点 (使用红色)</span></span><br><span class="line">    <span class="type">float</span> d = <span class="built_in">length</span>(st);</span><br><span class="line">    <span class="type">float</span> m1 = <span class="built_in">smoothstep</span>(<span class="number">0.1</span>, <span class="number">0.09</span>, d);</span><br><span class="line">    Basecolor = <span class="built_in">mix</span>(Basecolor, <span class="type">vec3</span>(<span class="number">1.0</span>), m1); <span class="comment">// 绘制点</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    fragColor = <span class="type">vec4</span>(Basecolor, <span class="number">1.0</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2025/09/13/6obpL7qJrvcfXka.png" alt="shadertoy4" style="width: 30%;"><h3 id="5-随机数生成办法"><a href="#5-随机数生成办法" class="headerlink" title="5. 随机数生成办法"></a>5. 随机数生成办法</h3><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">vec2</span> N22(<span class="type">vec2</span> p) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 任意的大数字 但还是有一些要求：</span></span><br><span class="line">    <span class="comment">// 你可以替换为其他大数（如 vec2(123.45, 678.90)）</span></span><br><span class="line">    <span class="comment">// 但需要避免：</span></span><br><span class="line">    <span class="comment">// 过于简单的数字（如 100.0, 200.0）</span></span><br><span class="line">    <span class="comment">// 互为倍数的数字（如 50.0, 100.0）</span></span><br><span class="line">    <span class="comment">// 与后续魔法数字（123.34等）有简单数学关系的数字</span></span><br><span class="line">    p += <span class="type">vec2</span>(<span class="number">434.67</span>, <span class="number">534.23</span>);  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将2D坐标扩展为3D向量 p.xyx（如输入(x,y)变为(x,y,x)）</span></span><br><span class="line">    <span class="comment">// 乘以精心选择的&quot;魔法数字&quot;向量（这些质数增加混乱度）</span></span><br><span class="line">    <span class="comment">// fract() 取小数部分，确保数值在[0,1)范围内</span></span><br><span class="line">    <span class="type">vec3</span> a = <span class="built_in">fract</span>(p.xyx * <span class="type">vec3</span>(<span class="number">123.34</span>, <span class="number">234.34</span>, <span class="number">345.65</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算向量点积并叠加到自身（dot(a,a)计算自相关）</span></span><br><span class="line">    <span class="comment">// 添加34.45偏移避免对称性</span></span><br><span class="line">    <span class="comment">// 这步大幅增加输出的随机性</span></span><br><span class="line">    a += <span class="built_in">dot</span>(a, a + <span class="number">34.45</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fract</span>(<span class="type">vec2</span>(a.x * a.y, a.y * a.z));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> fixUV(<span class="type">vec2</span> coord) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3.0</span> * (<span class="number">2.</span> * (coord.xy - <span class="number">0.5</span> * iResolution.xy) / <span class="built_in">min</span>(iResolution.x, iResolution.y));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> mainImage(<span class="keyword">out</span> <span class="type">vec4</span> fragColor, <span class="keyword">in</span> <span class="type">vec2</span> fragCoord) &#123;</span><br><span class="line">    <span class="type">vec2</span> uv = fixUV(fragCoord.xy);</span><br><span class="line"></span><br><span class="line">    <span class="type">vec2</span> n = N22(uv);</span><br><span class="line">    fragColor = <span class="type">vec4</span>(n, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2025/09/13/s9ievPKCbrxIj3n.png" alt="shadertoy5" style="width: 30%;"><h3 id="6-星星连线效果"><a href="#6-星星连线效果" class="headerlink" title="6. 星星连线效果"></a>6. 星星连线效果</h3><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define PI 3.1415926</span></span><br><span class="line"><span class="meta">#define STEP 1.0</span></span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> fixUV(<span class="type">vec2</span> coord) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">5.0</span> * (<span class="number">2.</span> * (coord.xy - <span class="number">0.5</span> * iResolution.xy) / <span class="built_in">min</span>(iResolution.x, iResolution.y));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> distLine(<span class="type">vec2</span> p, <span class="type">vec2</span> a, <span class="type">vec2</span> b) &#123;</span><br><span class="line">    <span class="type">vec2</span> ab = b - a;</span><br><span class="line">    <span class="type">vec2</span> ap = p - a;</span><br><span class="line">    <span class="type">vec2</span> ad = <span class="built_in">clamp</span>(<span class="built_in">dot</span>(ab, ap) / <span class="built_in">dot</span>(ab, ab), <span class="number">0.0</span>, <span class="number">1.0</span>) * ab;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">length</span>(ap - ad);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> Line(<span class="type">vec2</span> p, <span class="type">vec2</span> a, <span class="type">vec2</span> b) &#123;</span><br><span class="line">    <span class="type">float</span> d = distLine(p, a, b);  <span class="comment">// 计算点p到线段ab的距离</span></span><br><span class="line">    <span class="type">float</span> m = <span class="built_in">smoothstep</span>(<span class="number">0.02</span>, <span class="number">0.01</span>, d); <span class="comment">// 第一次渐变：生成线宽</span></span><br><span class="line">    <span class="type">float</span> d2 = <span class="built_in">length</span>(a - b);     <span class="comment">// 计算线段ab的长度</span></span><br><span class="line">    m *= <span class="built_in">smoothstep</span>(<span class="number">1.2</span>, <span class="number">1.1</span>, d2);<span class="comment">// 第二次渐变：控制线段显隐</span></span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> N22(<span class="type">vec2</span> p) &#123;</span><br><span class="line">    p += <span class="type">vec2</span>(<span class="number">434.67</span>, <span class="number">534.23</span>);</span><br><span class="line">    <span class="type">vec3</span> a = <span class="built_in">fract</span>(p.xyx * <span class="type">vec3</span>(<span class="number">123.34</span>, <span class="number">234.34</span>, <span class="number">345.65</span>));</span><br><span class="line">    a += <span class="built_in">dot</span>(a, a + <span class="number">34.45</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fract</span>(<span class="type">vec2</span>(a.x * a.y, a.y * a.z));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec3</span> N23_to_3(<span class="type">vec2</span> p) &#123;</span><br><span class="line">    <span class="comment">// First layer hash</span></span><br><span class="line">    <span class="type">vec3</span> a = <span class="built_in">fract</span>(p.xyx * <span class="type">vec3</span>(<span class="number">123.34</span>, <span class="number">234.34</span>, <span class="number">345.65</span>));</span><br><span class="line">    a += <span class="built_in">dot</span>(a, a.yxz + <span class="number">34.45</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Second layer hash (using rotated coordinates)</span></span><br><span class="line">    <span class="type">vec3</span> b = <span class="built_in">fract</span>(p.yxy * <span class="type">vec3</span>(<span class="number">456.78</span>, <span class="number">567.89</span>, <span class="number">678.91</span>)); </span><br><span class="line">    b += <span class="built_in">dot</span>(b, b.zxy + <span class="number">45.67</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Combine layers</span></span><br><span class="line">    <span class="type">vec3</span> r = <span class="built_in">fract</span>(<span class="type">vec3</span>(</span><br><span class="line">        a.x * b.y,</span><br><span class="line">        a.y * b.z,</span><br><span class="line">        a.z * b.x</span><br><span class="line">    ));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Final mixing</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fract</span>(r * <span class="number">0.5</span> + <span class="number">0.5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> GetPos(<span class="type">vec2</span> id, <span class="type">vec2</span> offs) &#123;</span><br><span class="line">    <span class="comment">// 根据格子的 id和offs 产生一个随机数，</span></span><br><span class="line">    <span class="comment">// 乘上iTime使其根据时间发生变化</span></span><br><span class="line">    <span class="type">vec2</span> n = N22(id + offs) * iTime * <span class="number">6.11</span>; <span class="comment">// 6.11是一个调节速度的数值</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sin</span>(n) * <span class="number">0.4</span> + offs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> mainImage(<span class="keyword">out</span> <span class="type">vec4</span> fragColor, <span class="keyword">in</span> <span class="type">vec2</span> fragCoord) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="type">vec2</span> uv = fixUV(fragCoord.xy);</span><br><span class="line">    <span class="comment">// 修改了绘制坐标的函数</span></span><br><span class="line">    <span class="type">vec3</span> Basecolor = <span class="type">vec3</span>(<span class="number">0.0</span>);</span><br><span class="line">    <span class="comment">// 小坐标位置中心点弄到方块的中心</span></span><br><span class="line">    <span class="type">vec2</span> st = <span class="built_in">fract</span>(uv) - <span class="number">0.5</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取到格子的中心轴点</span></span><br><span class="line">    <span class="type">vec2</span> id = <span class="built_in">floor</span>(uv);</span><br><span class="line">    <span class="type">vec3</span> idcolor = N23_to_3(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建3x3点阵</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">vec2</span> p[<span class="number">9</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">float</span> y = <span class="number">-1.0</span>; y &lt;= <span class="number">1.0</span>; y++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">float</span> x = <span class="number">-1.0</span>; x &lt;= <span class="number">1.0</span>; x++) &#123;</span><br><span class="line">            <span class="type">vec2</span> offs = <span class="type">vec2</span>(x, y);</span><br><span class="line">            p[i++] = GetPos(id, offs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连线绘制 (使用蓝色)</span></span><br><span class="line">    <span class="type">float</span> m2 = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">        m2 += Line(st, p[i], p[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 画星星 中间闪烁部分</span></span><br><span class="line">        <span class="type">float</span> d = <span class="built_in">length</span>(st - p[i]);</span><br><span class="line">        <span class="type">float</span> spark = <span class="number">1.0</span> / (d * d * <span class="number">200.0</span>) * (<span class="built_in">sin</span>(iTime * <span class="number">13.0</span> + p[i].x * <span class="number">17.0</span>) * <span class="number">0.4</span> + <span class="number">0.6</span>);</span><br><span class="line">        m2 += spark;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这一部分会断开 重新连接</span></span><br><span class="line">        m2 += Line(st, p[<span class="number">1</span>], p[<span class="number">3</span>]);</span><br><span class="line">        m2 += Line(st, p[<span class="number">1</span>], p[<span class="number">5</span>]);</span><br><span class="line">        m2 += Line(st, p[<span class="number">7</span>], p[<span class="number">3</span>]);</span><br><span class="line">        m2 += Line(st, p[<span class="number">7</span>], p[<span class="number">5</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Basecolor = <span class="built_in">mix</span>(Basecolor, idcolor, m2); <span class="comment">// 绘制连线</span></span><br><span class="line">    </span><br><span class="line">    fragColor = <span class="type">vec4</span>(Basecolor, <span class="number">1.0</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2025/09/13/VbQwM4mTfhA92B3.png" alt="shadertoy6" style="width: 30%;"><h3 id="7-星星推进（博主的版本）"><a href="#7-星星推进（博主的版本）" class="headerlink" title="7. 星星推进（博主的版本）"></a>7. 星星推进（博主的版本）</h3><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">vec2</span> N22(<span class="type">vec2</span> p) &#123;</span><br><span class="line">    p += <span class="type">vec2</span>(<span class="number">434.67</span>, <span class="number">534.23</span>);</span><br><span class="line">    <span class="type">vec3</span> a = <span class="built_in">fract</span>(p.xyx * <span class="type">vec3</span>(<span class="number">123.34</span>, <span class="number">234.34</span>, <span class="number">345.65</span>));</span><br><span class="line">    a += <span class="built_in">dot</span>(a, a + <span class="number">34.45</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fract</span>(<span class="type">vec2</span>(a.x * a.y, a.y * a.z));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> DistLine(<span class="type">vec2</span> p, <span class="type">vec2</span> a, <span class="type">vec2</span> b) &#123;</span><br><span class="line">    <span class="type">vec2</span> pa = p - a;</span><br><span class="line">    <span class="type">vec2</span> ba = b - a;</span><br><span class="line">    <span class="type">float</span> t = <span class="built_in">clamp</span>(<span class="built_in">dot</span>(pa, ba) / <span class="built_in">dot</span>(ba, ba), <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">length</span>(pa - ba * t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec2</span> GetPos(<span class="type">vec2</span> id, <span class="type">vec2</span> offs) &#123;</span><br><span class="line">    <span class="type">vec2</span> n = N22(id + offs) * iTime;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sin</span>(n) * <span class="number">0.4</span> + offs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> Line(<span class="type">vec2</span> p, <span class="type">vec2</span> a, <span class="type">vec2</span> b) &#123;</span><br><span class="line">    <span class="type">float</span> d = DistLine(p, a, b);</span><br><span class="line">    <span class="type">float</span> m = <span class="built_in">smoothstep</span>(<span class="number">0.02</span>, <span class="number">0.01</span>, d);</span><br><span class="line">    <span class="type">float</span> d2 = <span class="built_in">length</span>(a - b);</span><br><span class="line">    m *= <span class="built_in">smoothstep</span>(<span class="number">1.2</span>, <span class="number">0.8</span>, d2) + <span class="built_in">smoothstep</span>(<span class="number">0.05</span>, <span class="number">0.03</span>, <span class="built_in">abs</span>(d2 - <span class="number">0.75</span>));</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> Layer(<span class="type">vec2</span> uv) &#123;</span><br><span class="line">    <span class="type">vec2</span> st = <span class="built_in">fract</span>(uv) - <span class="number">0.5</span>;</span><br><span class="line">    <span class="type">vec2</span> id = <span class="built_in">floor</span>(uv);</span><br><span class="line">    <span class="type">float</span> m = <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">vec2</span> p[<span class="number">9</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">float</span> y = <span class="number">-1.0</span>; y &lt;= <span class="number">1.0</span>; y++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">float</span> x = <span class="number">-1.0</span>; x &lt;= <span class="number">1.0</span>; x++) &#123;</span><br><span class="line">            <span class="type">vec2</span> offs = <span class="type">vec2</span>(x, y);</span><br><span class="line">            p[i++] = GetPos(id, offs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">float</span> t = iTime;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">        m += Line(st, p[i], p[<span class="number">4</span>]);</span><br><span class="line">        <span class="comment">// vec2 j = (st - p[i]) * 20.0;</span></span><br><span class="line">        <span class="type">float</span> d = <span class="built_in">length</span>(st - p[i]);</span><br><span class="line">        <span class="type">float</span> spark = <span class="number">1.0</span> / (d * d * <span class="number">200.0</span>) * (<span class="built_in">sin</span>(t * <span class="number">13.0</span> + p[i].x * <span class="number">17.0</span>) * <span class="number">0.4</span> + <span class="number">0.6</span>);</span><br><span class="line">        m += spark;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m += Line(st, p[<span class="number">1</span>], p[<span class="number">3</span>]);</span><br><span class="line">    m += Line(st, p[<span class="number">1</span>], p[<span class="number">5</span>]);</span><br><span class="line">    m += Line(st, p[<span class="number">7</span>], p[<span class="number">3</span>]);</span><br><span class="line">    m += Line(st, p[<span class="number">7</span>], p[<span class="number">5</span>]);</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> mainImage(<span class="keyword">out</span> <span class="type">vec4</span> fragColor, <span class="keyword">in</span> <span class="type">vec2</span> fragCoord) &#123;</span><br><span class="line">    <span class="type">vec2</span> uv = (fragCoord.xy - <span class="number">.5</span> * iResolution.xy) / iResolution.y;</span><br><span class="line">    <span class="type">vec3</span> col = <span class="type">vec3</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="type">float</span> m = <span class="number">0.0</span>;</span><br><span class="line">    <span class="type">float</span> t = iTime * <span class="number">0.1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">float</span> i = <span class="number">0.0</span>; i &lt;= <span class="number">1.0</span>; i += <span class="number">1.</span> / <span class="number">4.</span>) &#123;</span><br><span class="line">        <span class="type">float</span> depth = <span class="built_in">fract</span>(i + t);</span><br><span class="line">        <span class="type">float</span> size = <span class="built_in">mix</span>(<span class="number">15.0</span>, <span class="number">0.5</span>, depth);</span><br><span class="line">        <span class="type">float</span> fade = <span class="built_in">smoothstep</span>(<span class="number">0.0</span>, <span class="number">0.2</span>, depth) * <span class="built_in">smoothstep</span>(<span class="number">0.9</span>, <span class="number">0.8</span>, depth);</span><br><span class="line">        m += Layer(uv * size + i * <span class="number">20.0</span>) * fade;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    t *= <span class="number">5.0</span>;</span><br><span class="line">    <span class="type">float</span> gradinet = uv.y;</span><br><span class="line">    <span class="type">vec3</span> baseCol = <span class="type">vec3</span>(<span class="number">0.323</span>, <span class="number">0.456</span>, <span class="number">0.567</span>);</span><br><span class="line">    col = m * baseCol * (<span class="built_in">sin</span>(t) * <span class="number">0.4</span> + <span class="number">0.8</span>);</span><br><span class="line">    col -= baseCol * gradinet;</span><br><span class="line">    fragColor = <span class="type">vec4</span>(col, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2025/09/13/IsbLwT7aziglYm4.png" alt="shadertoy7" style="width: 30%;"><h3 id="8-一个最简单的3D点"><a href="#8-一个最简单的3D点" class="headerlink" title="8.一个最简单的3D点"></a>8.一个最简单的3D点</h3><p>原本的3D流程应该是：“原画师绘制场景图（将3D场景画下来） -&gt; 建模师根据原画构建场景模型（产出3D模型）-&gt; 程序渲染（将3D模型导入到引擎中，或者其他3D渲染库），然后渲染成画面”。</p><img src="https://s2.loli.net/2025/09/13/bGh2JSUj4oK1WVI.png" alt="img" style="width: 30%;"><p>我们简要回顾一下：</p><ol><li>顶点变换的过程（顶点着色器）</li><li>图元装配（按哪种方式装配图元，装配为点，线还是三角形）</li><li>光栅化（将上述的图元从矢量图形转换为像素组成的图形）</li><li>着色（片段着色器）</li><li>测试（Alpha测试，深度测试，模板测试等）&amp; 混合</li></ol><p>通过上述方式渲染的3D模型的方式我们通常称为<strong>光栅化的方法</strong></p><p>而在我们的shadertoy中，我们是直接在片段着色器中进行编程，我们只有上述的第四与第五步的过程。其实相当于我们现在变成了原画师，我们需要在一张纸上做画，而且画的是3D场景。好在我们还有另一种构建3D场景的方式，就是<strong>光线追踪或光线步进</strong>。</p><img src="https://s2.loli.net/2025/09/13/1GixOetfmgXlwNq.jpg" alt="img" style="width: 30%;"><p><a href="https://juejin.cn/post/7362059823662432306">https://juejin.cn/post/7362059823662432306</a></p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 点p到直线ro到rd的距离</span></span><br><span class="line"><span class="type">float</span> DistLine(<span class="type">vec3</span> ro, <span class="type">vec3</span> rd, <span class="type">vec3</span> p) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">length</span>(<span class="built_in">cross</span>(p - ro, rd) / <span class="built_in">length</span>(rd));      <span class="comment">// 使用向量叉积公式计算点到直线的距离：(p-ro)与rd的叉积长度除以rd的长度</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> mainImage(<span class="keyword">out</span> <span class="type">vec4</span> fragColor, <span class="keyword">in</span> <span class="type">vec2</span> fragCoord) &#123;</span><br><span class="line">    <span class="type">vec2</span> uv = fragCoord.xy / iResolution.xy;<span class="comment">// 将像素坐标归一化到[0,1]范围</span></span><br><span class="line">    uv -= <span class="number">0.5</span>;<span class="comment">// 将坐标原点移到屏幕中心(范围变为[-0.5,0.5])</span></span><br><span class="line">    uv.x *= iResolution.x / iResolution.y;<span class="comment">// 修正宽高比，防止图像变形</span></span><br><span class="line"></span><br><span class="line">    <span class="type">vec3</span> ro = <span class="type">vec3</span>(<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">-1.</span>);<span class="comment">// 定义摄像机（观察点）位置(ray origin)在z=-1处</span></span><br><span class="line">    <span class="type">vec3</span> rd = <span class="type">vec3</span>(uv.x, uv.y, <span class="number">0.0</span>) - ro;<span class="comment">// 计算从摄像机到当前像素的射线方向(ray direction)</span></span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> t = iGlobalTime; <span class="comment">//定义一个变量，方便让球动起来</span></span><br><span class="line">    <span class="type">vec3</span> p = <span class="type">vec3</span>(<span class="built_in">sin</span>(t), <span class="number">0.</span>, <span class="number">3.0</span>); <span class="comment">// 定义球的位置</span></span><br><span class="line">    <span class="type">float</span> r = <span class="number">0.01</span>; <span class="comment">// 定义球的半径</span></span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> d = DistLine(ro, rd, p); <span class="comment">// 计算球心与观察射线之间的距离</span></span><br><span class="line">    d = <span class="built_in">smoothstep</span>(r + <span class="number">0.01</span>, r, d); <span class="comment">// 若距离小于半径，d 则等于1。</span></span><br><span class="line">    fragColor = <span class="type">vec4</span>(d, d, d, <span class="number">1.0</span>); <span class="comment">// 将球着色为白色</span></span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2025/09/13/6ZnjRWTHq9Go4lp.png" alt="shadertoy9" style="width: 30%;"><h3 id="100-一个海Shader（优化版本）"><a href="#100-一个海Shader（优化版本）" class="headerlink" title="100.一个海Shader（优化版本）"></a>100.一个海Shader（优化版本）</h3><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * &quot;Seascape&quot; by Alexander Alekseev aka TDM - 2014</span></span><br><span class="line"><span class="comment"> * License Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.</span></span><br><span class="line"><span class="comment"> * Contact: tdmaav@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="type">int</span> NUM_STEPS = <span class="number">32</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="type">float</span> PI = <span class="number">3.141592</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="type">float</span> EPSILON= <span class="number">1e-3</span>;</span><br><span class="line"><span class="meta">#define EPSILON_NRM (0.1 / iResolution.x)</span></span><br><span class="line"><span class="comment">//#define AA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// sea</span></span><br><span class="line"><span class="keyword">const</span> <span class="type">int</span> ITER_GEOMETRY = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="type">int</span> ITER_FRAGMENT = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="type">float</span> SEA_HEIGHT = <span class="number">0.6</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="type">float</span> SEA_CHOPPY = <span class="number">4.0</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="type">float</span> SEA_SPEED = <span class="number">0.8</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="type">float</span> SEA_FREQ = <span class="number">0.16</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="type">vec3</span> SEA_BASE = <span class="type">vec3</span>(<span class="number">0.0</span>,<span class="number">0.09</span>,<span class="number">0.18</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="type">vec3</span> SEA_WATER_COLOR = <span class="type">vec3</span>(<span class="number">0.8</span>,<span class="number">0.9</span>,<span class="number">0.6</span>)*<span class="number">0.6</span>;</span><br><span class="line"><span class="meta">#define SEA_TIME (1.0 + iTime * SEA_SPEED)</span></span><br><span class="line"><span class="keyword">const</span> <span class="type">mat2</span> octave_m = <span class="type">mat2</span>(<span class="number">1.6</span>,<span class="number">1.2</span>,<span class="number">-1.2</span>,<span class="number">1.6</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// math</span></span><br><span class="line"><span class="type">mat3</span> fromEuler(<span class="type">vec3</span> ang) &#123;</span><br><span class="line"><span class="type">vec2</span> a1 = <span class="type">vec2</span>(<span class="built_in">sin</span>(ang.x),<span class="built_in">cos</span>(ang.x));</span><br><span class="line">    <span class="type">vec2</span> a2 = <span class="type">vec2</span>(<span class="built_in">sin</span>(ang.y),<span class="built_in">cos</span>(ang.y));</span><br><span class="line">    <span class="type">vec2</span> a3 = <span class="type">vec2</span>(<span class="built_in">sin</span>(ang.z),<span class="built_in">cos</span>(ang.z));</span><br><span class="line">    <span class="type">mat3</span> m;</span><br><span class="line">    m[<span class="number">0</span>] = <span class="type">vec3</span>(a1.y*a3.y+a1.x*a2.x*a3.x,a1.y*a2.x*a3.x+a3.y*a1.x,-a2.y*a3.x);</span><br><span class="line">m[<span class="number">1</span>] = <span class="type">vec3</span>(-a2.y*a1.x,a1.y*a2.y,a2.x);</span><br><span class="line">m[<span class="number">2</span>] = <span class="type">vec3</span>(a3.y*a1.x*a2.x+a1.y*a3.x,a1.x*a3.x-a1.y*a3.y*a2.x,a2.y*a3.y);</span><br><span class="line"><span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">float</span> hash( <span class="type">vec2</span> p ) &#123;</span><br><span class="line"><span class="type">float</span> h = <span class="built_in">dot</span>(p,<span class="type">vec2</span>(<span class="number">127.1</span>,<span class="number">311.7</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fract</span>(<span class="built_in">sin</span>(h)*<span class="number">43758.5453123</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">float</span> noise( <span class="keyword">in</span> <span class="type">vec2</span> p ) &#123;</span><br><span class="line">    <span class="type">vec2</span> i = <span class="built_in">floor</span>( p );</span><br><span class="line">    <span class="type">vec2</span> f = <span class="built_in">fract</span>( p );</span><br><span class="line">    <span class="comment">// Add distance-based smoothing</span></span><br><span class="line">    <span class="type">float</span> dist = <span class="built_in">length</span>(p);</span><br><span class="line">    <span class="type">float</span> smoothFactor = <span class="built_in">smoothstep</span>(<span class="number">0.0</span>, <span class="number">5.0</span>, dist);</span><br><span class="line">    <span class="type">vec2</span> u = <span class="built_in">mix</span>(f, f*f*(<span class="number">3.0</span><span class="number">-2.0</span>*f), smoothFactor);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1.0</span>+<span class="number">2.0</span>*<span class="built_in">mix</span>( <span class="built_in">mix</span>( hash( i + <span class="type">vec2</span>(<span class="number">0.0</span>,<span class="number">0.0</span>) ), </span><br><span class="line">                     hash( i + <span class="type">vec2</span>(<span class="number">1.0</span>,<span class="number">0.0</span>) ), u.x),</span><br><span class="line">                <span class="built_in">mix</span>( hash( i + <span class="type">vec2</span>(<span class="number">0.0</span>,<span class="number">1.0</span>) ), </span><br><span class="line">                     hash( i + <span class="type">vec2</span>(<span class="number">1.0</span>,<span class="number">1.0</span>) ), u.x), u.y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lighting</span></span><br><span class="line"><span class="type">float</span> diffuse(<span class="type">vec3</span> n,<span class="type">vec3</span> l,<span class="type">float</span> p) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pow</span>(<span class="built_in">dot</span>(n,l) * <span class="number">0.4</span> + <span class="number">0.6</span>,p);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">float</span> specular(<span class="type">vec3</span> n,<span class="type">vec3</span> l,<span class="type">vec3</span> e,<span class="type">float</span> s) &#123;    </span><br><span class="line">    <span class="type">float</span> nrm = (s + <span class="number">8.0</span>) / (PI * <span class="number">8.0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="built_in">dot</span>(<span class="built_in">reflect</span>(e,n),l),<span class="number">0.0</span>),s) * nrm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sky</span></span><br><span class="line"><span class="type">vec3</span> getSkyColor(<span class="type">vec3</span> e) &#123;</span><br><span class="line">    e.y = (<span class="built_in">max</span>(e.y,<span class="number">0.0</span>)*<span class="number">0.8</span>+<span class="number">0.2</span>)*<span class="number">0.8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">vec3</span>(<span class="built_in">pow</span>(<span class="number">1.0</span>-e.y,<span class="number">2.0</span>), <span class="number">1.0</span>-e.y, <span class="number">0.6</span>+(<span class="number">1.0</span>-e.y)*<span class="number">0.4</span>) * <span class="number">1.1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sea</span></span><br><span class="line"><span class="type">float</span> sea_octave(<span class="type">vec2</span> uv, <span class="type">float</span> choppy) &#123;</span><br><span class="line">    uv += noise(uv);        </span><br><span class="line">    <span class="type">vec2</span> wv = <span class="number">1.0</span>-<span class="built_in">abs</span>(<span class="built_in">sin</span>(uv));</span><br><span class="line">    <span class="type">vec2</span> swv = <span class="built_in">abs</span>(<span class="built_in">cos</span>(uv));    </span><br><span class="line">    wv = <span class="built_in">mix</span>(wv,swv,wv);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pow</span>(<span class="number">1.0</span>-<span class="built_in">pow</span>(wv.x * wv.y,<span class="number">0.65</span>),choppy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> map(<span class="type">vec3</span> p) &#123;</span><br><span class="line">    <span class="type">float</span> freq = SEA_FREQ;</span><br><span class="line">    <span class="type">float</span> amp = SEA_HEIGHT;</span><br><span class="line">    <span class="type">float</span> choppy = SEA_CHOPPY;</span><br><span class="line">    <span class="type">vec2</span> uv = p.xz; uv.x *= <span class="number">0.75</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> d, h = <span class="number">0.0</span>;    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ITER_GEOMETRY; i++) &#123;        </span><br><span class="line">    d = sea_octave((uv+SEA_TIME)*freq,choppy);</span><br><span class="line">    d += sea_octave((uv-SEA_TIME)*freq,choppy);</span><br><span class="line">        h += d * amp;        </span><br><span class="line">    uv *= octave_m; freq *= <span class="number">1.9</span>; amp *= <span class="number">0.22</span>;</span><br><span class="line">        choppy = <span class="built_in">mix</span>(choppy,<span class="number">1.0</span>,<span class="number">0.2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p.y - h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> map_detailed(<span class="type">vec3</span> p) &#123;</span><br><span class="line">    <span class="type">float</span> freq = SEA_FREQ;</span><br><span class="line">    <span class="type">float</span> amp = SEA_HEIGHT;</span><br><span class="line">    <span class="type">float</span> choppy = SEA_CHOPPY;</span><br><span class="line">    <span class="type">vec2</span> uv = p.xz; uv.x *= <span class="number">0.75</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> d, h = <span class="number">0.0</span>;    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ITER_FRAGMENT; i++) &#123;        </span><br><span class="line">    d = sea_octave((uv+SEA_TIME)*freq,choppy);</span><br><span class="line">    d += sea_octave((uv-SEA_TIME)*freq,choppy);</span><br><span class="line">        h += d * amp;        </span><br><span class="line">    uv *= octave_m; freq *= <span class="number">1.9</span>; amp *= <span class="number">0.22</span>;</span><br><span class="line">        choppy = <span class="built_in">mix</span>(choppy,<span class="number">1.0</span>,<span class="number">0.2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p.y - h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec3</span> getSeaColor(<span class="type">vec3</span> p, <span class="type">vec3</span> n, <span class="type">vec3</span> l, <span class="type">vec3</span> eye, <span class="type">vec3</span> dist) &#123;  </span><br><span class="line">    <span class="type">float</span> fresnel = <span class="built_in">clamp</span>(<span class="number">1.0</span> - <span class="built_in">dot</span>(n, -eye), <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    fresnel = <span class="built_in">min</span>(fresnel * fresnel * fresnel, <span class="number">0.5</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">vec3</span> reflected = getSkyColor(<span class="built_in">reflect</span>(eye, n));    </span><br><span class="line">    <span class="type">vec3</span> refracted = SEA_BASE + diffuse(n, l, <span class="number">80.0</span>) * SEA_WATER_COLOR * <span class="number">0.12</span>; </span><br><span class="line">    </span><br><span class="line">    <span class="type">vec3</span> color = <span class="built_in">mix</span>(refracted, reflected, fresnel);</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> atten = <span class="built_in">max</span>(<span class="number">1.0</span> - <span class="built_in">dot</span>(dist, dist) * <span class="number">0.001</span>, <span class="number">0.0</span>);</span><br><span class="line">    color += SEA_WATER_COLOR * (p.y - SEA_HEIGHT) * <span class="number">0.18</span> * atten;</span><br><span class="line">    </span><br><span class="line">    color += specular(n, l, eye, <span class="number">60.0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tracing</span></span><br><span class="line"><span class="type">vec3</span> getNormal(<span class="type">vec3</span> p, <span class="type">float</span> eps) &#123;</span><br><span class="line">        <span class="comment">// Distance-based eps adjustment</span></span><br><span class="line">    <span class="type">float</span> dist = <span class="built_in">length</span>(p);</span><br><span class="line">    eps = <span class="built_in">mix</span>(eps*<span class="number">0.5</span>, eps*<span class="number">2.0</span>, <span class="built_in">smoothstep</span>(<span class="number">0.0</span>, <span class="number">10.0</span>, dist));</span><br><span class="line">    </span><br><span class="line">    <span class="type">vec3</span> n;</span><br><span class="line">    n.y = map_detailed(p);    </span><br><span class="line">    n.x = map_detailed(<span class="type">vec3</span>(p.x+eps,p.y,p.z)) - n.y;</span><br><span class="line">    n.z = map_detailed(<span class="type">vec3</span>(p.x,p.y,p.z+eps)) - n.y;</span><br><span class="line">    n.y = eps;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Smooth normal</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">normalize</span>(<span class="built_in">mix</span>(n, <span class="type">vec3</span>(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>), <span class="number">0.1</span> * <span class="built_in">smoothstep</span>(<span class="number">0.0</span>, <span class="number">5.0</span>, dist)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> heightMapTracing(<span class="type">vec3</span> ori, <span class="type">vec3</span> dir, <span class="keyword">out</span> <span class="type">vec3</span> p) &#123;  </span><br><span class="line">    <span class="type">float</span> tm = <span class="number">0.0</span>;</span><br><span class="line">    <span class="type">float</span> tx = <span class="number">1000.0</span>;    </span><br><span class="line">    <span class="type">float</span> hx = map(ori + dir * tx);</span><br><span class="line">    <span class="keyword">if</span>(hx &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">        p = ori + dir * tx;</span><br><span class="line">        <span class="keyword">return</span> tx;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">float</span> hm = map(ori);    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; NUM_STEPS; i++) &#123;</span><br><span class="line">        <span class="type">float</span> tmid = <span class="built_in">mix</span>(tm, tx, hm / (hm - hx));</span><br><span class="line">        p = ori + dir * tmid;</span><br><span class="line">        <span class="type">float</span> hmid = map(p);        </span><br><span class="line">        <span class="keyword">if</span>(hmid &lt; <span class="number">0.0</span>) &#123;</span><br><span class="line">            tx = tmid;</span><br><span class="line">            hx = hmid;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tm = tmid;</span><br><span class="line">            hm = hmid;</span><br><span class="line">        &#125;        </span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">abs</span>(hmid) &lt; EPSILON) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">mix</span>(tm, tx, hm / (hm - hx));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">vec3</span> getPixel(<span class="keyword">in</span> <span class="type">vec2</span> coord, <span class="type">float</span> time) &#123;    </span><br><span class="line">    <span class="type">vec2</span> uv = coord / iResolution.xy;</span><br><span class="line">    uv = uv * <span class="number">2.0</span> - <span class="number">1.0</span>;</span><br><span class="line">    uv.x *= iResolution.x / iResolution.y;    </span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ray</span></span><br><span class="line">    <span class="type">vec3</span> ang = <span class="type">vec3</span>(<span class="built_in">sin</span>(time*<span class="number">3.0</span>)*<span class="number">0.1</span>,<span class="built_in">sin</span>(time)*<span class="number">0.2</span>+<span class="number">0.3</span>,time);    </span><br><span class="line">    <span class="type">vec3</span> ori = <span class="type">vec3</span>(<span class="number">0.0</span>,<span class="number">3.5</span>,time*<span class="number">5.0</span>);</span><br><span class="line">    <span class="type">vec3</span> dir = <span class="built_in">normalize</span>(<span class="type">vec3</span>(uv.xy,<span class="number">-2.0</span>)); dir.z += <span class="built_in">length</span>(uv) * <span class="number">0.14</span>;</span><br><span class="line">    dir = <span class="built_in">normalize</span>(dir) * fromEuler(ang);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// tracing</span></span><br><span class="line">    <span class="type">vec3</span> p;</span><br><span class="line">    heightMapTracing(ori,dir,p);</span><br><span class="line">    <span class="type">vec3</span> dist = p - ori;</span><br><span class="line">    <span class="type">vec3</span> n = getNormal(p, <span class="built_in">dot</span>(dist,dist) * EPSILON_NRM);</span><br><span class="line">    <span class="type">vec3</span> light = <span class="built_in">normalize</span>(<span class="type">vec3</span>(<span class="number">0.0</span>,<span class="number">1.0</span>,<span class="number">0.8</span>)); </span><br><span class="line">             </span><br><span class="line">    <span class="comment">// color</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">mix</span>(</span><br><span class="line">        getSkyColor(dir),</span><br><span class="line">        getSeaColor(p,n,light,dir,dist),</span><br><span class="line">    <span class="built_in">pow</span>(<span class="built_in">smoothstep</span>(<span class="number">0.0</span>,<span class="number">-0.02</span>,dir.y),<span class="number">0.2</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main</span></span><br><span class="line"><span class="type">void</span> mainImage( <span class="keyword">out</span> <span class="type">vec4</span> fragColor, <span class="keyword">in</span> <span class="type">vec2</span> fragCoord ) &#123;</span><br><span class="line">    <span class="type">float</span> time = iTime * <span class="number">0.3</span> + iMouse.x*<span class="number">0.01</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#ifdef AA</span></span><br><span class="line">    <span class="type">vec3</span> color = <span class="type">vec3</span>(<span class="number">0.0</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">-1</span>; i &lt;= <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">-1</span>; j &lt;= <span class="number">1</span>; j++) &#123;</span><br><span class="line">        <span class="type">vec2</span> uv = fragCoord+<span class="type">vec2</span>(i,j)/<span class="number">3.0</span>;</span><br><span class="line">    color += getPixel(uv, time);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    color /= <span class="number">9.0</span>;</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">    <span class="type">vec3</span> color = getPixel(fragCoord, time);</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// post</span></span><br><span class="line">fragColor = <span class="type">vec4</span>(<span class="built_in">pow</span>(color,<span class="type">vec3</span>(<span class="number">0.65</span>)), <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2025/09/13/vlTKo196wnDypC2.png" alt="shadertoy100" style="width: 30%;"><h1 id="ShaderToy"><a href="#ShaderToy" class="headerlink" title="ShaderToy"></a>ShaderToy</h1><h2 id="常用的全局变量"><a href="#常用的全局变量" class="headerlink" title="常用的全局变量"></a>常用的全局变量</h2><img src="https://s2.loli.net/2025/09/13/8dSoxBrp2OcWekl.png" alt="UnrealShader学习-2" style="width: 30%;"><h1 id="⚠️警告"><a href="#⚠️警告" class="headerlink" title="* ⚠️警告"></a>* ⚠️警告</h1><ol><li>尽可能不要在Shader中写 If 逻辑代码，因为不能<a href="https://juejin.cn/post/7069209226568007688">充分发挥SIMD的性能</a></li></ol><h1 id="其他专有名词解释"><a href="#其他专有名词解释" class="headerlink" title="* 其他专有名词解释"></a>* 其他专有名词解释</h1><ol><li><strong>齐次坐标</strong>：用 n + 1 维向量来表示 n 维向量。比如在 2D 中，点 (x, y) 用 (x, y, w) 表示，w 通常为 1，若 w &#x3D; 0 则表示无穷远点；在 3D 里，点 (x, y, z) 表示为 (x, y, z, w) 。它能简化图形学计算，还可表示无穷远点 。</li></ol>]]></content:encoded>
      
      
      
      <category domain="http://example.com/tags/Unreal-Engine/">Unreal Engine</category>
      
      <category domain="http://example.com/tags/Shader/">Shader</category>
      
      <category domain="http://example.com/tags/GLSL/">GLSL</category>
      
      <category domain="http://example.com/tags/HLSL/">HLSL</category>
      
      <category domain="http://example.com/tags/Graphics-Programming/">Graphics Programming</category>
      
      <category domain="http://example.com/tags/Computer-Graphics/">Computer Graphics</category>
      
      <category domain="http://example.com/tags/Game-Development-Shader-001/">Game Development Shader 001</category>
      
      
      <comments>http://example.com/2025/08/01/Notes/Shader%20Learning%20Note/#disqus_thread</comments>
      
    </item>
    
  </channel>
</rss>
